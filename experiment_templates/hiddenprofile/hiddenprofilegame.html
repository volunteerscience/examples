<table border="0" width="806" align="center">
    <tr>
        <td width="800">
		
			<table border="0" class="gametable" id="gameinstructions" align="center" width="800" height="600">
				<tr>
					<td width="800" colspan="5" height="8"></td>
				</tr>
				<tr>
					<td width="70"></td>
					<td width="485">
					<div class="progress">
						<div class="bar" style="width:100%;" id="insttimerbar"></div>
					</div>
					</td>
					<td width="1" valign="top">
						<p align="right"><font face="Verdana"><span style="font-size:14pt;"></span></font></p>
					</td>
					<td width="5" valign="top"></td>
					<td width="227" valign="top">
						<p align="left"><font face="Verdana"><span style="font-size:14pt;" id="insttimer"></span></font></p>
					</td>
				</tr>
				<tr>
					<td width="800" colspan="5">
						<p align="center"><font face="Verdana" color="#FF3333"><span style="font-size:18pt;">Instructions</span></font></p>
					</td>
				</tr>
				<tr>
					<td width="800" colspan="5">
						<table align="center" border="0" width="555" height="450">
							<tr>
								<td width="555" height="450" class="gametd">
								</td>
							</tr>
							<tr>
								<td width="555" height="46">
								<table align="center" width="555">
									<tr>			
										<td width="185" height="46">
										</td>
										<td width="185" height="46">
											<p align="center" id="readyp">
											<button id="begininsbut" type="submit" class="btn btn-primary" onClick="submit('Ready');$('#begininsbut').hide();$('#readyp').html('Please wait for others...');">
											<i class="icon-play-circle icon-white"></i> Begin
											</button>
											</p>
										</td>
										<td width="185" height="46">
										</td>
									</tr>
								</table>
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
		
            <div id="helpinfo" class="mybs-docs-example tooltip-demo">
                <ul>
					<li id="timetext" style="margin-bottom: 0;"></li>
                    <li id="comch" style="margin-bottom: 0;">Open a communication channel with your teammate by clicking on the teammate's name. You may chat with as many of your teammates as frequently as you wish, however you may only communicate with one teammate at a time. </li>
                    <li id="stepgoal" style="margin-bottom: 0;">Please read the provided information at this step.</li>
                </ul>
            </div>
		
			<table id="pbar" border="0" width="800" align="center">
				<tr id="pbarrow">
					<td width="440">
						<div class="progress">
						<div class="bar" style="width:100%;" id="timerbar"></div>
						</div>
					</td>
					<td width="118">
                        <p align="right" style="font-family:'Verdana';font-size:15pt;">Time Left:
                        </p>
                    </td>
                    <td width="54">
                        <p style="font-family:'Verdana';font-size:15pt;"><font color="red" id="timer"></font></p>
                    </td>
				</tr>
			</table>
		
			<div id="gamecontent">
				<div id="pubinfo">
				</div>

				<table id="step2" align="center" border="0" width="845">
					<tr>
						<td id="conditiontablespaceleft">
						</td>
						<td width="306" id="conditiontabletd">
							<table align="center" border="0" width="308" height="347" id="conditiontable">
							</table>
						</td>
						<td width="2">	
						</td>
						<td width="523">			
							<table align="center" border="0" width="488" class="myhero-unit" id="chattable">
								<tr>
									<td width="476" height="25">
										<p align="center"><span style="font-family:'Verdana';font-size:14pt;">Discussion</span></p>
									</td>
								</tr>
								<tr>
									<td width="476" height="62">
										<div class="control-group">  
											<div class="controls"> 
												<div id="chat_conversation" style="border: 1px solid black; background-color:white; text-align:left; width: 100%; height: 250px; overflow: auto; font-family:'Verdana'; font-size: 10pt;">
													<div>
														Welcome to public chat of the experiment!<br>
													</div>
												</div>
											</div>  
										</div> 
										<p>
											<i class="icon-pencil"></i>						
											<input onFocus="document.getElementById('chat_input').value='';" value="Type something here..." type="text" id="chat_input" style="width: 76%;" class="input-xlarge">
											<button type="submit" class="btn btn-primary" id="chat_send_button" onClick="sendMessage();">
											<i class="icon-comment icon-white"></i> Send
											</button>
										</p>	
									</td>
									<td width="0" height="62"></td>
								</tr>
							</table>
						</td>
						<td id="conditiontablespaceright">
						</td>
					</tr>
                    <tr>
                        <td colspan="6" width="835" height="20">

						</td>
                    </tr>
                    <tr>
                        <td colspan="6" width="835">
						<table border="0">
							<tr>
								<td width="490" id="pubcontainer"></td>
								<td width="10">&nbsp;</td>
								<td width="300" id="hpnotes">
									<table border="0" id="notetable">
										<tr>
											<td width="294" class="myfont">
											Notes:
											</td>
										</tr>
										<tr>
											<td width="294" height="200">
												<textarea id="notearea"></textarea>
											</td>
										</tr>
									</table>
								</td>
							</tr>
						</table>
						</td>
                    </tr>
				</table>
				
				<table id="step3" border="0" align="center" width="792">
					<tr>
						<td width="798" height="53" colspan="3">
							<p id="basedonthe">Based on the information you have gathered, identify: </p>
						</td>
					</tr>
				</table>
				
				<table id="endgamesurvey" border="0" width="799" align="center">
					<tr>
						<td width="107" height="23">&nbsp;</td>
						<td width="584" height="23">
							<div id="surveytitlediv"><h3 align="center" id="surveytitle"></h3></div>
						</td>
						<td width="94" height="23">&nbsp;</td>
					</tr>
					<tr id="surveyimagerow">
						<td width="107" height="24">&nbsp;</td>
						<td width="584" height="24">
							<div id="surveyimage"></div>
						</td>
						<td width="94" height="24">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="22">&nbsp;</td>
						<td width="584" height="22">&nbsp;</td>
						<td width="94" height="22">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="49">&nbsp;</td>
						<td width="584" height="49"><div id="surveytext"></div></td>
						<td width="94" height="49">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="22">&nbsp;</td>
						<td width="584" height="22"></td>
						<td width="94" height="22">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="200">&nbsp;</td>
						<td width="584" height="200">
							<div id="surveyoptions">
								<form id="rbFormSurv">
												
								</form>
								<table id="likertplayerstable" border="0" bordercolordark="black" bordercolorlight="black" width="582">
								</table>
								<p align="center">
									<button id="stbut" class="btn btn-large btn-block" onClick="displaySurveyQuestion(0); $('#stbut').hide();" type="button">Start Survey</button>
								</p>
							</div>
						</td>
						<td width="94" height="200">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="95">&nbsp;</td>
						<td width="584" height="95">&nbsp;</td>
						<td width="94" height="95">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="27">
						   <p align="center"><button id="prevsurveybut" type="submit" class="btn btn-primary" onClick="prevSurveyQuestion();">
							<i class="icon-arrow-left icon-white"></i> Previous
						</button></p>
						</td>
						<td width="584" height="27">&nbsp;</td>
						<td width="94" height="27">
							<p align="center"><button id="nextsurveybut" type="submit" class="btn btn-primary" onClick="nextSurveyQuestion();">
							<i class="icon-arrow-right icon-white"></i> Next
						</button></p>
						</td>
					</tr>
				</table>
				
			</div>
</table>

<script language="JavaScript" type="text/javascript">  

var privateOrder;
var InstructionsTimer 
var Step1Timer;
var Step2Timer;
var timeoutInst;
var timeoutStep1;
var timeoutStep2;
var EndGameTimer;
var NextRoundTimer;
var selectedUser=0;
var userMessage="";
var step3Options;
var clueType;
var infoCounts;
var endGameResultsCount=0;
var questions = new Array();
var title;
var introtext;
var intropic;
var strictness;
var currentQuestion=0;
var surveySelections=new Array();
var canvasWidth=300;
var canvasHeight=303;
var chatContent;
var condition;
var currentDiscRound;
var publicInfo;
var publicImage;
var readyCount;
var myanswer;

function initialize()
{
	this.readyCount=0;
	$("#helpinfo").hide();
	$("#pbar").hide();
	$("#pubinfo").hide();
	$("#step2").hide();
	$("#step3").hide();
	$('#endgamesurvey').hide();
	$('#notearea').html("");
	$('#pubinfo').html("<p id='ttl' align='center'></p><div id='desc' class='accordion'></div><div id='step1' class='accordion'></div>");
	document.getElementById("timetext").innerHTML="You have "+variables['Step1Timer']+" seconds before proceeding at next step.";
	this.InstructionsTimer=parseInt(variables['InstructionsTimer']+"")+1; 
	this.Step1Timer=parseInt(variables['Step1Timer']+"")+1; 
	this.Step2Timer=parseInt(variables['Step2Timer']+"")+1;
	this.EndGameTimer=parseInt(variables['end_game_timer']+"")+1;
	this.NextRoundTimer=parseInt(variables['round_interval_timer']+"")+1;
	parseScenarioXML();
	this.chatContent=$("#chat_conversation").html();
}

function arraySize(obj) {
    var size = 0, key;
    for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
    }
    return size;
};

function preprocess(str)
{
	while(str.indexOf('[')>=0&&str.indexOf(']',str.indexOf('[')+1)>=0)
	{
		if(str.indexOf('[')>=0&&str.indexOf(']',str.indexOf('[')+1)>=0)
			str=str.substring(0, str.indexOf('['))+this.step3Options[str.substring(str.indexOf('[')+1, str.indexOf(']'))][0]+str.substring(str.indexOf(']',str.indexOf('[')+1)+1, str.length);
	}
	return str;
}

function parseScenarioXML()
{
	this.step3Options = new Array();
	this.clueType = new Array(); // contains the number of options from each group
	this.infoCounts = new Array(); // contains the number of information from each group
	xmlDoc=loadXMLDoc(getFile("scenario"+variables['scenario_number']+".xml"));

	for(var j=0; j<xmlDoc.getElementsByTagName("option").length; j++)
	{
		if(this.clueType[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)]==null||
		this.clueType[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)]==undefined)
			this.clueType[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)]=1;
		else
			this.clueType[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)]++;
		var larray=new Array();
		larray.push($.trim(xmlDoc.getElementsByTagName("option")[j].childNodes[0].nodeValue));
		larray.push(0);
		this.step3Options[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)+","+$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("id").nodeValue)]=larray;
	}
	
	for(var j=0; j<xmlDoc.getElementsByTagName("clue").length; j++)
	{
		var arrkey;
		for (arrkey in this.clueType)
		{
			if($.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("visibility").nodeValue)=="private"
			&&$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("type").nodeValue)==arrkey)
			{
				if(this.infoCounts[arrkey]==null||infoCounts[arrkey]==undefined)
					this.infoCounts[arrkey]=1;
				else
					this.infoCounts[arrkey]++;
			}
		}
	}
	
	var title = $.trim(xmlDoc.getElementsByTagName("title")[0].childNodes[0].nodeValue);
	document.getElementById("ttl").innerHTML=title;
	this.publicInfo="";
	this.publicImage="";
	if($.trim(xmlDoc.getElementsByTagName("clue")[0].attributes.getNamedItem("visibility").nodeValue)=="shared")
		this.publicInfo=preprocess($.trim(xmlDoc.getElementsByTagName("clue")[0].childNodes[0].nodeValue));
	if(xmlDoc.getElementsByTagName("clue")[0].getElementsByTagName("picture")[0]!=null&&xmlDoc.getElementsByTagName("clue")[0].getElementsByTagName("picture")[0]!=undefined)
		this.publicImage=getFile($.trim(xmlDoc.getElementsByTagName("clue")[0].getElementsByTagName("picture")[0].childNodes[0].nodeValue));	
	
	//var size = arraySize(this.step3Options);
	
	//var size = 0, key;
   // for (key in this.clueType) {
   //     if (this.clueType.hasOwnProperty(key)) alert(key+","+this.clueType[key]);
	//}
	
	setRound(1);

	if(myid==1)
	{
		this.privateOrder="";
		if(variables['random_private_info']==1)
		{
			var numbers=new Array();
			for(var i=0; i<numPlayers; i++)
			{
				var arrkey;
				for (arrkey in this.clueType)
				{
					var randomnumber=-1;
					do{
						randomnumber=Math.floor(Math.random()*this.infoCounts[arrkey])+1;
					}while(numbers[arrkey+","+randomnumber]==true);
					numbers[arrkey+","+randomnumber]=true;
					this.privateOrder+=((arrkey+","+randomnumber)+"-");
				}
				this.privateOrder+="_";
			}
		}
		else
		{
			for(var i=1; i<=numPlayers; i++)
			{
				var arrkey;
				for (arrkey in this.clueType)
					this.privateOrder+=((arrkey+","+i)+"-");
				this.privateOrder+="_";
			}
		}
		if($.trim(variables["visualization_type"])=="1"||$.trim(variables["visualization_type"])=="2"||$.trim(variables["visualization_type"])=="3")
			this.privateOrder=parseInt(variables["visualization_type"])+" "+this.privateOrder;
		else
			this.privateOrder=(Math.floor(Math.random()*3)+1)+" "+this.privateOrder;
		submit(this.privateOrder);
	}
}

function setCondition()
{
	this.condition=parseInt(this.privateOrder.substring(0,1));
	if(this.condition==1)
	{
		if(parseInt(variables['chatting_with_everyone'])==1)
			$("#conditiontable").html("<tr><td width=\"190\" height=\"17\"><p class=\"myfont\">Participants List</p></td><td width=\"71\" height=\"17\"></td><td width=\"31\" height=\"17\"></td></tr><tr><td width=\"150\" rowspan=\"2\" height=\"280\" class=\"myhero-unit\" style=\"border-width:1;\"><div><div class=\"span3\" style=\"width:100%;\"><ul id=\"userlist\" class=\"mynav mynav-list\"\"><li id=\"0\" class=\"active\"><a onClick=\"setUser(0); removeActives(); $('#0').addClass('active');\"><i class=\"icon-user\"></i>Everyone</a></li></ul></div></div></td></tr>");
		else
			$("#conditiontable").html("<tr><td width=\"190\" height=\"17\"><p class=\"myfont\">Participants List</p></td><td width=\"71\" height=\"17\"></td><td width=\"31\" height=\"17\"></td></tr><tr><td width=\"150\" rowspan=\"2\" height=\"280\" class=\"myhero-unit\" style=\"border-width:1;\"><div><div class=\"span3\" style=\"width:100%;\"><ul id=\"userlist\" class=\"mynav mynav-list\"\"></ul></div></div></td></tr>");
		$("#conditiontable").css("background-color", "#F2F5A9");
		$("#conditiontable").css("width", 150);
		$("#conditiontabletd").css("width", 150);
		$("#conditiontablespaceleft").css("width", 78);
		$("#conditiontablespaceright").css("width", 78);
		for(var g=1; g<=numPlayers; g++)
		{
			if(g==myid)
				document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a><i class=\"icon-user\"></i>You ("+getName(myid)+")</a></li>");
			else
			{
				if(canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
					document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a onClick=\"setUser("+g+"); removeActives(); $('#"+g+"').addClass('active'); highlightCircle("+g+");\"><i class=\"icon-user\"></i>"+getName(g)+"</a></li>");
				else
					document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a><i class=\"icon-user\"></i>"+getName(g)+"</a></li>");
			}
		}
	}
	if(this.condition==2)
	{
		$("#conditiontable").html("<tr><td width=\"190\" height=\"17\"><p class=\"myfont\">Static Participant Network</p></td><td width=\"71\" height=\"17\"></td><td width=\"31\" height=\"17\"></td></tr><tr><td width=\"300\" height=\"95\" colspan=\"3\"><div id=\"myholder\" align=\"center\"></div></td></tr>");
		drawStaticNetwork();
	}
	if(this.condition==3)
	{
		$("#conditiontable").html("<tr><td width=\"190\" height=\"17\"><p class=\"myfont\">Dynamic Participant Network</p></td><td width=\"71\" height=\"17\"></td><td width=\"31\" height=\"17\"></td></tr><tr><td width=\"300\" height=\"95\" colspan=\"3\"><div id=\"myholder\" align=\"center\"></div></td></tr>");
		drawDynamicNetwork();
	}
}

function setPrivateInfo(myident)
{
	setCondition();
	this.privateOrder=this.privateOrder.substring(2);
	var tarr=this.privateOrder.split("_");
		
	var gameInfo="<pre id=\"descpre\"><ul><li>"+publicInfo+"</li>";
	if(this.publicImage!="")
		gameInfo+="<img src=\""+this.publicImage+"\" alt=\"private info picture\">";
	$(".gametd").html("<pre id=\"inspre\">"+preprocess($.trim(xmlDoc.getElementsByTagName("instructions")[0].childNodes[0].nodeValue))+"</pre>");
	for(var p=0;p<tarr.length;p++)
	{
		if(p+1==myident)
		{
			var tarr2=tarr[p].split("-");
			for(var m=0;m<tarr2.length;m++)
			{
				if(tarr2[m].length==0) continue;

				var pi1="";
				var img1="";
				
				for(var j=0; j<xmlDoc.getElementsByTagName("clue").length; j++)
				{
					if($.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("visibility").nodeValue)=="private"&&tarr2[m].split(",")[0]==$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("type").nodeValue))
					{
						//alert(tarr2[m].split(",")[0]+"=="+$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("type").nodeValue)+" sonuc: "+(tarr2[m].split(",")[0]==$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("type").nodeValue))+" ve "+tarr2[m].split(",")[1]+"=="+$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("id").nodeValue)+" sonuc: "+(tarr2[m].split(",")[1]==$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("id").nodeValue)))
						if(tarr2[m].split(",")[1]==$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("id").nodeValue))
						{
							pi1=preprocess($.trim(xmlDoc.getElementsByTagName("clue")[j].childNodes[0].nodeValue));
							if(xmlDoc.getElementsByTagName("clue")[j].getElementsByTagName("picture")[0]!=undefined&&xmlDoc.getElementsByTagName("clue")[j].getElementsByTagName("picture")[0].childNodes[0]!=null)
								img1=$.trim(xmlDoc.getElementsByTagName("clue")[j].getElementsByTagName("picture")[0].childNodes[0].nodeValue);
							break;
						}
					}
				}
				
				gameInfo+="<li>"+pi1+"</li>";
					
				if(img1!="" && img1!=null && img1 != undefined)
					gameInfo+="<img src=\""+img1+"\" alt=\"private info picture\">";
			}
		}
	}
	gameInfo+="</ul></pre>";
	$("#desc").html(gameInfo);
		
	countDownInstructions();
}

function countDownInstructions(){  
	 if (this.InstructionsTimer <=0){ 
		clearTimeout(this.timeoutInst);
		if($.trim($('#readyp').html())!='Please wait for others...')
			submit('Ready');
	 }else{  
		this.InstructionsTimer--;
		document.getElementById("insttimerbar").style.width=(this.InstructionsTimer*100/parseInt(variables['InstructionsTimer']+""))+"%";
		document.getElementById("insttimer").innerHTML = this.InstructionsTimer+" seconds remaining"; 
		this.timeoutInst=setTimeout("countDownInstructions()", 1000);
	 }  
} 

function loadXMLDoc(dname)
{
	if (window.XMLHttpRequest)
	{
		xhttp=new XMLHttpRequest();
	}
	else
	{
		xhttp=new ActiveXObject("Microsoft.XMLHTTP");
	}
	xhttp.open("GET",dname,false);
	xhttp.send();
	return xhttp.responseXML;
}

function parseSurveyXML()
{
	xmlDoc=loadXMLDoc(getFile("surveytemplate.xml"));
	title = $.trim(xmlDoc.getElementsByTagName("title")[0].childNodes[0].nodeValue);
	introtext = $.trim(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("text")[0].childNodes[0].nodeValue);
	if(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=null&&xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=undefined)
		intropic = getFile($.trim(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0].childNodes[0].nodeValue));
	for(var i = 0; i < xmlDoc.getElementsByTagName("question").length; i++)
	{
		var question = new Array();
		question.push($.trim(xmlDoc.getElementsByTagName("question")[i].attributes.getNamedItem("type").nodeValue)); // question type

		var text, picture, video;
		var choices = new Array();
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("text").length>0)
			text = $.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("text")[0].childNodes[0].nodeValue);
		else
			text = "";
		question.push(text);
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("picture").length>0)
			picture = getFile($.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("picture")[0].childNodes[0].nodeValue));
		else
			picture = "";
		question.push(picture);
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("video").length>0)
			video = getFile($.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("video")[0].childNodes[0].nodeValue));
		else
			video = "";
		question.push(video);
		
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("choice").length>0)
		{
			for(var j = 0; j < xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("choice").length; j++)
				choices.push($.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("choice")[j].childNodes[0].nodeValue));
		}
		question.push(choices);
		questions.push(question);
	}
	strictness = $.trim(xmlDoc.getElementsByTagName("survey")[0].attributes.getNamedItem("strict").nodeValue);
	if(strictness==null)
		strictness = "false";
}

function nextSurveyQuestion()
{
	if(questions[currentQuestion][4].length>0&&questions[currentQuestion][0]=="likert-custom"||questions[currentQuestion][0]=="likert"||questions[currentQuestion][0]=="players-all"||questions[currentQuestion][0]=="players-selfexclude")
	{
		if(strictness=="true")
		{
			if($("input:radio[name='survrad']:checked").val()==undefined)
			{
				alert("Please select an option before proceeding!");
				return;
			}
		}
		surveySelections[currentQuestion]=$("input:radio[name='survrad']:checked").val();
	}
	else if(questions[currentQuestion][0]=="likert-players-selfexclude")
	{
		var chstr="";
		if(strictness=="true")
		{
			for(var k=1; k<=numPlayers; k++)
			{
				if(k!=myid)
				{
					if($("input:radio[name='likertrad"+k+"']:checked").val()==undefined)
					{
						alert("Please select an option for "+getName(k)+" before proceeding!");
						return;
					}
					else
						chstr+=(", "+$("input:radio[name='likertrad"+k+"']:checked").val());
				}
			}
		}
		surveySelections[currentQuestion]=chstr;
	}
	else if(questions[currentQuestion][4].length>0&&questions[currentQuestion][0]=="multiple")
	{
		if(strictness=="true")
		{
			if($("input:checkbox[name='survchck']:checked").val()==undefined)
			{
				alert("Please select an option before proceeding!");
				return;
			}
		}
		var allVals = [];
		$(':checkbox:checked').each(function() {
			allVals.push($(this).val());
		});
		var mytempstr="";
		for(var z=0; z<allVals.length; z++)
			mytempstr+=(allVals[z]+" ");
		surveySelections[currentQuestion]=mytempstr;
	}
	
	currentQuestion++;
	if(currentQuestion<questions.length)
		displaySurveyQuestion(currentQuestion);
	else
	{
		$("#prevsurveybut").hide();
		$("#nextsurveybut").hide();
		for(var z=0; z<surveySelections.length; z++)
		{
			if(surveySelections[z]!=null&&surveySelections[z]!=undefined)
			{
				submit(surveySelections[z]);
				setRound(4+parseInt(variables['total_rounds'])+z);
			}
		}
		$("#surveytitle").html('');
		$("#surveyimage").html('');
		$("#surveytext").html('');
		document.getElementById("rbFormSurv").innerHTML="";
		$("#likertplayerstable").html("");
		$("#surveytext").html("Thank you for completing the survey. Click <a href=\"/stop_test/\" onclick='stopPinging();'>HERE</a> to quit the experiment...");
	}
}

function prevSurveyQuestion()
{
	if(questions[currentQuestion][0]=="likert-custom"||questions[currentQuestion][0]=="likert"||questions[currentQuestion][0]=="players-all"||questions[currentQuestion][0]=="players-selfexclude")
		surveySelections[currentQuestion]=$("input:radio[name='survrad']:checked").val();
	if(questions[currentQuestion][0]=="multiple")
		surveySelections[currentQuestion]=$("input:checkbox[name='survchck']:checked").val();
	currentQuestion--;
	displaySurveyQuestion(currentQuestion);
}

function startSurvey()
{
	parseSurveyXML();
	$('#endgamesurvey').show();
	$("#prevsurveybut").hide();
	$("#nextsurveybut").hide();
	$("#rbFormSurv").hide();
	$("#surveytitle").html(title);
	if(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=null&&xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=undefined)
		$("#surveyimage").html("<img src=\""+intropic+"\" alt=\"intro picture\">");
	if(intropic=undefined||intropic==null||intropic=="")
		$('#surveyimagerow').hide();
	$("#surveytext").html(introtext);
}

function displaySurveyQuestion(qNum)
{
	$("#surveytitle").html('');
	$("#surveyimage").html('');
	$("#surveytext").html('');
	document.getElementById("rbFormSurv").innerHTML="";
	
	$("#surveytext").html(questions[qNum][1]);
	if(questions[qNum][2]!="")
		$("#surveyimage").html("<img src=\""+questions[qNum][2]+"\" alt=\"question picture\">");
	if(questions[qNum][3]!="")
		$("#surveyimage").html("<video width=\"320\" height=\"240\" controls><source src=\""+questions[qNum][3]+".mp4\" type=\"video/mp4\"><source src=\""+questions[qNum][3]+".ogg\" type=\"video/ogg\">Your browser does not support the video tag.</video>");	

	if(questions[qNum][0]=="likert")
	{
		$("#rbFormSurv").show();
		$("#likertplayerstable").hide();
		document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\"Disagree strongly\">Disagree strongly<br><input type=\"radio\" name=\"survrad\" value=\"Disagree moderately\">Disagree moderately<br><input type=\"radio\" name=\"survrad\" value=\"Disagree a little\">Disagree a little<br><input type=\"radio\" name=\"survrad\" value=\"Neither agree nor disagree\">Neither agree nor disagree<br><input type=\"radio\" name=\"survrad\" value=\"Agree a little\">Agree a little<br><input type=\"radio\" name=\"survrad\" value=\"Agree moderately\">Agree moderately<br><input type=\"radio\" name=\"survrad\" value=\"Agree strongly\">Agree strongly<br>");
	}
	if(questions[qNum][0]=="likert-custom")
	{
		$("#rbFormSurv").show();
		$("#likertplayerstable").hide();
		for(var k=0; k<questions[qNum][4].length; k++)
			document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\""+questions[qNum][4][k]+"\">"+questions[qNum][4][k]+"<br>");
	}
	if(questions[qNum][0]=="multiple")
	{
		$("#rbFormSurv").show();
		$("#likertplayerstable").hide();
		for(var k=0; k<questions[qNum][4].length; k++)
			document.getElementById("rbFormSurv").innerHTML+=("<input type=\"checkbox\" name=\"survchck\" value=\""+questions[qNum][4][k]+"\">"+questions[qNum][4][k]+"<br>");
	}
	if(questions[qNum][0]=="players-selfexclude")
	{
		$("#rbFormSurv").show();
		$("#likertplayerstable").hide();
		for(var k=1; k<=numPlayers; k++)
		{
			if(k!=myid)
				document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\""+getName(k)+"\">"+getName(k)+"<br>");
		}
	}
	if(questions[qNum][0]=="players-all")
	{
		$("#rbFormSurv").show();
		$("#likertplayerstable").hide();
		for(var k=1; k<=numPlayers; k++)
		{
			document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\""+getName(k)+"\">"+getName(k)+"<br>");
		}
	}
	if(questions[qNum][0]=="likert-players-selfexclude")
	{
		$("#rbFormSurv").hide();
		$("#likertplayerstable").show();
		$("#likertplayerstable").html("<tr><td width=\"97\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><b><font color=\"white\"><span style=\"font-size:10pt;\">Teammate</span></font></b></p></td><td width=\"97\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><i><font color=\"white\"><span style=\"font-size:10pt;\">Not at all</span></font></i></p></td><td width=\"97\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><span style=\"font-size:10pt;\"><i>&nbsp;</i></span></p></td><td width=\"97\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><i><font color=\"white\"><span style=\"font-size:10pt;\">To Some Extent</span></font></i></p></td><td width=\"97\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><span style=\"font-size:10pt;\"><i>&nbsp;</i></span></p></td><td width=\"104\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><i><font color=\"white\"><span style=\"font-size:10pt;\">A Great Deal</span></font></i></p></td></tr>");
		for(var k=1; k<=numPlayers; k++)
		{
			if(k!=myid)
				$("#likertplayerstable").html($("#likertplayerstable").html()+"<tr><form id=\"likertplayerform"+k+"\"><td width=\"97\"><p align=\"center\" id=\"likertusername\">"+getName(k)+"</p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\""+getName(k)+"-1\"><br></p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\""+getName(k)+"-2\"><br></p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\""+getName(k)+"-3\"><br></p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\""+getName(k)+"-4\"><br></p></td><td width=\"104\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\""+getName(k)+"-5\"><br></p></td></form></tr>");
		}
		$("#likertplayerstable").html($("#likertplayerstable").html()+"</table>");
	}
	
	if(qNum>0)
		$("#prevsurveybut").show();
	else
		$("#prevsurveybut").hide();
		
	if(qNum<questions.length)
		$("#nextsurveybut").show();
	else
		$("#nextsurveybut").hide();
}

function newMove(participant, index) {
  fetchMove(participant, currentRound, index, function(val) {
	if(currentRound==2&&this.readyCount<numPlayers)
	{
		if(val=='Ready')
			this.readyCount++
		if(this.readyCount==numPlayers)
		{
			countDownStep1();
			$("#helpinfo").show();
			$("#comch").hide();
			$("#pbar").show();
			$("#pubinfo").show();
			$("#gameinstructions").hide();
			setRound(3);
		}
		return;
	}
	if(currentRound>=3&&this.currentDiscRound<=parseInt(variables['total_rounds']))
	{
		val=val.substring(0, val.indexOf('|'));
		var tarr=val.split("_");
		for(var p=0;p<tarr.length;p++)
		{
			if(tarr[p].length==0)continue;
			if(parseInt(variables['feedback_type'])==1)
				this.step3Options[tarr[p]][1]++;
			if(parseInt(variables['feedback_type'])==2&&participant==myid)
				this.step3Options[tarr[p]][1]++;
		}
		endGameResultsCount++;
		if(endGameResultsCount==numPlayers)
		{
			//$("#endgameresults").show();
			endGameResultsCount=0;
			if(parseInt(variables["allow_feedback"])==1)
			{
				if(parseInt(variables['feedback_type'])==1)
				{
					var arrkey;
					for (arrkey in this.clueType)
					{
						var labels = new Array();
						var values = new Array();
						var correctCount=0;
						var wrongCount=0;
						
						for(var y=1; y<=this.clueType[arrkey]; y++)
						{
							if(step3Options[arrkey+","+y][1]>0)
							{
								for(var j=0; j<xmlDoc.getElementsByTagName("option").length; j++)
								{
									if($.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)==arrkey&&y==$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("id").nodeValue))
									{
										if($.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("answer").nodeValue)=="true")
											correctCount+=step3Options[arrkey+","+y][1];
										else
											wrongCount+=step3Options[arrkey+","+y][1];
									}
								}
							}
						}
						
						labels.push("%%.%% - Correct");
						values.push(correctCount);
						labels.push("%%.%% - Wrong");
						values.push(wrongCount);
						
						if(values[0]==0)
						{
							values.splice(0, 1);
							labels.splice(0, 1);
						}
						if(values[1]==0)
						{
							values.splice(1, 1);
							labels.splice(1, 1);
						}

						$("#chart_div"+arrkey).css({'width':'150px;'});
						$("#chart_div"+arrkey).css({'height':'250px;'});
						$("#feed0").html("Feedback on the team's performance appears below.");
						var r = Raphael("chart_div"+arrkey),
						pie = r.piechart(190, 75, 50, values, { legend: labels, legendpos: "west"});
						r.text(90, 20, "Accuracy results for "+arrkey).attr({ font: "10px sans-serif" });
						pie.hover(function () {
							this.sector.stop();
							this.sector.scale(1.1, 1.1, this.cx, this.cy);

							if (this.label) {
								this.label[0].stop();
								this.label[0].attr({ r: 7.5 });
								this.label[1].attr({ "font-weight": 800 });
							}
						}, function () {
							this.sector.animate({ transform: 's1 1 ' + this.cx + ' ' + this.cy }, 500, "bounce");

							if (this.label) {
								this.label[0].animate({ r: 5 }, 500, "bounce");
								this.label[1].attr({ "font-weight": 400 });
							}
						});
					}
				}
				if(parseInt(variables['feedback_type'])==2)
				{
					var correctCount=0;
					var wrongCount=0;
					var arrkey;
					for (arrkey in this.clueType)
					{
						for(var y=1; y<=this.clueType[arrkey]; y++)
						{
							if(step3Options[arrkey+","+y][1]>0)
							{
								for(var j=0; j<xmlDoc.getElementsByTagName("option").length; j++)
								{
									if($.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)==arrkey&&y==$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("id").nodeValue))
									{
										if($.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("answer").nodeValue)=="true")
											correctCount+=step3Options[arrkey+","+y][1];
										else
											wrongCount+=step3Options[arrkey+","+y][1];
									}
								}
							}
						}
					}	
					var labels = new Array();
					var values = new Array();
					labels.push("%%.%% - Correct");
					values.push(correctCount);
					labels.push("%%.%% - Wrong");
					values.push(wrongCount);
					
					if(values[0]==0)
					{
						values.splice(0, 1);
						labels.splice(0, 1);
					}
					if(values[1]==0)
					{
						values.splice(1, 1);
						labels.splice(1, 1);
					}

					$("#chart_divindividual").css({'width':'150px;'});
					$("#chart_divindividual").css({'height':'250px;'});
					$("#feedindividual").html("Feedback on your performance appears below.");
					var r = Raphael("chart_divindividual"),
					pie = r.piechart(190, 75, 50, values, { legend: labels, legendpos: "west"});
					r.text(90, 20, "Accuracy results of your choices").attr({ font: "10px sans-serif" });
					pie.hover(function () {
						this.sector.stop();
						this.sector.scale(1.1, 1.1, this.cx, this.cy);

						if (this.label) {
							this.label[0].stop();
							this.label[0].attr({ r: 7.5 });
							this.label[1].attr({ "font-weight": 800 });
						}
					}, function () {
						this.sector.animate({ transform: 's1 1 ' + this.cx + ' ' + this.cy }, 500, "bounce");

						if (this.label) {
							this.label[0].animate({ r: 5 }, 500, "bounce");
							this.label[1].attr({ "font-weight": 400 });
						}
					});
				}
			}
			if(this.currentDiscRound<parseInt(variables['total_rounds']))
			{
				document.getElementById("submitStatus").innerHTML="<font color=\"blue\">Next round is about to begin...</font>";
				countDownNextRound();
			}
			else
			{
				document.getElementById("submitStatus").innerHTML="<font color=\"blue\">You will now be redirected to end game survey...</font>";
				countDownEndGame();
			}
			$("#pbar").show();
			setRound(3+this.currentDiscRound);
			this.currentDiscRound++;
		}
	}
	if(currentRound==1)
	{
		this.privateOrder=val;
		setPrivateInfo(myid);
		setRound(2);
	}
  });
}

function loadStep2()
{
	if(this.currentDiscRound==null||this.currentDiscRound==undefined)
		this.currentDiscRound=1;
	$("#step1").hide();  
	$("#step3").hide();
	$("#step2").show();
	$("#pubcontainer").html($("#desc").html());
	$("#pubcontainer").css({'width': '490px'});
	$("#desc").hide();
	$("#stepgoal").hide();
	$("#helpinfo").show();
	$("#comch").show();
	if(Math.round(parseInt(variables['Step2Timer'])/60) == 1)
		document.getElementById("timetext").innerHTML="You have "+Math.round((parseInt(variables['Step2Timer'])/60))+" minute and "+((parseInt(variables['Step2Timer'])%60))+" seconds to chat with your teammates. Your goal is to identify correct ";
	else if(Math.round(parseInt(variables['Step2Timer'])/60) >= 2)
		document.getElementById("timetext").innerHTML="You have "+Math.round((parseInt(variables['Step2Timer'])/60))+" minutes and "+((parseInt(variables['Step2Timer'])%60))+" seconds to chat with your teammates. Your goal is to identify correct ";
	else
		document.getElementById("timetext").innerHTML="You have "+parseInt(variables['Step2Timer'])+" seconds to chat with your teammates. Your goal is to identify correct ";
	var arrkey;
	var size=0;
	for (arrkey in this.clueType)
		size++;
	var currentcount=0;
	for (arrkey in this.clueType)
	{
		if(currentcount==0)
			$("#timetext").html($("#timetext").html()+" "+arrkey)
		else if(currentcount==size-1)
			$("#timetext").html($("#timetext").html()+" and "+arrkey)
		else
			$("#timetext").html($("#timetext").html()+", "+arrkey)
		currentcount++;
	}
	$("#pbarrow").html("<td width=\"77\"><p align=\"right\" style=\"font-family:'Verdana';font-size:15pt;\">Round:</p></td><td width=\"89\"><p style=\"font-family:'Verdana';font-size:15pt;\"><font color=\"red\" id=\"roundtext\">"+this.currentDiscRound+" of "+variables['total_rounds']+"</font></p></td><td width=\"440\"><div class=\"progress\"><div class=\"bar\" style=\"width:100%;\" id=\"timerbar\"></div></div></td><td width=\"118\"><p align=\"right\" style=\"font-family:'Verdana';font-size:15pt;\">Time Left:</p></td><td width=\"54\"><p style=\"font-family:'Verdana';font-size:15pt;\"><font color=\"red\" id=\"timer\"></font></p></td>");
	countDownStep2();
}

function loadStep3()
{
	$("#step1").hide();
	$("#step2").hide();  
	$("#pbar").hide();
	$("#step3").show();
	this.myanswer="";
	$("#pubinfo").css({ 'width': '800px'});
	$("#pubinfo").show();
	$("#desc").show();
	$("#endgameresults").hide();
	setEnableRadioGroups(false);
	document.getElementById("stepgoal").innerHTML="Please make your final decision at this step.";
	document.getElementById("timetext").innerHTML="";
	$("#helpinfo").hide();
	$("#step3").html($("#step3").html()+"<tr><td colspan=\"4\"><table id=\"howconftable\" border=\"0\" width=\"456\" style=\"margin-left: auto; margin-right: auto;\"><tr><td width=\"450\"><p>How confident are you that the answers you selected are correct?</p></td></tr><tr><td width=\"450\"><input type=\"radio\" name=\"howconf\" value=\"Very Confident\">Very Confident<br><input type=\"radio\" name=\"howconf\" value=\"Somewhat Confident\">Somewhat Confident<br><input type=\"radio\" name=\"howconf\" value=\"Neither Confident nor Unsure\">Neither Confident nor Unsure<br><input type=\"radio\" name=\"howconf\" value=\"Somewhat Unsure\">Somewhat Unsure<br><input type=\"radio\" name=\"howconf\" value=\"Very Unsure\">Very Unsure<br></td></tr><tr><td width=\"450\"><p align=\"center\"><button id='subconfbut' type=\"submit\" class=\"btn btn-primary\" onClick=\"submitDecision();\"><i class=\"icon-ok icon-white\"></i> Submit</button></p></td></tr></table></td></tr>");
	var arrkey;
	var currcount=0;
	for (arrkey in this.clueType)
	{
		if(parseInt(variables["allow_feedback"])==1)
		{
			$("#step3").html($("#step3").html()+"<tr id=\""+arrkey+"_row1\"><td width=\"280\" height=\"30\" class=\"myfont\" id=\"dectext"+arrkey+"\"></td><td width=\"191\"></td><td width=\"311\" id=\"feed"+currcount+"\"></td><td width=\"2\"></td></tr><tr height=\"150\" id=\""+arrkey+"_row2\"><td width=\"280\"></td><td width=\"191\"><form id=\"rbForm"+arrkey+"\"></form></td><td width=\"311\"><div id='chart_div"+arrkey+"' style='height:150px; width:250px; margin-left: auto; margin-right: auto;'></div></td><td width=\"2\"></td></tr>");
			currcount++;
		}
		else
			$("#step3").html($("#step3").html()+"<tr id=\""+arrkey+"_row1\"><td width=\"291\" height=\"30\" class=\"myfont\" id=\"dectext"+arrkey+"\"></td><td width=\"221\"></td><td width=\"250\"></td><td width=\"22\"></td></tr><tr height=\"150\" id=\""+arrkey+"_row2\"><td width=\"291\"></td><td width=\"221\"><form id=\"rbForm"+arrkey+"\"></form></td><td width=\"250\"></td><td width=\"22\"></td></tr><tr><td width=\"291\" height=\"5\"></td><td width=\"221\" height=\"5\"></td><td width=\"250\"></td><td width=\"22\"></td></tr>");
	}
	$("#step3").html($("#step3").html()+"<tr><td width=\"291\" height=\"41\"></td><td width=\"221\" height=\"41\"><p align=\"center\"><button id='subdecbut' type=\"submit\" class=\"btn btn-primary\" onClick=\"showConfidence();\"><i class=\"icon-ok icon-white\"></i> Submit</button></p></td><td width=\"272\" height=\"41\"></td></tr><tr><td width=\"809\" colspan=\"4\"><p id=\"submitStatus\" align=\"center\">&nbsp;</p></td></tr>");
	$("#subdecbut").show();
	if(parseInt(variables["feedback_type"])==2)
	{
		$("#step3").html($("#step3").html()+"<tr><td colspan=\"4\"><table style='height:150px; width:350px; margin-left: auto; margin-right: auto;'><tr><td width=\"350\" id=\"feedindividual\"></td></tr><tr height=\"150\"><td width=\"350\"><div id='chart_divindividual' style='height:150px; width:250px; margin-left: auto; margin-right: auto;'></div></td></tr></table></td></tr>");
	}
	for (arrkey in this.clueType)
	{
		$("#dectext"+arrkey).html("The "+arrkey+":");
		for(var k=1; k<=this.clueType[arrkey]; k++)
		{
			document.getElementById("rbForm"+arrkey).innerHTML+=("<input type=\"radio\" name=\"findec"+arrkey+"\" value=\""+arrkey+","+k+"\">"+step3Options[arrkey+","+k][0]+"<br>");
		}
	}
	$("#howconftable").hide();
}

function countDownEndGame(){  
	 if (this.EndGameTimer <=0){  
		$("#pbar").hide();
		$("#step3").hide();
		$("#pubinfo").hide();
		$("#helpinfo").hide();
		startSurvey();
	 }else{  
		this.EndGameTimer--;
		document.getElementById("timerbar").style.width=(this.EndGameTimer*100/parseInt(variables['end_game_timer']+""))+"%";
		document.getElementById("timer").innerHTML = this.EndGameTimer;  
		setTimeout("countDownEndGame()", 1000);
	 }  
}

function countDownNextRound(){  
	 if (this.NextRoundTimer <=0){  
		$("#step3").hide();
		$("#pubinfo").hide();
		this.Step2Timer=parseInt(variables['Step2Timer']+"")+1;
		$("#step3").html("<tr><td width=\"792\" height=\"53\" colspan=\"3\"><p id=\"basedonthe\">Based on the information you have gathered, identify: </p></td></tr>");
		this.NextRoundTimer=parseInt(variables['round_interval_timer']+"")+1;
		var arrkey;
		for (arrkey in this.clueType)
			for (var h=1; h<=this.clueType[arrkey]; h++)
				step3Options[arrkey+","+h][1]=0;
		loadStep2();
		$("#chat_conversation").html("<div>Welcome to public chat of the experiment!<br></div>");
	 }else{  
		this.NextRoundTimer--;
		document.getElementById("timerbar").style.width=(this.NextRoundTimer*100/parseInt(variables['round_interval_timer']+""))+"%";
		document.getElementById("timer").innerHTML = this.NextRoundTimer;  
		setTimeout("countDownNextRound()", 1000);
	 }  
}  

function countDownStep2(){  
	 if (this.Step2Timer <=0){ 
		clearTimeout(this.timeoutStep2);	 
		loadStep3();
	 }else{  
		this.Step2Timer--;
		document.getElementById("timerbar").style.width=(this.Step2Timer*100/parseInt(variables['Step2Timer']+""))+"%";
		document.getElementById("timer").innerHTML = this.Step2Timer;  
		this.timeoutStep2=setTimeout("countDownStep2()", 1000);
	 }  
} 

function countDownStep1(){  
	 if (this.Step1Timer <=0){ 
		clearTimeout(this.timeoutStep1);
		loadStep2();
	 }else{  
		this.Step1Timer--;
		document.getElementById("timerbar").style.width=(this.Step1Timer*100/parseInt(variables['Step1Timer']+""))+"%";
		document.getElementById("timer").innerHTML = this.Step1Timer; 
		this.timeoutStep1=setTimeout("countDownStep1()", 1000);
	 }  
} 

function showConfidence()
{
	this.myanswer="";
	var arrkey;
	for (arrkey in this.clueType)
	{
		if($("input:radio[name='findec"+arrkey+"']:checked").val()==undefined)
		{
			document.getElementById("submitStatus").innerHTML="<font color=\"red\">Please select one of the options from each group!</font>";
			return;
		}
		this.myanswer+=($("input:radio[name='findec"+arrkey+"']:checked").val()+"_");
	}
	for (arrkey in this.clueType)
	{
		$("#"+arrkey+"_row1").hide();
		$("#"+arrkey+"_row2").hide();
	}
	$("#howconftable").show();
	$("#submitStatus").html("&nbsp;");
	$("#basedonthe").html("&nbsp;");
	$("#subdecbut").hide();
}

function submitDecision()
{
	if($("input:radio[name='howconf']:checked").val()==undefined)
	{
		document.getElementById("submitStatus").innerHTML="<font color=\"red\">Please select one of the options!</font>";
		return;
	}
	for (arrkey in this.clueType)
	{
		$("#"+arrkey+"_row1").show();
		$("#"+arrkey+"_row2").show();
	}
	$("#basedonthe").html("Based on the information you have gathered, identify: ");
	$("#subconfbut").hide();
	$("#howconftable").hide();
	this.myanswer+=("|"+$("input:radio[name='howconf']:checked").val());
	submit(this.myanswer);
	document.getElementById("submitStatus").innerHTML="<font color=\"green\">Thank you! Your choices are sent. Waiting for other participants...</font>";
	setEnableRadioGroups(true);
}

function setEnableRadioGroups(en) {
  var forms, el, radioGroup;
  var i = end = j = elsEnd = rg = rgEnd = 0;
  
  if (document.getElementsByTagName) {
    forms = document.getElementsByTagName('form');
    /* Loop through all the FORMs */
    for (i, end = forms.length; i < end; i++) {
      /* Loop through each form element */
      for (j = 0, elsEnd = forms[i].elements.length; j < elsEnd; j++) {
        el = forms[i].elements[j];
        /* If this is a checked, enabled radio button in a radio group... */
        if (!el.disabled
            && el.nodeName === 'INPUT'
            && el.type == 'radio'
            && el.checked
            && forms[i].elements[el.name].length) {
          radioGroup = forms[i].elements[el.name];
          /* Loop through radio group and disable buttons */
          for (rg = 0, rgEnd = radioGroup.length; rg < rgEnd; rg++) {
            radioGroup[rg].disabled = en;
          }
        }
      }
    }
  }
}

Raphael.el.hoverInBounds = function(inFunc, outFunc) {
	var inBounds = false;

  // Mouseover function. Only execute if `inBounds` is false.
	this.mouseover(function() {
		if (!inBounds) {
			inBounds = true;
			inFunc.call(this);
		}
	});

  // Mouseout function
	this.mouseout(function(e) {
    var x = e.offsetX || e.clientX,
        y = e.offsetY || e.clientY;

    // Return `false` if we're still inside the element's bounds
		if (this.isPointInside(x, y)) return false;

		inBounds = false;
		outFunc.call(this);
	});

	return this;
}

// Hover in function
function hoverIn() {
	this.animate({
		r: 35
	}, 200);
}

// Hover out function
function hoverOut() {
	this.animate({
		r: 25
	}, 200);
}

function drawStaticNetwork()
{
	var canvasWidth=300;
	var canvasHeight=303;
	this.r = Raphael("myholder", 300, 303);
	this.circles = new Array();
	this.hiddencircles = new Array();
	this.xVals = new Array();
	this.yVals = new Array();
	this.labels = this.r.set();
	for(var g=1; g<=numPlayers; g++)
	{
		var circleY=-1;
		var circleX=-1;
		if(numPlayers==1)
		{
			circleY=canvasHeight/2;
			circleX=canvasWidth/2;
		}
		if(numPlayers==2)
		{
			circleY=canvasHeight/2;
			if(g==1)
				circleX=canvasWidth/3;
			if(g==2)
				circleX=2*canvasWidth/3;
		}
		if(numPlayers==3)
		{
			if(g>1)
			{
				circleY=2*canvasHeight/3;
				if(g==2)
					circleX=canvasWidth/3;
				if(g==3)
					circleX=2*canvasWidth/3;
			}
			else
			{
				circleX=canvasWidth/2;
				circleY=canvasHeight/3;
			}
		}
		if(numPlayers==4)
		{
			if(g>2)
			{
				circleY=2*canvasHeight/3;
				if(g==3)
					circleX=canvasWidth/3;
				if(g==4)
					circleX=2*canvasWidth/3;
			}
			else
			{
				circleY=canvasHeight/3;
				if(g==1)
					circleX=canvasWidth/3;
				if(g==2)
					circleX=2*canvasWidth/3;
			}
		}
		if(numPlayers==5)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/4;
				circleX=canvasWidth/8;
			}
			else if(g==2)
			{
				circleY=canvasHeight/4;
				circleX=4*canvasWidth/8;
			}
			else if(g==3)
			{
				circleY=2*canvasHeight/4;
				circleX=7*canvasWidth/8;
			}
			else
			{
				circleY=3*canvasHeight/4;
				if(g==4)
					circleX=2*canvasWidth/8;
				if(g==5)
					circleX=6*canvasWidth/8;
			}
		}
		if(numPlayers==6)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/4;
				circleX=canvasWidth/8;
			}
			else if(g==2)
			{
				circleY=canvasHeight/4;
				circleX=2*canvasWidth/8;
			}
			else if(g==3)
			{
				circleY=canvasHeight/4;
				circleX=6*canvasWidth/8;
			}
			else if(g==4)
			{
				circleY=2*canvasHeight/4;
				circleX=7*canvasWidth/8;
			}
			else
			{
				circleY=3*canvasHeight/4;
				if(g==5)
					circleX=2*canvasWidth/8;
				if(g==6)
					circleX=6*canvasWidth/8;
			}
		}
		if(numPlayers==7)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/5;
				circleX=canvasWidth/5;
			}
			if(g==2)
			{
				circleY=canvasHeight/5;
				circleX=canvasWidth/2;
			}
			if(g==3)
			{
				circleY=2*canvasHeight/5;
				circleX=4*canvasWidth/5;
			}
			if(g==4)
			{
				circleY=3*canvasHeight/5;
				circleX=4*canvasWidth/5;
			}
			if(g==5)
			{
				circleY=4*canvasHeight/5;
				circleX=3*canvasWidth/5;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/5;
				circleX=2*canvasWidth/5;
			}
			if(g==7)
			{
				circleY=3*canvasHeight/5;
				circleX=canvasWidth/5;
			}
		}
		if(numPlayers==8)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/5;
				circleX=canvasWidth/5;
			}
			if(g==2)
			{
				circleY=canvasHeight/5;
				circleX=2*canvasWidth/5;
			}
			if(g==3)
			{
				circleY=canvasHeight/5;
				circleX=3*canvasWidth/5;
			}
			
			if(g==4)
			{
				circleY=2*canvasHeight/5;
				circleX=4*canvasWidth/5;
			}
			if(g==5)
			{
				circleY=3*canvasHeight/5;
				circleX=4*canvasWidth/5;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/5;
				circleX=3*canvasWidth/5;
			}
			if(g==7)
			{
				circleY=4*canvasHeight/5;
				circleX=2*canvasWidth/5;
			}
			if(g==8)
			{
				circleY=3*canvasHeight/5;
				circleX=canvasWidth/5;
			}
		}
		if(numPlayers==9)
		{
			if(g==1)
			{
				circleY=3*canvasHeight/6;
				circleX=1*canvasWidth/12;
			}
			if(g==2)
			{
				circleY=2*canvasHeight/6;
				circleX=3*canvasWidth/12;
			}
			if(g==3)
			{
				circleY=1*canvasHeight/6;
				circleX=canvasWidth/2;
			}
			if(g==4)
			{
				circleY=2*canvasHeight/6;
				circleX=9*canvasWidth/12;
			}
			if(g==5)
			{
				circleY=3*canvasHeight/6;
				circleX=11*canvasWidth/12;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/6;
				circleX=9*canvasWidth/12+6;
			}
			if(g==7)
			{
				circleY=5*canvasHeight/6;
				circleX=7*canvasWidth/12+5;
			}
			if(g==8)
			{
				circleY=5*canvasHeight/6;
				circleX=5*canvasWidth/12-20;
			}
			if(g==9)
			{
				circleY=4*canvasHeight/6;
				circleX=3*canvasWidth/12-20;
			}
		}
		var circle = this.r.circle(circleX, circleY,25);
		if((g==myid||canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))&&parseInt(variables['chatting_with_everyone'])==1)
			circle.attr("fill", "#0A4");
		else
			circle.attr("fill", "#00f");
		circle.attr("stroke", "#000");
		circle.attr("cursor", "pointer");
		//circle.hover(hoverIn, hoverOut);
		this.circles.push(circle);
		this.xVals.push(circleX);
		this.yVals.push(circleY);
		if(jQuery.browser.webkit)//if safari or chrome
		{
			if(myid==g)
				this.labels.push(this.r.text(this.xVals[g-1]-23, (this.yVals[g-1]-4)/2, "\u00a0\u00a0\u00a0\u00a0You\n("+getName(myid)+")"));
			else
				this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5)/2, getName(g)+""));
			var c = this.r.circle(circleX, circleY,25);
			c.attr("fill", "red");
			c.attr("cursor", "pointer");
			c.attr({opacity: 0});
			this.hiddencircles.push(c);
		}
		else
		{
			if(myid==g)
				this.labels.push(this.r.text(this.xVals[g-1]-23, (this.yVals[g-1]-4), "\u00a0\u00a0\u00a0\u00a0You\n("+getName(myid)+")"));
			else
				this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5), getName(g)+""));
			var c = this.r.circle(circleX, circleY,25);
			c.attr("fill", "red");
			c.attr("cursor", "pointer");
			c.attr({opacity: 0});
			this.hiddencircles.push(c);
		}
		
	}          
	this.labels.attr({font: "12px Fontin-Sans, Arial", fill: "#fff", "text-anchor": "start", "cursor": "pointer"});
	
	for(var h=0; h<this.circles.length-1; h++)
	{
		for(var i=h+1; i<this.circles.length; i++)
		{
			var path = new Object();
			path.line = this.r.path("M "+this.xVals[h]+" "+this.yVals[h]+" l "+(this.xVals[i]-this.xVals[h])+" "+(this.yVals[i]-this.yVals[h])+" z");
			path.line.attr({stroke: '#3b4449','stroke-width': 3});
			path.line.toBack();
		}
	}
	if(numPlayers==1)
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	if(numPlayers==2)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==3)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==4)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==5)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==6)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==7)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==8)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[7].hover(function(){circles[7].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[7].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==9)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[7].hover(function(){circles[7].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[7].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[8].hover(function(){circles[8].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[8].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}

	circleClick();
}

function drawDynamicNetwork()
{
	var canvasWidth=300;
	var canvasHeight=303;
	this.r = Raphael("myholder", 300, 303);
	this.circles = new Array();
	this.hiddencircles = new Array();
	this.xVals = new Array();
	this.yVals = new Array();
	this.labels = this.r.set();
	for(var g=1; g<=numPlayers; g++)
	{
		var circleY=-1;
		var circleX=-1;
		if(numPlayers==1)
		{
			circleY=canvasHeight/2;
			circleX=canvasWidth/2;
		}
		if(numPlayers==2)
		{
			circleY=canvasHeight/2;
			if(g==1)
				circleX=canvasWidth/3;
			if(g==2)
				circleX=2*canvasWidth/3;
		}
		if(numPlayers==3)
		{
			if(g>1)
			{
				circleY=2*canvasHeight/3;
				if(g==2)
					circleX=canvasWidth/3;
				if(g==3)
					circleX=2*canvasWidth/3;
			}
			else
			{
				circleX=canvasWidth/2;
				circleY=canvasHeight/3;
			}
		}
		if(numPlayers==4)
		{
			if(g>2)
			{
				circleY=2*canvasHeight/3;
				if(g==3)
					circleX=canvasWidth/3;
				if(g==4)
					circleX=2*canvasWidth/3;
			}
			else
			{
				circleY=canvasHeight/3;
				if(g==1)
					circleX=canvasWidth/3;
				if(g==2)
					circleX=2*canvasWidth/3;
			}
		}
		if(numPlayers==5)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/4;
				circleX=canvasWidth/8;
			}
			else if(g==2)
			{
				circleY=canvasHeight/4;
				circleX=4*canvasWidth/8;
			}
			else if(g==3)
			{
				circleY=2*canvasHeight/4;
				circleX=7*canvasWidth/8;
			}
			else
			{
				circleY=3*canvasHeight/4;
				if(g==4)
					circleX=2*canvasWidth/8;
				if(g==5)
					circleX=6*canvasWidth/8;
			}
		}
		if(numPlayers==6)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/4;
				circleX=canvasWidth/8;
			}
			else if(g==2)
			{
				circleY=canvasHeight/4;
				circleX=2*canvasWidth/8;
			}
			else if(g==3)
			{
				circleY=canvasHeight/4;
				circleX=6*canvasWidth/8;
			}
			else if(g==4)
			{
				circleY=2*canvasHeight/4;
				circleX=7*canvasWidth/8;
			}
			else
			{
				circleY=3*canvasHeight/4;
				if(g==5)
					circleX=2*canvasWidth/8;
				if(g==6)
					circleX=6*canvasWidth/8;
			}
		}
		if(numPlayers==7)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/5;
				circleX=canvasWidth/5;
			}
			if(g==2)
			{
				circleY=canvasHeight/5;
				circleX=canvasWidth/2;
			}
			if(g==3)
			{
				circleY=2*canvasHeight/5;
				circleX=4*canvasWidth/5;
			}
			if(g==4)
			{
				circleY=3*canvasHeight/5;
				circleX=4*canvasWidth/5;
			}
			if(g==5)
			{
				circleY=4*canvasHeight/5;
				circleX=3*canvasWidth/5;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/5;
				circleX=2*canvasWidth/5;
			}
			if(g==7)
			{
				circleY=3*canvasHeight/5;
				circleX=canvasWidth/5;
			}
		}
		if(numPlayers==8)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/5;
				circleX=canvasWidth/5;
			}
			if(g==2)
			{
				circleY=canvasHeight/5;
				circleX=2*canvasWidth/5;
			}
			if(g==3)
			{
				circleY=canvasHeight/5;
				circleX=3*canvasWidth/5;
			}
			
			if(g==4)
			{
				circleY=2*canvasHeight/5;
				circleX=4*canvasWidth/5;
			}
			if(g==5)
			{
				circleY=3*canvasHeight/5;
				circleX=4*canvasWidth/5;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/5;
				circleX=3*canvasWidth/5;
			}
			if(g==7)
			{
				circleY=4*canvasHeight/5;
				circleX=2*canvasWidth/5;
			}
			if(g==8)
			{
				circleY=3*canvasHeight/5;
				circleX=canvasWidth/5;
			}
		}
		if(numPlayers==9)
		{
			if(g==1)
			{
				circleY=3*canvasHeight/6;
				circleX=1*canvasWidth/12;
			}
			if(g==2)
			{
				circleY=2*canvasHeight/6;
				circleX=3*canvasWidth/12;
			}
			if(g==3)
			{
				circleY=1*canvasHeight/6;
				circleX=canvasWidth/2;
			}
			if(g==4)
			{
				circleY=2*canvasHeight/6;
				circleX=9*canvasWidth/12;
			}
			if(g==5)
			{
				circleY=3*canvasHeight/6;
				circleX=11*canvasWidth/12;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/6;
				circleX=9*canvasWidth/12+6;
			}
			if(g==7)
			{
				circleY=5*canvasHeight/6;
				circleX=7*canvasWidth/12+5;
			}
			if(g==8)
			{
				circleY=5*canvasHeight/6;
				circleX=5*canvasWidth/12-20;
			}
			if(g==9)
			{
				circleY=4*canvasHeight/6;
				circleX=3*canvasWidth/12-20;
			}
		}
		var circle = new Object();
		circle=this.r.circle(circleX, circleY,25);
		if((g==myid||canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))&&parseInt(variables['chatting_with_everyone'])==1)
			circle.attr("fill", "#0A4");
		else
			circle.attr("fill", "#00f");
		circle.attr("stroke", "#000");
		circle.attr("cursor", "pointer");
	//	circle.hover(hoverIn, hoverOut);
		this.circles.push(circle);
		this.xVals.push(circleX);
		this.yVals.push(circleY);
		
		if(jQuery.browser.webkit)//if safari or chrome
		{
			if(myid==g)
				this.labels.push(this.r.text(this.xVals[g-1]-26, (this.yVals[g-1]-4)/2, "\u00a0\u00a0\u00a0\u00a0You\n("+getName(myid)+")"));
			else
				this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5)/2, getName(g)+""));
			var c = this.r.circle(circleX, circleY,25);
			c.attr("fill", "red");
			c.attr("cursor", "pointer");
			c.attr({opacity: 0});
			this.hiddencircles.push(c);
		}
		else
		{
			if(myid==g)
				this.labels.push(this.r.text(this.xVals[g-1]-26, (this.yVals[g-1]-4), "\u00a0\u00a0\u00a0\u00a0You\n("+getName(myid)+")"));
			else
				this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5), getName(g)+""));
			var c = this.r.circle(circleX, circleY,25);
			c.attr("fill", "red");
			c.attr("cursor", "pointer");
			c.attr({opacity: 0});
			this.hiddencircles.push(c);
		}
		this.labels.attr({font: "12px Fontin-Sans, Verdana", fill: "#fff", "text-anchor": "start", "cursor": "pointer"});
	}   

	if(numPlayers==1)
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	if(numPlayers==2)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==3)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==4)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==5)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==6)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==7)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==8)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[7].hover(function(){circles[7].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[7].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	if(numPlayers==9)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[7].hover(function(){circles[7].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[7].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
		this.hiddencircles[8].hover(function(){circles[8].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[8].animate({ r: 25 }, 200);this.animate({ r: 25 }, 200);});
	}
	
	circleClick();
	
	/*for(var h=0; h<this.circles.length-1; h++)
	{
		for(var i=h+1; i<this.circles.length; i++)
		{
			if(canCommunicate(h, i))
			{
				var path = new Object();
				path.line = this.r.path("M "+xVals[h]+" "+this.yVals[h]+" l "+(this.xVals[i]-this.xVals[h])+" "+(this.yVals[i]-this.yVals[h])+" z");
				path.line.attr({stroke: '#3b4449','stroke-width': 5});
				path.line.toBack();
			}
		}
	}*/
}

function canCommunicate(i, j)
{
	return (variables["communication"]==null||variables["communication"]==undefined||variables["communication"][i]==null||variables["communication"][i]==undefined||variables["communication"][i][j]==null||variables["communication"][i][j]==undefined); // if matrix is empty, they can communicate. Subject to change!
	return (parseInt(variables["communication"][i][j]+"")==1);
}

function circleClick(){
	for(var g=1; g<=numPlayers; g++)
	{
		if(canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
		{
			if(g==1)
			{
				this.circles[g-1].click(function() {
					highlightCircle(1);
					return;
				});
				this.hiddencircles[g-1].click(function() {
				highlightCircle(1);
				return;
			});
			}
			if(g==2)
			{
				this.circles[g-1].click(function() {
					highlightCircle(2);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(2);
					return;
				});

			}
			if(g==3)
			{
				this.circles[g-1].click(function() {
					highlightCircle(3);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(3);
					return;
				});
			}
			if(g==4)
			{
				this.circles[g-1].click(function() {
					highlightCircle(4);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(4);
					return;
				});
			}
			if(g==5)
			{
				this.circles[g-1].click(function() {
					highlightCircle(5);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(5);
					return;
				});
			}
			if(g==6)
			{
				this.circles[g-1].click(function() {
					highlightCircle(6);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(6);
					return;
				});
			}
			if(g==7)
			{
				this.circles[g-1].click(function() {
					highlightCircle(7);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(7);
					return;
				});
			}
			if(g==8)
			{
				this.circles[g-1].click(function() {
					highlightCircle(8);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(8);
					return;
				});
			}
			if(g==9)
			{
				this.circles[g-1].click(function() {
					highlightCircle(9);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(9);
					return;
				});
			}
		}
	}
}

function highlightCircle(gg)
{
	if(gg==0)
	{
		for(var g=1; g<=numPlayers; g++)
		{
			if(g==myid||canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
				this.circles[g-1].attr("fill", "#0A4");
		}
		setUser(0); 
		removeActives();
		$('#0').addClass('active');
	}
	else
	{
		for(var ic=0; ic<numPlayers; ic++)
			this.circles[ic].attr("fill", "#00f");
		this.circles[gg-1].attr("fill", "#0A4");
		setUser(gg); 
		removeActives();
		$('#'+gg).addClass('active');
	}
}

function setUser(nmb)
{
	selectedUser=nmb;
}

function removeActives()
{
	for(var g=0; g<=numPlayers; g++)
	{
		if ($("#"+g)!=null&&$("#"+g)!=undefined&&$("#"+g).is('.active'))
			$("#"+g).removeClass("active");
	}
}
  
 $("#chat_input").keypress(function(event) {
    if ( event.which == 13 ) {
		sendMessage();
        event.preventDefault();
    }
  });
  
       
/*function curve(x, y, ax, ay, bx, by, zx, zy, color) 
{
	var path = [["M", x, y], ["C", ax, ay, bx, by, zx, zy]],
		path2 = [["M", x, y], ["L", ax, ay], ["M", bx, by], ["L", zx, zy]],
		curve = r.path(path).attr({stroke: '#3b4449','stroke-width': 3	, 'stroke-dasharray':'-'}),
		controls = r.set(
			r.circle(x, y, 0.1).attr({fill: "#9F2200", stroke: "none"}),
			r.circle(ax, ay, 0.1).attr({fill: "#9F2200", stroke: "none"}),
			r.circle(bx, by, 0.1).attr({fill: "#9F2200", stroke: "none"}),
			r.circle(zx, zy, 0.1).attr({fill: "#9F2200", stroke: "none"})
		);
		curve.toBack();
}*/
  
/*function drawLineIfMessageReceived()
{
	if(this.chatContent!=$("#chat_conversation").html())
	{
		for(var g=1; g<=numPlayers; g++)
		{
			if(g!=myid&&getName(g)==$("#chat_conversation").html().substring($("#chat_conversation").html().indexOf('>',$("#chat_conversation").html().lastIndexOf("<div color"))+1,$("#chat_conversation").html().lastIndexOf("</div><div>")-1))
			{
				var path = new Object();
				path.line = this.r.path("M "+xVals[myid-1]+" "+this.yVals[myid-1]+" l "+(this.xVals[g-1]-this.xVals[myid-1])+" "+(this.yVals[g-1]-this.yVals[myid-1])+" z");
				path.line.attr({stroke: '#3b4449','stroke-width': 3	, 'stroke-dasharray':'-'});
				path.line.toBack();
				//if(this.yVals[myid-1]<=this.yVals[g-1])
				//	curve(xVals[myid-1], this.yVals[myid-1],xVals[myid-1]+20, this.yVals[myid-1]+(this.yVals[g-1]-this.yVals[myid-1])/2, this.xVals[g-1]+40, this.yVals[g-1]-(this.yVals[g-1]-this.yVals[myid-1])/2, this.xVals[g-1], this.yVals[g-1], "hsb(0, 0, 0)");
				//else
				//	curve(xVals[myid-1], this.yVals[myid-1],xVals[myid-1]+20, this.yVals[myid-1]-(this.yVals[g-1]-this.yVals[myid-1])/2, this.xVals[g-1]+40, this.yVals[g-1]+(this.yVals[g-1]-this.yVals[myid-1])/2, this.xVals[g-1], this.yVals[g-1], "hsb(0, 0, 0)"); 				
			}
		}
	}
	this.chatContent=$("#chat_conversation").html();
	setTimeout("drawLineIfMessageReceived()", 1000);
}*/

function comReceived(index, newCom) {
  if (newCom.com_type == -1) {
    chatReceived(newCom.from,newCom.val,newCom.to_parts);
  }
}

function chatReceived(from_ids,message,to_ids) {
	if(this.condition==3)
	{
		if (to_ids[2] == to_ids[5]) return;
		if (to_ids[2] == myid) {
			$('#chat_conversation').append("<div class='messagesender'>You ("+getName(myid)+"):</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
		}
		if (to_ids[5] == myid)
			$('#chat_conversation').append("<div class='messagereceiver'>"+getName(from_ids)+":</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
		$('#chat_conversation').scrollTop = $('#chat_conversation').scrollHeight;
		var path = new Object();
		path.line = this.r.path("M "+xVals[to_ids[2]-1]+" "+this.yVals[to_ids[2]-1]+" l "+(this.xVals[to_ids[5]-1]-this.xVals[to_ids[2]-1])+" "+(this.yVals[to_ids[5]-1]-this.yVals[to_ids[2]-1])+" z");
		path.line.attr({stroke: '#3b4449','stroke-width': 3});
		path.line.toBack();
	}
	else
	{
		if (to_ids[4] == to_ids[1]) return;
		if (to_ids[4] == myid) {
			$('#chat_conversation').append("<div class='messagesender'>You ("+getName(myid)+"):</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
		}
		if (to_ids[1] == myid)
			$('#chat_conversation').append("<div class='messagereceiver'>"+getName(from_ids)+":</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
		$('#chat_conversation').scrollTop = $('#chat_conversation').scrollHeight;
		var path = new Object();
		path.line = this.r.path("M "+xVals[to_ids[4]-1]+" "+this.yVals[to_ids[4]-1]+" l "+(this.xVals[to_ids[1]-1]-this.xVals[to_ids[4]-1])+" "+(this.yVals[to_ids[1]-1]-this.yVals[to_ids[4]-1])+" z");
		path.line.attr({stroke: '#3b4449','stroke-width': 3});
		path.line.toBack();
	}
}

function sendMessage()
{
	if($("#chat_input").val()==null||$("#chat_input").val()=="Type something here..."||$("#chat_input").val()=="") return;

	if(this.condition==3)
	{
		if(selectedUser==undefined||selectedUser==null||selectedUser==0)
		{
			if(parseInt(variables['chatting_with_everyone'])==1)
			{
				var msgArr = new Array();
				msgArr.push(myid);
				for(var g=1; g<=numPlayers; g++)
				{
					if(canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
					{
						msgArr.push(g);
						//var path = new Object();
						//path.line = this.r.path("M "+xVals[myid-1]+" "+this.yVals[myid-1]+" l "+(this.xVals[g-1]-this.xVals[myid-1])+" "+(this.yVals[g-1]-this.yVals[myid-1])+" z");
						//path.line.attr({stroke: '#3b4449','stroke-width': 3	, 'stroke-dasharray':'-'});
						//path.line.toBack();
						//if(this.yVals[myid-1]<=this.yVals[g-1])
						//	curve(xVals[myid-1], this.yVals[myid-1],xVals[myid-1]+20, this.yVals[myid-1]+(this.yVals[g-1]-this.yVals[myid-1])/3, this.xVals[g-1]+40, this.yVals[g-1]-(this.yVals[g-1]-this.yVals[myid-1])/3, this.xVals[g-1], this.yVals[g-1], "hsb(0, 0, 0)");
						//else
						//	curve(xVals[myid-1], this.yVals[myid-1],xVals[myid-1]+20, this.yVals[myid-1]-(this.yVals[g-1]-this.yVals[myid-1])/3, this.xVals[g-1]+40, this.yVals[g-1]+(this.yVals[g-1]-this.yVals[myid-1])/3, this.xVals[g-1], this.yVals[g-1], "hsb(0, 0, 0)"); 
					}
				}
				sendChat($("#chat_input").val(), msgArr);
			}
		}
		else
		{
			var msgArr = new Array();
			msgArr.push(myid);
			if(canCommunicate(myid-1, selectedUser-1)||canCommunicate(selectedUser-1, myid-1))
			{
				msgArr.push(selectedUser);
				//var path = new Object();
				//path.line = this.r.path("M "+xVals[myid-1]+" "+this.yVals[myid-1]+" l "+(this.xVals[selectedUser-1]-this.xVals[myid-1])+" "+(this.yVals[selectedUser-1]-this.yVals[myid-1])+" z");
				//path.line.attr({stroke: '#3b4449','stroke-width': 3	, 'stroke-dasharray':'-'});
				//path.line.toBack();
				//if(this.yVals[myid-1]<=this.yVals[selectedUser-1])
				//	curve(xVals[myid-1], this.yVals[myid-1],xVals[myid-1]+20, this.yVals[myid-1]+(this.yVals[selectedUser-1]-this.yVals[myid-1])/3, this.xVals[selectedUser-1]+40, this.yVals[selectedUser-1]-(this.yVals[selectedUser-1]-this.yVals[myid-1])/3, this.xVals[selectedUser-1], this.yVals[selectedUser-1], "hsb(0, 0, 0)");
				//else
				//	curve(xVals[myid-1], this.yVals[myid-1],xVals[myid-1]+20, this.yVals[myid-1]-(this.yVals[selectedUser-1]-this.yVals[myid-1])/3, this.xVals[selectedUser-1]+40, this.yVals[selectedUser-1]+(this.yVals[selectedUser-1]-this.yVals[myid-1])/3, this.xVals[selectedUser-1], this.yVals[selectedUser-1], "hsb(0, 0, 0)"); 
			}
			sendChat($("#chat_input").val(), msgArr);
		}
	}
	else
	{
		if(selectedUser==undefined||selectedUser==null||selectedUser==0)
		{
			if(parseInt(variables['chatting_with_everyone'])==1)
				sendChat($("#chat_input").val());
		}
		else
		{
			var msgArr = new Array();
			msgArr.push(selectedUser);
			msgArr.push(myid);
			sendChat($("#chat_input").val(),msgArr);
		}
	}
	$("#chat_input").val('');
}	
</script> 