<table border="0" width="806" align="center">
    <tr>
        <td width="800">
		
			<table border="0" class="gametable" id="gameinstructions" align="center" width="800" height="600">
				<tr>
					<td width="800" colspan="5" height="8"></td>
				</tr>
				<tr>
					<td width="70"></td>
					<td width="485">
					</td>
					<td width="1" valign="top">
						<p align="right"><font face="Verdana"><span style="font-size:14pt;"></span></font></p>
					</td>
					<td width="5" valign="top"></td>
					<td width="227" valign="top">
						<p align="left"><font face="Verdana"><span style="font-size:14pt;" id="insttimer"></span></font></p>
					</td>
				</tr>
				<tr>
					<td width="800" colspan="5">
						<table align="center" border="0" width="555" height="450">
							<tr>
								<td>
									<div class="center_everything" id="video_instructions" style="display: none;">
										<h2>Instructions</h2>
										<br/>  
										<div id="VideoHere"></div>
										<div id="example4">
											<input id="begininsbut" class="btn-large btn-success dropdown-toggle" type="submit" value="I'm Ready" onclick="submit('Ready');$('#begininsbut').hide();$('#example4').html('Please wait for others...');"/>
										</div>    
									</div>
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
		
			<table id="helpinfotable">
				<tr>
					<td>
						<div id="helpinfo" class="mybs-docs-example tooltip-demo">
							<ul>
								<li id="timetext" style="margin-bottom: 0;"></li>
								<li id="comch" style="margin-bottom: 0;">Open a communication channel with your teammate by clicking on the teammate's name. You may chat with as many of your teammates as frequently as you wish, however you may only communicate with one teammate at a time. </li>
								<li id="stepgoal" style="margin-bottom: 0;">Please read the provided information at this step.</li>
							</ul>
						</div>
					</td>
				</tr>
			</table>
		
			<table id="pbar" border="0" width="800" align="center">
				<tr id="pbarrow">
					<td width="440">
					</td>
					<td width="118">
                        <p align="right" style="font-family:'Verdana';font-size:15pt;" id="tlefttext">Time Left:
                        </p>
                    </td>
                    <td width="54">
                        <p style="font-family:'Verdana';font-size:15pt;"><font color="red" id="timer"></font></p>
                    </td>
				</tr>
			</table>
		
			<div id="gamecontent">
				<table width="800">
					<tr>
						<td colspan="3">
							<p id='ttl' align='center'></p>
						</td>
					</tr>
					<tr>
						<td>
							<div id="pubinfo" style="width: 100%;">
							</div>
						</td>
						<td width="20">&nbsp;</td>
						<td id="hpnotesvoting">
							<table border="0" id="notetable">
								<tr>
									<td width="294" class="myfont">
									Notes:
									</td>
								</tr>
								<tr>
									<td width="294" height="200">
										<textarea id="noteareavoting"></textarea>
									</td>
								</tr>
							</table>
						</td>
					</tr>
				</table>

				<table id="step2" align="center" border="0" width="845">
					<tr>
						<td id="conditiontablespaceleft">
						</td>
						<td width="306" id="conditiontabletd">
							<table align="center" border="0" width="308" height="347" id="conditiontable">
							</table>
						</td>
						<td width="2">	
						</td>
						<td width="513">			
							<table align="center" border="0" width="468" class="myhero-unit" id="chattable">
								<tr>
									<td width="455" height="156"></td>
								</tr>
								<tr>
									<td width="455" height="171">
										<div style="text-align: center; vertical-align:middle; width: 100%; height: 100%; font-family:'Verdana'; font-size: 12pt;">
										Please click on a user to start conversation...
										</div>
									</td>
								</tr>
							</table>
						</td>
						<td id="conditiontablespaceright">
						</td>
					</tr>
                    <tr>
                        <td colspan="6" width="835" height="20">
						</td>
                    </tr>
                    <tr>
                        <td colspan="6" width="835">
						<table border="0">
							<tr>
								<td width="480" id="pubcontainer"></td>
								<td width="20" id="adjustableNotesWidth"></td>
								<td width="300" id="hpnotes">
									<table border="0" id="notetable">
										<tr>
											<td width="294" class="myfont">
											Notes:
											</td>
										</tr>
										<tr>
											<td width="294" height="200">
												<textarea id="notearea"></textarea>
											</td>
										</tr>
									</table>
								</td>
							</tr>
						</table>
						</td>
                    </tr>
				</table>
				
				<table id="step3" border="0" align="center" width="792">
					<tr>
						<td width="798" colspan="5" id="submitStatus">
						</td>
					</tr>
					<tr>
						<td width="798" height="20" colspan="5">
							<p id="basedonthe">Based on the information you have gathered, identify: </p>
						</td>
					</tr>
				</table>
				
				<table id="endgamesurvey" border="0" width="799" align="center">
					<tr>
						<td width="107" height="23">&nbsp;</td>
						<td width="584" height="23">
							<div id="surveytitlediv"><h3 align="center" id="surveytitle"></h3></div>
						</td>
						<td width="94" height="23">&nbsp;</td>
					</tr>
					<tr id="surveyimagerow">
						<td width="107" height="24">&nbsp;</td>
						<td width="584" height="24">
							<div id="surveyimage"></div>
						</td>
						<td width="94" height="24">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="22">&nbsp;</td>
						<td width="584" height="22">&nbsp;</td>
						<td width="94" height="22">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="49">&nbsp;</td>
						<td width="584" height="49"><div id="surveytext"></div></td>
						<td width="94" height="49">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="22">&nbsp;</td>
						<td width="584" height="22"></td>
						<td width="94" height="22">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="200">&nbsp;</td>
						<td width="584" height="200">
							<div id="surveyoptions">
								<form id="rbFormSurv">
												
								</form>
								<table id="likertplayerstable" border="0" bordercolordark="black" bordercolorlight="black" width="582">
								</table>
								<p align="center">
									<button id="stbut" class="btn btn-large btn-block" onClick="displaySurveyQuestion(0); $('#stbut').hide();" type="button">Start Survey</button>
								</p>
							</div>
						</td>
						<td width="94" height="200">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="95">&nbsp;</td>
						<td width="584" height="95">&nbsp;</td>
						<td width="94" height="95">&nbsp;</td>
					</tr>
					<tr>
						<td width="107" height="27">
						   <p align="center"><button id="prevsurveybut" type="submit" class="btn btn-primary" onClick="prevSurveyQuestion();">
							<i class="icon-arrow-left icon-white"></i> Previous
						</button></p>
						</td>
						<td width="584" height="27">&nbsp;</td>
						<td width="94" height="27">
							<p align="center"><button id="nextsurveybut" type="submit" class="btn btn-primary" onClick="nextSurveyQuestion();">
							<i class="icon-arrow-right icon-white"></i> Next
						</button></p>
						</td>
					</tr>
				</table>
				
			</div>
</table>

<script language="JavaScript" type="text/javascript">  

var privateOrder;
var InstructionsTimer 
var Step1Timer;
var Step2Timer;
var timeoutInst;
var timeoutStep1;
var timeoutStep2;
var EndGameTimer;
var NextRoundTimer;
var selectedUser=0;
var userMessage="";
var step3Options;
var clueType;
var shuffledOptions;
var infoCounts;
var endGameResultsArr;
var questions = new Array();
var title;
var introtext;
var intropic;
var strictness;
var currentQuestion=0;
var surveySelections=new Array();
var canvasWidth=300;
var canvasHeight=303;
var condition;
var currentDiscRound;
var publicInfo;
var privateInfo;
var publicImage;
var readyCount;
var myanswer;
var tabTemplate;
var tabs;
var circleColors;
var gameInfo;
var draggableInfo;
var sharedMessage;
var iControlBots = false;
var botSchedule;
var numOfBotSchedule;
var numOfWaitingSchedule;

function initialize()
{
	this.readyCount=0;
	$("#helpinfo").hide();
	$("#pbar").hide();
	$("#pubinfo").hide();
	$("#step2").hide();
	$("#step3").hide();
	$('#endgamesurvey').hide();
	$('#notearea').html("");
	$("#hpnotesvoting").hide();
	$("#ttl").hide();
	$('#pubinfo').html("<div id='desc' class='accordion'></div><div id='step1' class='accordion'></div>");
	document.getElementById("timetext").innerHTML="You have "+variables['Step1Timer']+" seconds before proceeding at next step.";
	this.InstructionsTimer=parseInt(variables['InstructionsTimer']+"")+1; 
	this.Step1Timer=parseInt(variables['Step1Timer']+"")+1; 
	this.Step2Timer=parseInt(variables['Step2Timer']+"")+1;
	this.EndGameTimer=parseInt(variables['end_game_timer']+"")+1;
	this.NextRoundTimer=parseInt(variables['round_interval_timer']+"")+1;
	parseScenarioXML();
	if(myid==1)	iControlBots = true;
	this.numOfBotSchedule=0;
	this.numOfWaitingSchedule=0;
	this.endGameResultsArr=new Array();
}

function arraySize(obj) {
    var size = 0, key;
    for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
    }
    return size;
};

function preprocess(str)
{
	while(str.indexOf('[')>=0&&str.indexOf(']',str.indexOf('[')+1)>=0)
	{
		if(str.indexOf('[')>=0&&str.indexOf(']',str.indexOf('[')+1)>=0)
			str=str.substring(0, str.indexOf('['))+this.step3Options[str.substring(str.indexOf('[')+1, str.indexOf(']'))][0]+str.substring(str.indexOf(']',str.indexOf('[')+1)+1, str.length);
	}
	return str;
}

function parseScenarioXML()
{
	this.step3Options = new Array();
	this.clueType = new Array(); // contains the number of options from each group
	this.shuffledOptions = new Array();
	this.infoCounts = new Array(); // contains the number of information from each group
	xmlDoc=loadXMLDoc(getFile("scenario"+variables['scenario_number']+".xml"));

	for(var j=0; j<xmlDoc.getElementsByTagName("option").length; j++)
	{
		if(this.clueType[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)]==null||
		this.clueType[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)]==undefined)
		{
			this.clueType[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)]=1;
			this.shuffledOptions[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)]=new Array();
			this.shuffledOptions[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)].push(1);
		}
		else
		{
			this.clueType[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)]++;
			this.shuffledOptions[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)].push(this.shuffledOptions[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)][this.shuffledOptions[$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)].length-1]+1);
		}
	}
	
	for(var j=0; j<xmlDoc.getElementsByTagName("clue").length; j++)
	{
		var arrkey;
		for (arrkey in this.clueType)
		{
			if($.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("visibility").nodeValue)=="private"
			&&$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("type").nodeValue)==arrkey)
			{
				if(this.infoCounts[arrkey]==null||infoCounts[arrkey]==undefined)
					this.infoCounts[arrkey]=1;
				else
					this.infoCounts[arrkey]++;
			}
		}
	}
	
	var title = $.trim(xmlDoc.getElementsByTagName("title")[0].childNodes[0].nodeValue);
	$("#ttl").html(title);

	//var size = arraySize(this.step3Options);
	
	//var size = 0, key;
   // for (key in this.clueType) {
   //     if (this.clueType.hasOwnProperty(key)) alert(key+","+this.clueType[key]);
	//}

	setRound(1);

	if(myid==1)
	{
		this.privateOrder="";
		if(variables['random_private_info']==1)
		{
			var numbers=new Array();
			for(var i=0; i<numPlayers+parseInt(variables["bot_count"]); i++)
			{
				this.privateOrder+="<setup type=\"assignment\" subject=\""+(i+1)+"\">";
				var arrkey;
				for (arrkey in this.clueType)
				{
					var randomnumber=-1;
					do{
						randomnumber=Math.floor(Math.random()*this.infoCounts[arrkey])+1;
					}while(numbers[arrkey+","+randomnumber]==true);
					numbers[arrkey+","+randomnumber]=true;
					this.privateOrder+=((arrkey+","+randomnumber)+"-");
				}
				this.privateOrder=this.privateOrder.substring(0, this.privateOrder.length-1);
				this.privateOrder+="</setup>";
			}
		}
		else
		{
			for(var i=1; i<=numPlayers+parseInt(variables["bot_count"]); i++)
			{
				this.privateOrder+="<setup type=\"assignment\" subject=\""+(i+1)+"\">";
				var arrkey;
				for (arrkey in this.clueType)
					this.privateOrder+=((arrkey+","+i)+"-");
				this.privateOrder=this.privateOrder.substring(0, this.privateOrder.length-1);
				this.privateOrder+="</setup>";
			}
		}
		if($.trim(variables["visualization_type"])=="1"||$.trim(variables["visualization_type"])=="2"||$.trim(variables["visualization_type"])=="3")
			this.privateOrder=parseInt(variables["visualization_type"])+"</setup>"+this.privateOrder;
		else
			this.privateOrder=(Math.floor(Math.random()*3)+1)+"</setup>"+this.privateOrder;
		var key;
		var optionsOrder="";
		for (key in this.clueType) 
			optionsOrder+=("<setup type=\"shuffledOptions\" name=\""+key+"\">"+shuffle(this.shuffledOptions[key])+"</setup>");
		this.privateOrder=optionsOrder+"<setup type=\"condition\">"+this.privateOrder;
		submit(this.privateOrder);
	}
}

function shuffle(array) {
    var counter = array.length, temp, index;

    // While there are elements in the array
    while (counter > 0) {
        // Pick a random index
        index = Math.floor(Math.random() * counter);

        // Decrease counter by 1
        counter--;

        // And swap the last element with it
        temp = array[counter];
        array[counter] = array[index];
        array[index] = temp;
    }

    return array;
}

function setEveryoneTab()
{
	this.tabTemplate = "<li id='#{tabli}'><a href='#{href}'>#{label}</a> <span class='ui-icon ui-icon-close' role='presentation'>Remove Tab</span></li>";
	if(parseInt(variables['chatting_with_everyone'])==1)
	{
		if(parseInt(variables['conversation_type'])==1)
		{
			$("#chattable").html("<tr><td width=\"455\" height=\"87\"><div id=\"tabs\"><ul><li id=\"tabli0\"><a href=\"#tabs-0\">Everyone</a></li></ul><div id=\"tabs-0\"><div class=\"control-group\"><div class=\"controls\"> <div id=\"chat_conversation0\" style=\"background-color:white; text-align:left; width: 100%; height: 250px; overflow: auto; font-family:'Verdana'; font-size: 10pt;\"><div></div></div></div></div></div></div><i class=\"icon-pencil\"></i><input onFocus=\"document.getElementById('chat_input').value='';\" value=\"Type something here...\" type=\"text\" id=\"chat_input\" style=\"width: 76%;\" class=\"input-xlarge\"><button type=\"submit\" class=\"btn btn-primary\" id=\"chat_send_button\" onClick=\"sendMessage();\"><i class=\"icon-comment icon-white\"></i> Send</button></td><td width=\"0\" height=\"62\"></td></tr>");
		
			 $("#chat_input").keypress(function(event) {
				if ( event.which == 13 ) {
					sendMessage();
					event.preventDefault();
				}
			  });
		}
		if(parseInt(variables['conversation_type'])==2)
		{
			$("#chattable").html("<tr><td width=\"455\" height=\"312\"><div id=\"tabs\"><ul><li id=\"tabli0\"><a href=\"#tabs-0\">Everyone</a></li></ul><div id=\"tabs-0\"><div class=\"control-group\"><div class=\"controls\"> <div id=\"trash0\" class=\"ui-widget-content ui-state-default\" style=\"background-color:white; text-align:left; width: 100%; height: 279px; overflow: auto; font-family:'Verdana'; font-size: 11pt;\">Drag and drop here the information you want to send...</div></div></div></div></div></div></div></td></tr>");
			$(function() {
				var $trash = $( "#trash0");

				// let the trash be droppable, accepting the gallery items
				$trash.droppable({
					accept: "#gallery > li",
					activeClass: "ui-state-highlight",
					drop: function( event, ui ) {
						if($('#trash0').html()=='Drag and drop here the information you want to send...')
							$('#trash0').html('');
						deleteImage( ui.draggable );
					}
				});

				// image deletion function
				var recycle_icon = "";
				function deleteImage( $item ) {
						var $list = $( "ul", $trash ).length ?
						$( "ul", $trash ) :
						$( "<ul class='gallery ui-helper-reset'/>" ).appendTo( $trash );
						$item.find( "a.ui-icon-trash" ).remove();
						//$list.html($list.html()+"<div class='messagesender'>You ("+getName(myid)+"):</div>"+$item.clone().text()+"</br>");
						//clonedItem.append( recycle_icon ).appendTo( $list );
						jQuery("div#trash0").scrollTop(jQuery("div#trash0")[0].scrollHeight);
						this.sharedMessage=$item.text();
						sendMessage();
				}
			});
		}
		this.tabs = $( "#tabs" ).tabs({
			activate: function( event, ui ) {
				if($(ui.newTab).text()=="Everyone")
				{
					if(getCondition()==1)
					{
						setUser(0);
						removeActives();
						$('#0').addClass('active');
					}
					else
					{
						for(var i=1; i<=numPlayers+parseInt(variables["bot_count"]); i++)
							dehighlightCircle(i);
						highlightCircle(0);
					}
					$("#tabli0").css("background-color", "#FFFFFF");
				}
				else
				{
					if(getCondition()==1)
					{
						if($(ui.newTab).text().indexOf("User")>=0)
						{
							setUser(parseInt($(ui.newTab).text().substring(5, 6)));
							removeActives();
							$('#'+$(ui.newTab).text().substring(5, 6)).addClass('active');
						}
					//	if($(ui.newTab).text().indexOf("Bot")>=0)
					//	{
					//		setUser(parseInt($(ui.newTab).text().substring(4, 5))+numPlayers);
					//		removeActives();
					//		$('#'+(parseInt($(ui.newTab).text().substring(4, 5))+numPlayers)).addClass('active');
					//	}
					}
					else
					{
						for(var i=1; i<=numPlayers+parseInt(variables["bot_count"]); i++)
							dehighlightCircle(i);
						if($(ui.newTab).text().indexOf("User")>=0)
							highlightCircle(parseInt($(ui.newTab).text().substring(5, 6)));
					//	if($(ui.newTab).text().indexOf("Bot")>=0)
					//		highlightCircle(parseInt($(ui.newTab).text().substring(4, 5))+numPlayers);
					}
					if($(ui.newTab).text().indexOf("User")>=0)
						$("#tabli"+$(ui.newTab).text().substring(5, 6)).css("background-color", "#FFFFFF");
					//if($(ui.newTab).text().indexOf("Bot")>=0)
					//	$("#tabli"+($(ui.newTab).text().substring(4, 5)+numPlayers)).css("background-color", "#FFFFFF");
				}
			}
		});
		/*this.tabs.find( ".ui-tabs-nav" ).sortable({
			axis: "x",
			stop: function() {
				tabs.tabs( "refresh" );
			}
		});*/
		setupTabs();
	}
}

function setCondition()
{
	this.circleColors=["#FE2E2E", "#FE642E", "#2E64FE", "#642EFE", "#FE2E9A", "#2E2EFE", "#0489B1", "#585858", "#0B610B"];
	
	setEveryoneTab();
	
	if(this.condition==1)
	{
		if(parseInt(variables['chatting_with_everyone'])==1)
			$("#conditiontable").html("<tr><td width=\"150\" rowspan=\"2\" height=\"297\" class=\"myhero-unit\" style=\"border-width:1;\"><div><div class=\"span3\" style=\"width:100%;\"><ul id=\"userlist\" class=\"mynav mynav-list\"\"><li id=\"0\" class=\"active\"><a onClick=\"setUser(0); removeActives(); $('#0').addClass('active'); highlightCircle(0);\"><i class=\"icon-user\"></i>Everyone</a></li></ul></div></div></td></tr>");
		else
			$("#conditiontable").html("<tr><td width=\"150\" rowspan=\"2\" height=\"297\" class=\"myhero-unit\" style=\"border-width:1;\"><div><div class=\"span3\" style=\"width:100%;\"><ul id=\"userlist\" class=\"mynav mynav-list\"\"></ul></div></div></td></tr>");
		$("#conditiontable").css("background-color", "#F2F5A9");
		$("#conditiontable").css("width", 150);
		$("#conditiontabletd").css("width", 150);
		$("#conditiontablespaceleft").css("width", 78);
		$("#conditiontablespaceright").css("width", 78);
		for(var g=1; g<=numPlayers+parseInt(variables["bot_count"]); g++)
		{
			if(g==myid)
				document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a><i class=\"icon-user\"></i>You ("+getName(myid)+")</a></li>");
			else
			{
				if(canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
				{
					if(g<=numPlayers)
						document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a onClick=\"setUser("+g+"); removeActives(); $('#"+g+"').addClass('active'); highlightCircle("+g+");\"><i class=\"icon-user\"></i>"+getName(g)+"</a></li>");
					else
						document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a onClick=\"setUser("+g+"); removeActives(); highlightCircle("+g+");\"><i class=\"icon-user\"></i>User "+(g)+"</a></li>");
				}
				else
				{
					if(g<=numPlayers)
						document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a><i class=\"icon-user\"></i>"+getName(g)+"</a></li>");
					else
						document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a><i class=\"icon-user\"></i>User "+(g)+"</a></li>");
				}
			}
		}
	}
	if(this.condition==2)
	{
		$("#conditiontable").html("<tr><td width=\"300\" height=\"112\" colspan=\"3\"><div id=\"myholder\" align=\"center\"></div></td></tr>");
		drawStaticNetwork();
	}
	if(this.condition==3)
	{
		$("#conditiontable").html("<tr><td width=\"300\" height=\"112\" colspan=\"3\"><div id=\"myholder\" align=\"center\"></div></td></tr>");
		drawDynamicNetwork();
	}
}

function getCondition()
{
	return this.condition;
}

function setShuffledOptions()
{
	//var tarr=this.privateOrder.substring(0, this.privateOrder.indexOf("|")).split(" ");
	//for(var p=0;p<tarr.length;p++)
	//{
	//	if(tarr[p].length==0) continue;
	//	this.shuffledOptions[tarr[p].substring(0, tarr[p].indexOf("="))] = eval("["+tarr[p].substring(tarr[p].indexOf("=")+1)+"]");
	//}
	
	var tarr=this.privateOrder.split("</setup>");
	for(var p=0;p<tarr.length;p++)
	{
		if(tarr[p].length==0) continue;
		if(tarr[p].indexOf("name=")>=0)
			this.shuffledOptions[tarr[p].substring(tarr[p].indexOf("name=")+6, tarr[p].lastIndexOf("\""))]=eval("["+tarr[p].substring(tarr[p].indexOf(">")+1)+"]");
		if(tarr[p].indexOf("<setup type=\"condition\">")>=0)
			this.condition=parseInt(tarr[p].substring(tarr[p].indexOf("<setup type=\"condition\">")+24));
	}
	xmlDoc=loadXMLDoc(getFile("scenario"+variables['scenario_number']+".xml"));
	
	var key;
	for (key in this.clueType)
	{
		for(var i=0; i<xmlDoc.getElementsByTagName("option").length; i++)
		{
			for(var j=0; j<this.shuffledOptions[key].length; j++) // the real opt id is changed with shuffled one i.e. initially opt has id=2, when shuffled [3,4,2,5,1] opt has id=4
			{
				if($.trim(xmlDoc.getElementsByTagName("option")[i].attributes.getNamedItem("type").nodeValue)==key&&parseInt($.trim(xmlDoc.getElementsByTagName("option")[i].attributes.getNamedItem("id").nodeValue))==j+1)
				{
					var larray=new Array();
					larray.push($.trim(xmlDoc.getElementsByTagName("option")[i].childNodes[0].nodeValue));
					larray.push(0);
					//alert($.trim(xmlDoc.getElementsByTagName("option")[i].attributes.getNamedItem("type").nodeValue)+","+this.shuffledOptions[key][j]+" = "+larray)
					this.step3Options[$.trim(xmlDoc.getElementsByTagName("option")[i].attributes.getNamedItem("type").nodeValue)+","+this.shuffledOptions[key][j]]=larray;
				}
			}
		}
	}
	
	this.publicInfo=new Array();
	this.publicImage=new Array();
	for(var j=0; j<xmlDoc.getElementsByTagName("clue").length; j++)
	{
		if($.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("visibility").nodeValue)=="shared")
			this.publicInfo.push(preprocess($.trim(xmlDoc.getElementsByTagName("clue")[j].childNodes[0].nodeValue)));
		if(xmlDoc.getElementsByTagName("clue")[j].getElementsByTagName("picture")[j]!=null&&xmlDoc.getElementsByTagName("clue")[j].getElementsByTagName("picture")[0]!=undefined)
			this.publicImage.push(getFile($.trim(xmlDoc.getElementsByTagName("clue")[j].getElementsByTagName("picture")[0].childNodes[0].nodeValue)));	
	}
}

function setPrivateInfo(myident)
{
	setShuffledOptions();
	setCondition();
	
	var videoName=$.trim(xmlDoc.getElementsByTagName("instructions")[0].childNodes[0].nodeValue);
	var mp4str = '<source src="'+getFile(videoName+".mp4")+'" type="video/mp4">';
	if (jQuery.browser.msie)
	 mp4str = '<source src="'+getFile(videoName+"_ie.mp4")+'" type="video/mp4">';
	$('#VideoHere').append('<video id="HP_video" width="640" height="360" controls autoplay>'+mp4str+'<source src="'+getFile(videoName+".ogg")+'" type="video/ogg">'+'<source src="'+getFile(videoName+".webm")+'" type="video/webm">'+'Your browser does not support video.'+'</video>');
	$("#video_instructions").show();  
	
	this.privateOrder=this.privateOrder.substring(this.privateOrder.indexOf("</setup>", this.privateOrder.indexOf("<setup type=\"condition\">"))+8);

	var tarr=this.privateOrder.split("</setup>");
	
	var publicInfos="";
	this.draggableInfo="<div class=\"ui-widget ui-helper-clearfix\"><ul id=\"gallery\" class=\"gallery ui-helper-reset ui-helper-clearfix\">";
	for(var i =0; i < this.publicInfo.length; i++)
	{
		publicInfos+=("<li>"+this.publicInfo[i]+"</li>");
		draggableInfo+=("<li class=\"ui-widget-content ui-corner-tr\">"+this.publicInfo[i]+"</li>");
	}
	
	this.gameInfo="<pre id=\"descpre\"><ul>"+publicInfos;
	for(var i=0; i<this.publicImage.length; i++)
		this.gameInfo+="<img src=\""+this.publicImage[i]+"\" alt=\"private info picture\">";

	this.privateInfo = new Array();
	for(var p=0;p<tarr.length;p++)
	{
		tarr[p]=tarr[p].substring(tarr[p].indexOf(">")+1)+"-";
		var tarr2=tarr[p].split("-");
		for(var m=0;m<tarr2.length;m++)
		{
			if(tarr2[m].length==0) continue;

			var pi1="";
			var img1="";
			
			for(var j=0; j<xmlDoc.getElementsByTagName("clue").length; j++)
			{
				if($.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("visibility").nodeValue)=="private"&&tarr2[m].split(",")[0]==$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("type").nodeValue))
				{
					//alert(tarr2[m].split(",")[0]+"=="+$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("type").nodeValue)+" sonuc: "+(tarr2[m].split(",")[0]==$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("type").nodeValue))+" ve "+tarr2[m].split(",")[1]+"=="+$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("id").nodeValue)+" sonuc: "+(tarr2[m].split(",")[1]==$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("id").nodeValue)))
					if(tarr2[m].split(",")[1]==$.trim(xmlDoc.getElementsByTagName("clue")[j].attributes.getNamedItem("id").nodeValue))
					{
						pi1=preprocess($.trim(xmlDoc.getElementsByTagName("clue")[j].childNodes[0].nodeValue));
						if(xmlDoc.getElementsByTagName("clue")[j].getElementsByTagName("picture")[0]!=undefined&&xmlDoc.getElementsByTagName("clue")[j].getElementsByTagName("picture")[0].childNodes[0]!=null)
							img1=$.trim(xmlDoc.getElementsByTagName("clue")[j].getElementsByTagName("picture")[0].childNodes[0].nodeValue);
						break;
					}
				}
			}
			if(this.privateInfo[p]==undefined||this.privateInfo[p]==null||this.privateInfo[p].length==0)
				this.privateInfo[p]=new Array();
			this.privateInfo[p].push(pi1);
			if(p+1==myident)
			{
				this.gameInfo+="<li>"+pi1+"</li>";
				this.draggableInfo+=("<li class=\"ui-widget-content ui-corner-tr\">"+pi1+"</li>");
					
				if(img1!="" && img1!=null && img1 != undefined)
					this.gameInfo+="<img src=\""+img1+"\" alt=\"private info picture\">";
			}
		}
	}
	this.gameInfo+="</ul></pre>";
	this.draggableInfo+="</ul></div>";
	$("#desc").html(this.gameInfo);
	countDownInstructions();
}

function countDownInstructions(){  
	 if (this.InstructionsTimer <=0){ 
		clearTimeout(this.timeoutInst);
		if($.trim($('#readyp').html())!='Please wait for others...')
			submit('Ready');
	 }else{  
		this.InstructionsTimer--;
		document.getElementById("insttimer").innerHTML = this.InstructionsTimer+" seconds remaining"; 
		this.timeoutInst=setTimeout("countDownInstructions()", 1000);
	 }  
} 

function loadXMLDoc(dname)
{
	if (window.XMLHttpRequest)
	{
		xhttp=new XMLHttpRequest();
	}
	else
	{
		xhttp=new ActiveXObject("Microsoft.XMLHTTP");
	}
	xhttp.open("GET",dname,false);
	xhttp.send();
	return xhttp.responseXML;
}

function parseSurveyXML()
{
	xmlDoc=loadXMLDoc(getFile("surveytemplate.xml"));
	title = $.trim(xmlDoc.getElementsByTagName("title")[0].childNodes[0].nodeValue);
	introtext = $.trim(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("text")[0].childNodes[0].nodeValue);
	if(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=null&&xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=undefined)
		intropic = getFile($.trim(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0].childNodes[0].nodeValue));
	for(var i = 0; i < xmlDoc.getElementsByTagName("question").length; i++)
	{
		var question = new Array();
		question.push($.trim(xmlDoc.getElementsByTagName("question")[i].attributes.getNamedItem("type").nodeValue)); // question type

		var text, picture, video;
		var choices = new Array();
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("text").length>0)
			text = $.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("text")[0].childNodes[0].nodeValue);
		else
			text = "";
		question.push(text);
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("picture").length>0)
			picture = getFile($.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("picture")[0].childNodes[0].nodeValue));
		else
			picture = "";
		question.push(picture);
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("video").length>0)
			video = getFile($.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("video")[0].childNodes[0].nodeValue));
		else
			video = "";
		question.push(video);
		
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("choice").length>0)
		{
			for(var j = 0; j < xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("choice").length; j++)
				choices.push($.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("choice")[j].childNodes[0].nodeValue));
		}
		question.push(choices);
		questions.push(question);
	}
	strictness = $.trim(xmlDoc.getElementsByTagName("survey")[0].attributes.getNamedItem("strict").nodeValue);
	if(strictness==null)
		strictness = "false";
}

function nextSurveyQuestion()
{
	if(questions[currentQuestion][4].length>0&&questions[currentQuestion][0]=="likert-custom"||questions[currentQuestion][0]=="likert"||questions[currentQuestion][0]=="players-all"||questions[currentQuestion][0]=="players-selfexclude")
	{
		if(strictness=="true")
		{
			if($("input:radio[name='survrad']:checked").val()==undefined)
			{
				alert("Please select an option before proceeding!");
				return;
			}
		}
		surveySelections[currentQuestion]=$("input:radio[name='survrad']:checked").val();
	}
	else if(questions[currentQuestion][0]=="likert-players-selfexclude")
	{
		var chstr="";
		if(strictness=="true")
		{
			for(var k=1; k<=numPlayers+parseInt(variables["bot_count"]); k++)
			{
				if(k!=myid)
				{
					if($("input:radio[name='likertrad"+k+"']:checked").val()==undefined)
					{
						if(k<=numPlayers)
							alert("Please select an option for "+getName(k)+" before proceeding!");
						else
							alert("Please select an option for User"+(k)+" before proceeding!");
						return;
					}
					else
						chstr+=(", "+$("input:radio[name='likertrad"+k+"']:checked").val());
				}
			}
		}
		surveySelections[currentQuestion]=chstr;
	}
	else if(questions[currentQuestion][4].length>0&&questions[currentQuestion][0]=="multiple")
	{
		if(strictness=="true")
		{
			if($("input:checkbox[name='survchck']:checked").val()==undefined)
			{
				alert("Please select an option before proceeding!");
				return;
			}
		}
		var allVals = [];
		$(':checkbox:checked').each(function() {
			allVals.push($(this).val());
		});
		var mytempstr="";
		for(var z=0; z<allVals.length; z++)
			mytempstr+=(allVals[z]+" ");
		surveySelections[currentQuestion]=mytempstr;
	}
	
	currentQuestion++;
	if(currentQuestion<questions.length)
		displaySurveyQuestion(currentQuestion);
	else
	{
		$("#prevsurveybut").hide();
		$("#nextsurveybut").hide();
		for(var z=0; z<surveySelections.length; z++)
		{
			if(surveySelections[z]!=null&&surveySelections[z]!=undefined)
			{
				submit("<answer no=\""+(z+1)+"\">"+surveySelections[z]+"</answer>");
				setRound(4+this.numOfBotSchedule+parseInt(variables['total_rounds'])+z);
			}
		}
		$("#surveytitle").html('');
		$("#surveyimage").html('');
		$("#surveytext").html('');
		document.getElementById("rbFormSurv").innerHTML="";
		$("#likertplayerstable").html("");
		$("#surveytext").html("Thank you for completing the survey. Click <a href=\"/stop_test/\" onclick='stopPinging();'>HERE</a> to quit the experiment...");
	}
}

function prevSurveyQuestion()
{
	if(questions[currentQuestion][0]=="likert-custom"||questions[currentQuestion][0]=="likert"||questions[currentQuestion][0]=="players-all"||questions[currentQuestion][0]=="players-selfexclude")
		surveySelections[currentQuestion]=$("input:radio[name='survrad']:checked").val();
	if(questions[currentQuestion][0]=="multiple")
		surveySelections[currentQuestion]=$("input:checkbox[name='survchck']:checked").val();
	currentQuestion--;
	displaySurveyQuestion(currentQuestion);
}

function startSurvey()
{
	parseSurveyXML();
	$('#endgamesurvey').show();
	$("#prevsurveybut").hide();
	$("#nextsurveybut").hide();
	$("#rbFormSurv").hide();
	$("#surveytitle").html(title);
	if(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=null&&xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=undefined)
		$("#surveyimage").html("<img src=\""+intropic+"\" alt=\"intro picture\">");
	if(intropic=undefined||intropic==null||intropic=="")
		$('#surveyimagerow').hide();
	$("#surveytext").html(introtext);
}

function displaySurveyQuestion(qNum)
{
	$("#surveytitle").html('');
	$("#surveyimage").html('');
	$("#surveytext").html('');
	document.getElementById("rbFormSurv").innerHTML="";
	
	$("#surveytext").html(questions[qNum][1]);
	if(questions[qNum][2]!="")
		$("#surveyimage").html("<img src=\""+questions[qNum][2]+"\" alt=\"question picture\">");
	if(questions[qNum][3]!="")
		$("#surveyimage").html("<video width=\"320\" height=\"240\" controls><source src=\""+questions[qNum][3]+".mp4\" type=\"video/mp4\"><source src=\""+questions[qNum][3]+".ogg\" type=\"video/ogg\">Your browser does not support the video tag.</video>");	

	if(questions[qNum][0]=="likert")
	{
		$("#rbFormSurv").show();
		$("#likertplayerstable").hide();
		document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\"Disagree strongly\">Disagree strongly<br><input type=\"radio\" name=\"survrad\" value=\"Disagree moderately\">Disagree moderately<br><input type=\"radio\" name=\"survrad\" value=\"Disagree a little\">Disagree a little<br><input type=\"radio\" name=\"survrad\" value=\"Neither agree nor disagree\">Neither agree nor disagree<br><input type=\"radio\" name=\"survrad\" value=\"Agree a little\">Agree a little<br><input type=\"radio\" name=\"survrad\" value=\"Agree moderately\">Agree moderately<br><input type=\"radio\" name=\"survrad\" value=\"Agree strongly\">Agree strongly<br>");
	}
	if(questions[qNum][0]=="likert-custom")
	{
		$("#rbFormSurv").show();
		$("#likertplayerstable").hide();
		for(var k=0; k<questions[qNum][4].length; k++)
			document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\""+questions[qNum][4][k]+"\">"+questions[qNum][4][k]+"<br>");
	}
	if(questions[qNum][0]=="multiple")
	{
		$("#rbFormSurv").show();
		$("#likertplayerstable").hide();
		for(var k=0; k<questions[qNum][4].length; k++)
			document.getElementById("rbFormSurv").innerHTML+=("<input type=\"checkbox\" name=\"survchck\" value=\""+questions[qNum][4][k]+"\">"+questions[qNum][4][k]+"<br>");
	}
	if(questions[qNum][0]=="players-selfexclude")
	{
		$("#rbFormSurv").show();
		$("#likertplayerstable").hide();
		for(var k=1; k<=numPlayers+parseInt(variables["bot_count"]); k++)
		{
			if(k!=myid)
			{
				if(k<=numPlayers)
					document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\""+getName(k)+"\">"+getName(k)+"<br>");
				else
					document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\"User "+(k)+"\">User "+(k)+"<br>");
			}
		}
	}
	if(questions[qNum][0]=="players-all")
	{
		$("#rbFormSurv").show();
		$("#likertplayerstable").hide();
		for(var k=1; k<=numPlayers+parseInt(variables["bot_count"]); k++)
		{
			if(k<=numPlayers)
				document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\""+getName(k)+"\">"+getName(k)+"<br>");
			else
				document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\"User "+(k)+"\">User "+(k)+"<br>");
		}
	}
	if(questions[qNum][0]=="likert-players-selfexclude")
	{
		$("#rbFormSurv").hide();
		$("#likertplayerstable").show();
		$("#likertplayerstable").html("<tr><td width=\"97\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><b><font color=\"white\"><span style=\"font-size:10pt;\">Teammate</span></font></b></p></td><td width=\"97\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><i><font color=\"white\"><span style=\"font-size:10pt;\">Not at all</span></font></i></p></td><td width=\"97\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><span style=\"font-size:10pt;\"><i>&nbsp;</i></span></p></td><td width=\"97\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><i><font color=\"white\"><span style=\"font-size:10pt;\">To Some Extent</span></font></i></p></td><td width=\"97\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><span style=\"font-size:10pt;\"><i>&nbsp;</i></span></p></td><td width=\"104\" height=\"23\" bgcolor=\"black\"><p align=\"center\"><i><font color=\"white\"><span style=\"font-size:10pt;\">A Great Deal</span></font></i></p></td></tr>");
		for(var k=1; k<=numPlayers+parseInt(variables["bot_count"]); k++)
		{
			if(k!=myid)
			{
				if(k<=numPlayers)
					$("#likertplayerstable").html($("#likertplayerstable").html()+"<tr><form id=\"likertplayerform"+k+"\"><td width=\"97\"><p align=\"center\" id=\"likertusername\">"+getName(k)+"</p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\""+getName(k)+"-1\"><br></p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\""+getName(k)+"-2\"><br></p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\""+getName(k)+"-3\"><br></p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\""+getName(k)+"-4\"><br></p></td><td width=\"104\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\""+getName(k)+"-5\"><br></p></td></form></tr>");
				else
					$("#likertplayerstable").html($("#likertplayerstable").html()+"<tr><form id=\"likertplayerform"+k+"\"><td width=\"97\"><p align=\"center\" id=\"likertusername\">User "+(k)+"</p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\"User "+(k)+"-1\"><br></p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\"User "+(k)+"-2\"><br></p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\"User "+(k)+"-3\"><br></p></td><td width=\"97\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\"User "+(k)+"-4\"><br></p></td><td width=\"104\"><p align=\"center\"><input type=\"radio\" name=\"likertrad"+k+"\" value=\"User "+(k)+"-5\"><br></p></td></form></tr>");
			}
		}
		$("#likertplayerstable").html($("#likertplayerstable").html()+"</table>");
	}
	
	if(qNum>0)
		$("#prevsurveybut").show();
	else
		$("#prevsurveybut").hide();
		
	if(qNum<questions.length)
		$("#nextsurveybut").show();
	else
		$("#nextsurveybut").hide();
}

function newMove(participant, index) {
  fetchMove(participant, currentRound, index, function(val) {
	if(currentRound==2&&this.readyCount<numPlayers)
	{
		if(val=='Ready')
			this.readyCount++
		if(this.readyCount==numPlayers)
		{
			clearTimeout(this.timeoutInst);
			$("#HP_video").get(0).pause();
			countDownStep1();
			$("#helpinfo").show();
			$("#helpinfotable").css("width", 800);
			$("#comch").hide();
			$("#pbar").show();
			$("#pubinfo").show();
			$("#ttl").show();
			$("#gameinstructions").hide();
			setRound(3);
		}
		return;
	}
	if(parseInt(variables["bot_behavior"])==2&&(val.indexOf("<botSchedule>")>=0||val.indexOf("Waiting for schedule")>=0))
	{
		this.numOfWaitingSchedule++;
		if(val.indexOf("<botSchedule>")>=0)
		{
			this.botSchedule=eval(val.substring(13,val.length-14));
			this.numOfBotSchedule++;
		}
		if(this.numOfWaitingSchedule==numPlayers+parseInt(variables["bot_count"]))
		{
			setRound(currentRound+1);
			this.numOfWaitingSchedule=0;
			loadStep2();
		}
		return;
	}
	if(currentRound>=3+this.numOfBotSchedule&&this.currentDiscRound<=parseInt(variables['total_rounds'])&&val.indexOf("</vote>")>=0)
	{
		val=val.substring(0, val.indexOf('<confidence>'));
		var tarr=val.split("</vote>");
		for(var p=0;p<tarr.length;p++)
		{
			if(tarr[p].length==0)continue;
			if(parseInt(variables['feedback_type'])==1)
				this.step3Options[tarr[p].substring(tarr[p].indexOf("name=\"")+6, tarr[p].indexOf("\">", tarr[p].indexOf("name=\"")+6))+","+tarr[p].substring(tarr[p].indexOf(">")+1)][1]++;
			if(parseInt(variables['feedback_type'])==2&&participant==myid)
				this.step3Options[tarr[p].substring(tarr[p].indexOf("name=\"")+6, tarr[p].indexOf("\">", tarr[p].indexOf("name=\"")+6))+","+tarr[p].substring(tarr[p].indexOf(">")+1)][1]++;
		}
		var foundPt=false;
		for(var v=0; v<this.endGameResultsArr.length; v++)
			if(this.endGameResultsArr[v]==participant)
				foundPt=true;
		if(!foundPt)		
			this.endGameResultsArr.push(participant);
		if(this.endGameResultsArr.length==numPlayers+parseInt(variables["bot_count"]))
		{
			this.endGameResultsArr=new Array();
			if(parseInt(variables["allow_feedback"])==1)
			{
				if(parseInt(variables['feedback_type'])==1)
				{
					var arrkey;
					for (arrkey in this.clueType)
					{
						var labels = new Array();
						var values = new Array();
						var correctCount=0;
						var wrongCount=0;
						
						for(var y=1; y<=this.clueType[arrkey]; y++)
						{
							if(step3Options[arrkey+","+y][1]>0)
							{
								for(var j=0; j<xmlDoc.getElementsByTagName("option").length; j++)
								{
									if($.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)==arrkey&&y==$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("id").nodeValue))
									{
										if($.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("answer").nodeValue)=="true")
											correctCount+=step3Options[arrkey+","+y][1];
										else
											wrongCount+=step3Options[arrkey+","+y][1];
									}
								}
							}
						}
						
						labels.push("%%.%% - Correct");
						values.push(correctCount);
						labels.push("%%.%% - Wrong");
						values.push(wrongCount);
						
						if(values[0]==0)
						{
							values.splice(0, 1);
							labels.splice(0, 1);
						}
						if(values[1]==0)
						{
							values.splice(1, 1);
							labels.splice(1, 1);
						}

						$("#chart_div"+arrkey).css({'width':'150px;'});
						$("#chart_div"+arrkey).css({'height':'250px;'});
						$("#feed0").html("Feedback on the team's performance appears below.");
						var r = Raphael("chart_div"+arrkey),
						pie = r.piechart(190, 75, 50, values, { legend: labels, legendpos: "west"});
						r.text(90, 20, "Accuracy results for "+arrkey).attr({ font: "10px sans-serif" });
						pie.hover(function () {
							this.sector.stop();
							this.sector.scale(1.1, 1.1, this.cx, this.cy);

							if (this.label) {
								this.label[0].stop();
								this.label[0].attr({ r: 7.5 });
								this.label[1].attr({ "font-weight": 800 });
							}
						}, function () {
							this.sector.animate({ transform: 's1 1 ' + this.cx + ' ' + this.cy }, 500, "bounce");

							if (this.label) {
								this.label[0].animate({ r: 5 }, 500, "bounce");
								this.label[1].attr({ "font-weight": 400 });
							}
						});
					}
				}
				if(parseInt(variables['feedback_type'])==2)
				{
					var correctCount=0;
					var wrongCount=0;
					var arrkey;
					for (arrkey in this.clueType)
					{
						for(var y=1; y<=this.clueType[arrkey]; y++)
						{
							if(step3Options[arrkey+","+y][1]>0)
							{
								for(var j=0; j<xmlDoc.getElementsByTagName("option").length; j++)
								{
									if($.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("type").nodeValue)==arrkey&&y==$.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("id").nodeValue))
									{
										if($.trim(xmlDoc.getElementsByTagName("option")[j].attributes.getNamedItem("answer").nodeValue)=="true")
											correctCount+=step3Options[arrkey+","+y][1];
										else
											wrongCount+=step3Options[arrkey+","+y][1];
									}
								}
							}
						}
					}	
					var labels = new Array();
					var values = new Array();
					labels.push("%%.%% - Correct");
					values.push(correctCount);
					labels.push("%%.%% - Wrong");
					values.push(wrongCount);
					
					if(values[0]==0)
					{
						values.splice(0, 1);
						labels.splice(0, 1);
					}
					if(values[1]==0)
					{
						values.splice(1, 1);
						labels.splice(1, 1);
					}

					$("#chart_divindividual").css({'width':'150px;'});
					$("#chart_divindividual").css({'height':'250px;'});
					$("#feedindividual").html("Feedback on your performance appears below.");
					var r = Raphael("chart_divindividual"),
					pie = r.piechart(190, 75, 50, values, { legend: labels, legendpos: "west"});
					r.text(90, 20, "Accuracy results of your choices").attr({ font: "10px sans-serif" });
					pie.hover(function () {
						this.sector.stop();
						this.sector.scale(1.1, 1.1, this.cx, this.cy);

						if (this.label) {
							this.label[0].stop();
							this.label[0].attr({ r: 7.5 });
							this.label[1].attr({ "font-weight": 800 });
						}
					}, function () {
						this.sector.animate({ transform: 's1 1 ' + this.cx + ' ' + this.cy }, 500, "bounce");

						if (this.label) {
							this.label[0].animate({ r: 5 }, 500, "bounce");
							this.label[1].attr({ "font-weight": 400 });
						}
					});
				}
			}
			if(this.currentDiscRound<parseInt(variables['total_rounds']))
			{
				document.getElementById("submitStatus").innerHTML="<p align='center'><font color=\"blue\">Next round is about to begin...</font></p>";
				countDownNextRound();
			}
			else
			{
				document.getElementById("submitStatus").innerHTML="<p align='center'><font color=\"blue\">You will now be redirected to end game survey...</font></p>";
				countDownEndGame();
			}
			$("#pbar").show();
			setRound(3+this.currentDiscRound+this.numOfBotSchedule);
			this.currentDiscRound++;
		}
	}
	if(currentRound==1)
	{
		this.privateOrder=val;
		setPrivateInfo(myid);
		setRound(2);
	}
  });
}

// implement playerDisconnect():
function playerDisconnect(playerNum) {
  // see if I have the lowest live id
	for (var i = 1; i < myid; i++) 
	{
		if (activePlayers[i])
			return;
	}
	iControlBots = true;
}

function loadStep2()
{
	$("#pubcontainer").css({'width': '490px'});
	$("#desc").hide();
	$("#stepgoal").hide();
	$("#helpinfo").show();
	$("#helpinfotable").css("width", 817);
	$("#comch").show();
	
	if(this.currentDiscRound==null||this.currentDiscRound==undefined)
		this.currentDiscRound=1;
	$("#step1").hide();  
	$("#step3").hide();
	$("#step2").show();
	$("#notearea").val($("#noteareavoting").val());
	
	if(Math.round(parseInt(variables['Step2Timer'])/60) == 1)
	{
		if((parseInt(variables['Step2Timer'])%60)!=0)
			document.getElementById("timetext").innerHTML="You have "+Math.round((parseInt(variables['Step2Timer'])/60))+" minute and "+((parseInt(variables['Step2Timer'])%60))+" seconds to chat with your teammates. Your goal is to identify correct ";
		else
			document.getElementById("timetext").innerHTML="You have "+Math.round((parseInt(variables['Step2Timer'])/60))+" minute to chat with your teammates. Your goal is to identify correct ";
	}
	else if(Math.round(parseInt(variables['Step2Timer'])/60) >= 2)
	{
		if((parseInt(variables['Step2Timer'])%60)!=0)
			document.getElementById("timetext").innerHTML="You have "+Math.round((parseInt(variables['Step2Timer'])/60))+" minutes and "+((parseInt(variables['Step2Timer'])%60))+" seconds to chat with your teammates. Your goal is to identify correct ";
		else
			document.getElementById("timetext").innerHTML="You have "+Math.round((parseInt(variables['Step2Timer'])/60))+" minutes to chat with your teammates. Your goal is to identify correct ";
	}
	else
		document.getElementById("timetext").innerHTML="You have "+parseInt(variables['Step2Timer'])+" seconds to chat with your teammates. Your goal is to identify correct ";
	var arrkey;
	var size=0;
	for (arrkey in this.clueType)
		size++;
	var currentcount=0;
	for (arrkey in this.clueType)
	{
		if(currentcount==0)
			$("#timetext").html($("#timetext").html()+" "+arrkey)
		else if(currentcount==size-1)
			$("#timetext").html($("#timetext").html()+" and "+arrkey)
		else
			$("#timetext").html($("#timetext").html()+", "+arrkey)
		currentcount++;
	}
	$("#pbarrow").show();
	$("#pbarrow").html("<td width=\"77\"><p align=\"right\" style=\"font-family:'Verdana';font-size:15pt;\">Round:</p></td><td width=\"89\"><p style=\"font-family:'Verdana';font-size:15pt;\"><font color=\"red\" id=\"roundtext\">"+this.currentDiscRound+" of "+variables['total_rounds']+"</font></p></td><td width=\"440\"></td><td width=\"118\"><p align=\"right\" style=\"font-family:'Verdana';font-size:15pt;\">Time Left:</p></td><td width=\"54\"><p style=\"font-family:'Verdana';font-size:15pt;\"><font color=\"red\" id=\"timer\"></font></p></td>");
	
	$("#ttl").show();
	$("#timer").show();
	$("#tlefttext").show();
	
	countDownStep2();
}

function setSchedule()
{
	if(parseInt(variables['conversation_type'])==1)
	{
		$("#pubcontainer").html(this.gameInfo);
		loadStep2();
	}
	if(parseInt(variables['conversation_type'])==2)
	{
		$("#pubcontainer").html(this.draggableInfo);
		$(function() {
			var $gallery = $( "#gallery" );

			// let the gallery items be draggable
			$( "li", $gallery ).draggable({
				cancel: "a.ui-icon", // clicking an icon won't initiate dragging
				revert: "invalid", // when not dropped, the item will revert back to its initial position
				containment: "document",
				cursor: "move",
				helper: "clone",
				start: function(event, ui) {
					//if(jQuery.browser.webkit) ui.position.top -= $(window).scrollTop();
				},
				drag: function(event, ui) {
					//if(jQuery.browser.webkit) ui.position.top -= $(window).scrollTop();
				}
			});

			// resolve the icons behavior with event delegation
			$( "ul.gallery > li" ).click(function( event ) {
				var $item = $( this ),
				$target = $( event.target );
				if ( $target.is( "a.ui-icon-trash" ) ) {
					deleteImage( $item );
				} 
				return false;
			});
		});
		$("#adjustableNotesWidth").css({ 'width': '0px'});
		
		if(parseInt(variables["bot_behavior"])==2 && myid==1)
		{
			this.botSchedule=new Array();
			for(var g=1; g<=parseInt(variables["bot_count"]); g++)
			{
				var chatAmount = parseInt(variables['chat_amount']);
				this.botSchedule[g-1] = new Array();
				for(var h=1; h<=chatAmount; h++)
				{
					this.botSchedule[g-1].push("[\""+(Math.floor(Math.random()*parseInt(variables['Step2Timer']))+1)+"\"");
					this.botSchedule[g-1].push("\""+(numPlayers+g)+"\"");
					this.botSchedule[g-1].push("\""+(Math.floor(Math.random()*(numPlayers+g))+1)+"\"");
					var fnd=false;
					var botMsg="";
					do{	
						if(variables['bot_type']==1)//random private
							botMsg=this.privateInfo[numPlayers+g-1][Math.floor(Math.random()*this.privateInfo[numPlayers+g-1].length)];
						if(variables['bot_type']==2)//random public
							botMsg=this.publicInfo[Math.floor(Math.random()*this.publicInfo.length)];
						if(variables['bot_type']==3)//totally random
						{
							if(Math.floor(Math.random()*2)+1==1) // private
								botMsg=this.privateInfo[numPlayers+g-1][Math.floor(Math.random()*this.privateInfo[numPlayers+g-1].length)];
							else
								botMsg=this.publicInfo[Math.floor(Math.random()*this.publicInfo.length)];
						}
						fnd=false;
						for(var hh=3; hh<this.botSchedule[g-1].length; hh+=4)
						{
							if(this.botSchedule[g-1][hh]==("\""+botMsg+"\"]"))
								fnd=true;
						}
					}while(fnd);
					this.botSchedule[g-1].push("\""+botMsg+"\"]");
				}
				this.botSchedule[g-1][0]="["+this.botSchedule[g-1][0];
				this.botSchedule[g-1][this.botSchedule[g-1].length-1]=this.botSchedule[g-1][this.botSchedule[g-1].length-1]+"]";
			}
			
			for(var m=1; m<=parseInt(variables["bot_count"]); m++)
				submitBot(numPlayers+m, currentRound, "Waiting for schedule");
			
			submit("<botSchedule>["+this.botSchedule+"]</botSchedule>")
		}
		if(parseInt(variables["bot_behavior"])==2 && myid!=1)
			submit("Waiting for schedule");
			
		if(parseInt(variables["bot_behavior"])==1)
			loadStep2();
	}
}

function loadStep3()
{
	$("#desc").html(this.gameInfo);
	$("#hpnotesvoting").show();
	$("#noteareavoting").val($("#notearea").val());
	$("#step1").hide();
	$("#step2").hide();  
	$("#pbar").hide();
	$("#step3").show();
	this.myanswer="";
	$("#pubinfo").css({ 'width': '480px'});
	$("#pubinfo").show();
	$("#desc").show();
	$("#endgameresults").hide();
	setEnableRadioGroups(false);
	document.getElementById("stepgoal").innerHTML="Please make your final decision at this step.";
	document.getElementById("timetext").innerHTML="";
	$("#helpinfo").hide();
	$("#step3").html($("#step3").html()+"<tr><td colspan=\"5\"><table id=\"howconftable\" border=\"0\" width=\"456\" style=\"margin-left: auto; margin-right: auto;\"><tr><td width=\"450\"><p>How confident are you that the answers you selected are correct?</p></td></tr><tr><td width=\"450\"><input type=\"radio\" name=\"howconf\" value=\"Very Confident\">Very Confident<br><input type=\"radio\" name=\"howconf\" value=\"Somewhat Confident\">Somewhat Confident<br><input type=\"radio\" name=\"howconf\" value=\"Neither Confident nor Unsure\">Neither Confident nor Unsure<br><input type=\"radio\" name=\"howconf\" value=\"Somewhat Unsure\">Somewhat Unsure<br><input type=\"radio\" name=\"howconf\" value=\"Very Unsure\">Very Unsure<br></td></tr><tr><td width=\"450\"><p align=\"center\"><button id='subconfbut' type=\"submit\" class=\"btn btn-primary\" onClick=\"submitDecision();\"><i class=\"icon-ok icon-white\"></i> Submit</button></p></td></tr></table></td></tr>");
	var arrkey;
	var currcount=0;
	for (arrkey in this.clueType)
	{
		if(parseInt(variables["allow_feedback"])==1)
		{
			$("#step3").html($("#step3").html()+"<tr id=\""+arrkey+"_row1\"><td width=\"120\" height=\"30\"></td><td width=\"220\" height=\"30\" class=\"myfont\" id=\"dectext"+arrkey+"\"></td><td width=\"131\"></td><td width=\"311\" id=\"feed"+currcount+"\"></td><td width=\"2\"></td></tr><tr height=\"150\" id=\""+arrkey+"_row2\"><td width=\"120\"></td><td width=\"220\"></td><td width=\"131\"><form id=\"rbForm"+arrkey+"\"></form></td><td width=\"311\"><div id='chart_div"+arrkey+"' style='height:150px; width:250px; margin-left: auto; margin-right: auto;'></div></td><td width=\"2\"></td></tr>");
			currcount++;
		}
		else
			$("#step3").html($("#step3").html()+"<tr id=\""+arrkey+"_row1\"><td width=\"120\" height=\"30\"></td><td width=\"220\" height=\"30\" class=\"myfont\" id=\"dectext"+arrkey+"\"></td></td><td width=\"131\"></td><td width=\"250\"></td><td width=\"22\"></td></tr><tr height=\"150\" id=\""+arrkey+"_row2\"><td width=\"120\"></td><td width=\"231\"></td><td width=\"161\"><form id=\"rbForm"+arrkey+"\"></form></td><td width=\"250\"></td><td width=\"22\"></td></tr><tr><td width=\"120\"></td><td width=\"231\" height=\"5\"></td><td width=\"161\" height=\"5\"></td><td width=\"250\"></td><td width=\"22\"></td></tr>");
	}
	$("#step3").html($("#step3").html()+"<tr><td width=\"120\" height=\"41\"></td><td width=\"220\" height=\"41\"></td><td width=\"131\" height=\"41\"><p align=\"center\"><button id='subdecbut' type=\"submit\" class=\"btn btn-primary\" onClick=\"showConfidence();\"><i class=\"icon-ok icon-white\"></i> Submit</button></p></td><td width=\"311\" height=\"41\"></td></tr><tr><td width=\"809\" colspan=\"5\"><p id=\"errorStatus\" align=\"center\">&nbsp;</p></td></tr>");
	$("#subdecbut").show();
	if(parseInt(variables["feedback_type"])==2)
	{
		$("#step3").html($("#step3").html()+"<tr><td colspan=\"5\"><table style='height:150px; width:350px; margin-left: auto; margin-right: auto;'><tr><td width=\"350\" id=\"feedindividual\"></td></tr><tr height=\"150\"><td width=\"350\"><div id='chart_divindividual' style='height:150px; width:250px; margin-left: auto; margin-right: auto;'></div></td></tr></table></td></tr>");
	}
	for (arrkey in this.clueType)
	{
		$("#dectext"+arrkey).html("The "+arrkey+":");

		for(var m=1; m<=this.shuffledOptions[arrkey].length; m++)
		{
			for(var k=1; k<=this.clueType[arrkey]; k++)
			{
				if(k==this.shuffledOptions[arrkey][m-1])
					document.getElementById("rbForm"+arrkey).innerHTML+=("<input type=\"radio\" name=\"findec"+arrkey+"\" value=\""+arrkey+","+k+"\">"+step3Options[arrkey+","+k][0]+"<br>");
			}
		}
	}
	$("#howconftable").hide();
}

function countDownEndGame(){  
	 if (this.EndGameTimer <=0){  
		$("#pbar").hide();
		$("#step3").hide();
		$("#hpnotesvoting").hide();
		$("#pubinfo").hide();
		$("#helpinfo").hide();
		$("#ttl").hide();
		startSurvey();
	 }else{  
		this.EndGameTimer--;
		document.getElementById("timer").innerHTML = this.EndGameTimer;  
		setTimeout("countDownEndGame()", 1000);
	 }  
}

function countDownNextRound(){  
	 if (this.NextRoundTimer <=0){  
		$("#step3").hide();
		$("#pubinfo").hide();
		$("#hpnotesvoting").hide();
		$("#ttl").hide();
		$("#timer").hide();
		$("#tlefttext").hide();
		$("#pbarrow").hide();
		this.Step2Timer=parseInt(variables['Step2Timer']+"")+1;
		$("#step3").html("<tr><td width=\"798\" colspan=\"5\" id=\"submitStatus\"></td></tr><tr><td width=\"792\" height=\"20\" colspan=\"3\"><p id=\"basedonthe\">Based on the information you have gathered, identify: </p></td></tr>");
		this.NextRoundTimer=parseInt(variables['round_interval_timer']+"")+1;
		var arrkey;
		for (arrkey in this.clueType)
			for (var h=1; h<=this.clueType[arrkey]; h++)
				step3Options[arrkey+","+h][1]=0;
		setSchedule();
		if(parseInt(variables['chatting_with_everyone'])==1)
			setEveryoneTab();
		else
			$("#chattable").html("<tr><td width=\"455\" height=\"156\"></td></tr><tr><td width=\"455\" height=\"171\"><div style=\"text-align: center; vertical-align:middle; width: 100%; height: 100%; font-family:'Verdana'; font-size: 12pt;\">Please click on a user to start conversation...</div></td></tr>");
	 }else{  
		this.NextRoundTimer--;
		document.getElementById("timer").innerHTML = this.NextRoundTimer;  
		setTimeout("countDownNextRound()", 1000);
	 }  
}  

function countDownStep2(){ 
	for(var g=1; g<=parseInt(variables["bot_count"])&&parseInt(variables["bot_behavior"])==2; g++)
	{
		for(j=0; j<parseInt(variables["chat_amount"]); j++) 
		{
			if(this.Step2Timer==parseInt(this.botSchedule[g-1][j][0]))
			{
				if(myid==parseInt(this.botSchedule[g-1][j][2]))
				{
					if($("#chattable").html().indexOf("tabs-"+this.botSchedule[g-1][j][1])==-1)
						addTab("User "+(parseInt(this.botSchedule[g-1][j][1])), parseInt(this.botSchedule[g-1][j][1]));	
					else
						this.tabs.tabs("option", "active", $('#tabs-'+this.botSchedule[g-1][j][1]).tabIndex());
					
					if($('#trash'+this.botSchedule[g-1][j][1]).html()=='Drag and drop here the information you want to send...')
						$('#trash'+this.botSchedule[g-1][j][1]).html('');
					if(getCondition()==1)
					{
						setUser(parseInt(this.botSchedule[g-1][j][1]));
						removeActives();
						$('#'+this.botSchedule[g-1][j][1]).addClass('active');
					}
					$('#trash'+this.botSchedule[g-1][j][1]).append("<div class='messagereceiver'>User "+(this.botSchedule[g-1][j][1])+":</div><div class='receivedmessage'>&nbsp;"+this.botSchedule[g-1][j][3]+"</div>");
					jQuery("div#trash"+this.botSchedule[g-1][j][1]).scrollTop(jQuery("div#trash"+this.botSchedule[g-1][j][1])[0].scrollHeight);
				}
				if(parseInt(variables["bot_behavior"])==2)
				{
					if(getCondition()!=1)
					{
						var path = new Object();
						path.line = this.r.path("M "+xVals[parseInt(this.botSchedule[g-1][j][1])-1]+" "+this.yVals[parseInt(this.botSchedule[g-1][j][1])-1]+" l "+(this.xVals[parseInt(this.botSchedule[g-1][j][2])-1]-this.xVals[parseInt(this.botSchedule[g-1][j][1])-1])+" "+(this.yVals[parseInt(this.botSchedule[g-1][j][2])-1]-this.yVals[parseInt(this.botSchedule[g-1][j][1])-1])+" z");
						path.line.attr({stroke: '#3b4449','stroke-width': 3});
						path.line.toBack();
						if(myid==parseInt(this.botSchedule[g-1][j][2]))
							highlightCircle(parseInt(this.botSchedule[g-1][j][1]));
					}
				}
			}
		}
	}
	 if (this.Step2Timer <=0){ 
		clearTimeout(this.timeoutStep2);
		loadStep3();
	 }else{  
		this.Step2Timer--;
		document.getElementById("timer").innerHTML = this.Step2Timer;  
		this.timeoutStep2=setTimeout("countDownStep2()", 1000);
	 }  
} 

function countDownStep1(){  
	 if (this.Step1Timer <=0){ 
		clearTimeout(this.timeoutStep1);
		setSchedule();
	 }else{  
		this.Step1Timer--;
		document.getElementById("timer").innerHTML = this.Step1Timer; 
		this.timeoutStep1=setTimeout("countDownStep1()", 1000);
	 }  
} 

function showConfidence()
{
	this.myanswer="";
	var arrkey;
	for (arrkey in this.clueType)
	{
		if($("input:radio[name='findec"+arrkey+"']:checked").val()==undefined)
		{
			document.getElementById("errorStatus").innerHTML="<font color=\"red\">Please select one of the options from each group!</font>";
			return;
		}
		this.myanswer+=("<vote name=\""+$("input:radio[name='findec"+arrkey+"']:checked").val().split(",")[0]+"\">"+$("input:radio[name='findec"+arrkey+"']:checked").val().split(",")[1]+"</vote>");
	}
	for (arrkey in this.clueType)
	{
		$("#"+arrkey+"_row1").hide();
		$("#"+arrkey+"_row2").hide();
	}
	$("#howconftable").show();
	$("#errorStatus").html("&nbsp;");
	$("#submitStatus").html("");
	$("#basedonthe").html("&nbsp;");
	$("#subdecbut").hide();
}

function submitDecision()
{
	if($("input:radio[name='howconf']:checked").val()==undefined)
	{
		document.getElementById("errorStatus").innerHTML="<font color=\"red\">Please select one of the options!</font>";
		return;
	}
	for (arrkey in this.clueType)
	{
		$("#"+arrkey+"_row1").show();
		$("#"+arrkey+"_row2").show();
	}
	$("#basedonthe").html("Based on the information you have gathered, identify: ");
	$("#subconfbut").hide();
	$("#howconftable").hide();
	this.myanswer+=("<confidence>"+$("input:radio[name='howconf']:checked").val()+"</confidence>");
	submit(this.myanswer);
	if(iControlBots)
	{
		for(var g=1; g<=parseInt(variables["bot_count"]); g++)
		{
			var botanswer="";
			var arrkey;
			for (arrkey in this.clueType)
			{
				botanswer+=("<vote name=\""+arrkey+"\">"+(Math.floor(Math.random()*this.clueType[arrkey])+1)+"</vote>");
			}
			botanswer=botanswer+("<confidence>Bot Answer</confidence>");
			submitBot(numPlayers+g, currentRound, botanswer);
		}
	}
	document.getElementById("submitStatus").innerHTML="<p align='center'><font color=\"green\">Thank you! Your choices are sent. Waiting for other participants...</font></p>";
	setEnableRadioGroups(true);
}

function addTab(tabTitle, tabid) {
	if($("#chattable").html().indexOf("tabs-")==-1)
	{
		if(parseInt(variables['conversation_type'])==1)
		{
			$("#chattable").html("<tr><td width=\"455\" height=\"87\"><div id=\"tabs\"><ul><li id=\"tabli"+tabid+"\"><a href=\"#tabs-"+tabid+"\">"+tabTitle+"</a> <span class=\"ui-icon ui-icon-close\" role=\"presentation\">Remove Tab</span></li></ul><div id=\"tabs-"+tabid+"\"><div class=\"control-group\"><div class=\"controls\"> <div id=\"chat_conversation"+tabid+"\" style=\"background-color:white; text-align:left; width: 100%; height: 250px; overflow: auto; font-family:'Verdana'; font-size: 10pt;\"><div></div></div></div></div></div></div><i class=\"icon-pencil\"></i><input onFocus=\"document.getElementById('chat_input').value='';\" value=\"Type something here...\" type=\"text\" id=\"chat_input\" style=\"width: 76%;\" class=\"input-xlarge\"><button type=\"submit\" class=\"btn btn-primary\" id=\"chat_send_button\" onClick=\"sendMessage();\"><i class=\"icon-comment icon-white\"></i> Send</button></td><td width=\"0\" height=\"62\"></td></tr>");
		
			$("#chat_input").keypress(function(event) {
				if ( event.which == 13 ) {
					sendMessage();
					event.preventDefault();
				}
			});
		}
		if(parseInt(variables['conversation_type'])==2)
		{
			$("#chattable").html("<tr><td width=\"455\" height=\"312\"><div id=\"tabs\"><ul><li id=\"tabli"+tabid+"\"><a href=\"#tabs-"+tabid+"\">"+tabTitle+"</a> <span class=\"ui-icon ui-icon-close\" role=\"presentation\">Remove Tab</span></li></ul><div id=\"tabs-"+tabid+"\"><div class=\"control-group\"><div class=\"controls\"> <div id=\"trash"+tabid+"\" class=\"ui-widget-content ui-state-default\" style=\"background-color:white; text-align:left; width: 100%; height: 279px; overflow: auto; font-family:'Verdana'; font-size: 11pt;\">Drag and drop here the information you want to send...</div></div></div></div></div></div></div></td></tr>");
			
			$(function() {
				var $trash = $( "#trash"+tabid );

				// let the trash be droppable, accepting the gallery items
				$trash.droppable({
					accept: "#gallery > li",
					activeClass: "ui-state-highlight",
					drop: function( event, ui ) {
						if($('#trash'+tabid).html()=='Drag and drop here the information you want to send...')
							$('#trash'+tabid).html('');
						deleteImage( ui.draggable );
					}
				});

				// image deletion function
				var recycle_icon = "";
				function deleteImage( $item ) {
						var $list = $( "ul", $trash ).length ?
						$( "ul", $trash ) :
						$( "<ul class='gallery ui-helper-reset'/>" ).appendTo( $trash );
						$item.find( "a.ui-icon-trash" ).remove();
						//$list.html($list.html()+"<div class='messagesender'>You ("+getName(myid)+"):</div>"+$item.clone().text()+"</br>");
						//clonedItem.append( recycle_icon ).appendTo( $list );
						jQuery("div#trash"+tabid).scrollTop(jQuery("div#trash"+tabid)[0].scrollHeight);
						this.sharedMessage=$item.text();
						sendMessage();
				}
			});
		}
		this.tabs = $( "#tabs" ).tabs({
			activate: function( event, ui ) {
				$("#tabli"+$(ui.newTab).text().substring(5, 6)).css("background-color", "#FFFFFF");
				if(getCondition()==1)
				{
					if($(ui.newTab).text().indexOf("User")>=0)
					{
						setUser(parseInt($(ui.newTab).text().substring(5, 6)));
						removeActives();
						$('#'+$(ui.newTab).text().substring(5, 6)).addClass('active');
					}
				//	if($(ui.newTab).text().indexOf("Bot")>=0)
				//	{
				//		setUser((parseInt($(ui.newTab).text().substring(4, 5))+numPlayers));
				//		removeActives();
				//		$('#'+(parseInt($(ui.newTab).text().substring(4, 5))+numPlayers)).addClass('active');
				//	}
				}
				else
				{
					if($(ui.newTab).text().indexOf("User")>=0)
					{
						dehighlightCircle(parseInt($(ui.oldTab).text().substring(5, 6)));
						highlightCircle(parseInt($(ui.newTab).text().substring(5, 6)));
					}
		//			if($(ui.newTab).text().indexOf("Bot")>=0)
		//			{
		//				dehighlightCircle(parseInt($(ui.oldTab).text().substring(4, 5))+numPlayers);
		//				highlightCircle(parseInt($(ui.newTab).text().substring(4, 5))+numPlayers);
		//			}
				}
			}
		});
		/*this.tabs.find( ".ui-tabs-nav" ).sortable({
			axis: "x",
			stop: function() {
				tabs.tabs( "refresh" );
			}
		});*/
		setupTabs();
	}
	else
	{
		if($("#chattable").html().indexOf("tabs-"+tabid)!=-1)
			return;
		var label = tabTitle || "Tab " + tabid;
		var id = "tabs-" + tabid;
		var li = $( this.tabTemplate.replace( /#\{tabli\}/g, "tabli"+tabid ).replace( /#\{href\}/g, "#" + id ).replace( /#\{label\}/g, label ) );
		this.tabs.find( ".ui-tabs-nav" ).append( li );
		if(parseInt(variables['conversation_type'])==1)
			this.tabs.append( "<div id='" + id + "'><div class=\"control-group\"><div class=\"controls\"> <div id=\"chat_conversation"+tabid+"\" style=\"background-color:white; text-align:left; width: 100%; height: 250px; overflow: auto; font-family:'Verdana'; font-size: 10pt;\"><div></div></div></div></div></div>" );
		if(parseInt(variables['conversation_type'])==2)
		{
			this.tabs.append( "<div id='" + id + "'><div class=\"control-group\"><div class=\"controls\"> <div id=\"trash"+tabid+"\" class=\"ui-widget-content ui-state-default\" style=\"background-color:white; text-align:left; width: 100%; height: 279px; overflow: auto; font-family:'Verdana'; font-size: 11pt;\">Drag and drop here the information you want to send...</div></div></div></div></div></div>" );
			$(function() {
				var $trash = $( "#trash"+tabid );

				// let the trash be droppable, accepting the gallery items
				$trash.droppable({
					accept: "#gallery > li",
					activeClass: "ui-state-highlight",
					drop: function( event, ui ) {
						if($('#trash'+tabid).html()=='Drag and drop here the information you want to send...')
							$('#trash'+tabid).html('');
						deleteImage( ui.draggable );
					}
				});

				// image deletion function
				var recycle_icon = "";
				function deleteImage( $item ) {
						var $list = $( "ul", $trash ).length ?
						$( "ul", $trash ) :
						$( "<ul class='gallery ui-helper-reset'/>" ).appendTo( $trash );
						$item.find( "a.ui-icon-trash" ).remove();
						//$list.html($list.html()+"<div class='messagesender'>You ("+getName(myid)+"):</div>"+$item.clone().text()+"</br>");
						//clonedItem.append( recycle_icon ).appendTo( $list );
						jQuery("div#trash"+tabid).scrollTop(jQuery("div#trash"+tabid)[0].scrollHeight);
						this.sharedMessage=$item.text();
						sendMessage();
				}
			});
		}
		this.tabs.tabs( "refresh" );
		this.tabs.tabs("option", "active", $('#tabs >ul >li').size()-1);
	}
	$('.ui-icon').css('background-image', 'url(' + getFile("ui-icons_222222_256x240.png") + ')');
}

function refreshTabs()
{
	this.tabs.tabs( "refresh" );
	var panelId = this.tabs.find( ".ui-tabs-active" ).attr( "aria-controls" );
	if(panelId.indexOf("Everyone")>-1)
	{
		if(getCondition()==1)
		{
			setUser(0);
			removeActives();
			$('#0').addClass('active');
		}
		else
			highlightCircle(0);
	}
	else
	{
		if(getCondition()==1)
		{
			if(panelId.substring(0,5).indexOf("User")>=0)
			{
				setUser(parseInt(panelId.substring(5, 6)));
				removeActives();
				$('#'+parseInt(panelId.substring(5, 6))).addClass('active');
			}
			//if(panelId.substring(0,4).indexOf("Bot")>=0)
			//{
			//	setUser(parseInt(panelId.substring(4, 5))+numPlayers);
			//	removeActives();
			//	$('#'+(parseInt(panelId.substring(4, 5))+numPlayers)).addClass('active');
			//}
		}
		else
		{
			if(panelId.substring(0,5).indexOf("User")>=0)
				highlightCircle(parseInt(panelId.substring(5, 6)));
			//if(panelId.substring(0,4).indexOf("Bot")>=0)
			//	highlightCircle(parseInt(panelId.substring(4, 5))+numPlayers);
		}
	}
}

function setupTabs()
{
	// close icon: removing the tab on click
	this.tabs.delegate( "span.ui-icon-close", "click", function() {
		var panelId = $( this ).closest( "li" ).remove().attr( "aria-controls" );
		$( "#" + panelId ).remove();
		if(getCondition()!=1)
			dehighlightCircle(parseInt(panelId.substring(5)));
		if($("#chattable").html().indexOf("#tabs-")==-1)
			$("#chattable").html("<tr><td width=\"455\" height=\"156\"></td></tr><tr><td width=\"455\" height=\"171\"><div style=\"text-align: center; vertical-align:middle; width: 100%; height: 100%; font-family:'Verdana'; font-size: 12pt;\">Please click on a user to start conversation...</div></td></tr>");
		else
			refreshTabs();
	});
}

function setEnableRadioGroups(en) {
  var forms, el, radioGroup;
  var i = end = j = elsEnd = rg = rgEnd = 0;
  
  if (document.getElementsByTagName) {
    forms = document.getElementsByTagName('form');
    /* Loop through all the FORMs */
    for (i, end = forms.length; i < end; i++) {
      /* Loop through each form element */
      for (j = 0, elsEnd = forms[i].elements.length; j < elsEnd; j++) {
        el = forms[i].elements[j];
        /* If this is a checked, enabled radio button in a radio group... */
        if (!el.disabled
            && el.nodeName === 'INPUT'
            && el.type == 'radio'
            && el.checked
            && forms[i].elements[el.name].length) {
          radioGroup = forms[i].elements[el.name];
          /* Loop through radio group and disable buttons */
          for (rg = 0, rgEnd = radioGroup.length; rg < rgEnd; rg++) {
            radioGroup[rg].disabled = en;
          }
        }
      }
    }
  }
}

Raphael.el.hoverInBounds = function(inFunc, outFunc) {
	var inBounds = false;

  // Mouseover function. Only execute if `inBounds` is false.
	this.mouseover(function() {
		if (!inBounds) {
			inBounds = true;
			inFunc.call(this);
		}
	});

  // Mouseout function
	this.mouseout(function(e) {
    var x = e.offsetX || e.clientX,
        y = e.offsetY || e.clientY;

    // Return `false` if we're still inside the element's bounds
		if (this.isPointInside(x, y)) return false;

		inBounds = false;
		outFunc.call(this);
	});

	return this;
}

// Hover in function
function hoverIn() {
	this.animate({
		r: 35
	}, 200);
}

// Hover out function
function hoverOut() {
	this.animate({
		r: 29
	}, 200);
}

function drawStaticNetwork()
{
	var canvasWidth=300;
	var canvasHeight=303;
	this.r = Raphael("myholder", 300, 303);
	this.circles = new Array();
	this.hiddencircles = new Array();
	this.xVals = new Array();
	this.yVals = new Array();
	this.labels = this.r.set();
	for(var g=1; g<=numPlayers+parseInt(variables["bot_count"]); g++)
	{
		var circleY=-1;
		var circleX=-1;
		if(numPlayers+parseInt(variables["bot_count"])==1)
		{
			circleY=canvasHeight/2;
			circleX=canvasWidth/2;
		}
		if(numPlayers+parseInt(variables["bot_count"])==2)
		{
			circleY=canvasHeight/2;
			if(g==1)
				circleX=canvasWidth/3-5;
			if(g==2)
				circleX=2*canvasWidth/3+5;
		}
		if(numPlayers+parseInt(variables["bot_count"])==3)
		{
			if(g>1)
			{
				circleY=2*canvasHeight/3+5;
				if(g==2)
					circleX=canvasWidth/3-5;
				if(g==3)
					circleX=2*canvasWidth/3+5;
			}
			else
			{
				circleX=canvasWidth/2;
				circleY=canvasHeight/3-5;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==4)
		{
			if(g>2)
			{
				circleY=2*canvasHeight/3-5;
				if(g==3)
					circleX=canvasWidth/3-5;
				if(g==4)
					circleX=2*canvasWidth/3+5;
			}
			else
			{
				circleY=canvasHeight/3-5;
				if(g==1)
					circleX=canvasWidth/3-5;
				if(g==2)
					circleX=2*canvasWidth/3+5;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==5)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/4-5;
				circleX=canvasWidth/8;
			}
			else if(g==2)
			{
				circleY=canvasHeight/4;
				circleX=4*canvasWidth/8;
			}
			else if(g==3)
			{
				circleY=2*canvasHeight/4;
				circleX=7*canvasWidth/8;
			}
			else
			{
				circleY=3*canvasHeight/4+5;
				if(g==4)
					circleX=2*canvasWidth/8;
				if(g==5)
					circleX=6*canvasWidth/8;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==6)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/4;
				circleX=canvasWidth/8;
			}
			else if(g==2)
			{
				circleY=canvasHeight/4;
				circleX=2*canvasWidth/8+15;
			}
			else if(g==3)
			{
				circleY=canvasHeight/4;
				circleX=6*canvasWidth/8-15;
			}
			else if(g==4)
			{
				circleY=2*canvasHeight/4;
				circleX=7*canvasWidth/8;
			}
			else
			{
				circleY=3*canvasHeight/4;
				if(g==5)
					circleX=2*canvasWidth/8+15;
				if(g==6)
					circleX=6*canvasWidth/8-15;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==7)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/5-8;
				circleX=canvasWidth/5-7;
			}
			if(g==2)
			{
				circleY=canvasHeight/5-7;
				circleX=canvasWidth/2;
			}
			if(g==3)
			{
				circleY=2*canvasHeight/5-8;
				circleX=4*canvasWidth/5+7;
			}
			if(g==4)
			{
				circleY=3*canvasHeight/5+8;
				circleX=4*canvasWidth/5+7;
			}
			if(g==5)
			{
				circleY=4*canvasHeight/5+7;
				circleX=3*canvasWidth/5+7;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/5+7;
				circleX=2*canvasWidth/5-7;
			}
			if(g==7)
			{
				circleY=3*canvasHeight/5+8;
				circleX=canvasWidth/5-7;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==8)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/5-8;
				circleX=canvasWidth/5-7;
			}
			if(g==2)
			{
				circleY=canvasHeight/5-7;
				circleX=2*canvasWidth/5-7;
			}
			if(g==3)
			{
				circleY=canvasHeight/5-7;
				circleX=3*canvasWidth/5+7;
			}
			
			if(g==4)
			{
				circleY=2*canvasHeight/5-8;
				circleX=4*canvasWidth/5+7;
			}
			if(g==5)
			{
				circleY=3*canvasHeight/5+8;
				circleX=4*canvasWidth/5+7;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/5+7;
				circleX=3*canvasWidth/5+7;
			}
			if(g==7)
			{
				circleY=4*canvasHeight/5+7;
				circleX=2*canvasWidth/5-7;
			}
			if(g==8)
			{
				circleY=3*canvasHeight/5+8;
				circleX=canvasWidth/5-7;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==9)
		{
			if(g==1)
			{
				circleY=3*canvasHeight/6;
				circleX=1*canvasWidth/12+7;
			}
			if(g==2)
			{
				circleY=2*canvasHeight/6-5;
				circleX=3*canvasWidth/12;
			}
			if(g==3)
			{
				circleY=1*canvasHeight/6-10;
				circleX=canvasWidth/2;
			}
			if(g==4)
			{
				circleY=2*canvasHeight/6-5;
				circleX=9*canvasWidth/12;
			}
			if(g==5)
			{
				circleY=3*canvasHeight/6;
				circleX=11*canvasWidth/12-7;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/6+5
				circleX=9*canvasWidth/12+9;
			}
			if(g==7)
			{
				circleY=5*canvasHeight/6+10;
				circleX=7*canvasWidth/12+8;
			}
			if(g==8)
			{
				circleY=5*canvasHeight/6+10;
				circleX=5*canvasWidth/12-11;
			}
			if(g==9)
			{
				circleY=4*canvasHeight/6+5;
				circleX=3*canvasWidth/12-11;
			}
		}
		var circle = this.r.circle(circleX, circleY,29);
		if((g==myid||canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))&&parseInt(variables['chatting_with_everyone'])==1)
			circle.attr("fill", "#0A4");
		else
			circle.attr("fill", getCircleColor(g-1));
		circle.attr("stroke", "#000");
		circle.attr("cursor", "pointer");
		//circle.hover(hoverIn, hoverOut);
		this.circles.push(circle);
		this.xVals.push(circleX);
		this.yVals.push(circleY);
		if(jQuery.browser.webkit)//if safari or chrome
		{
			if(myid==g)
				this.labels.push(this.r.text(this.xVals[g-1]-23, (this.yVals[g-1]-4)/2, "\u00a0\u00a0\u00a0\u00a0You\n("+getName(myid)+")"));
			else
			{
				if(g<=numPlayers)
					this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5)/2, getName(g)+""));
				else
					this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5)/2, "User "+(g)));
			}
			var c = this.r.circle(circleX, circleY,29);
			c.attr("fill", "red");
			c.attr("cursor", "pointer");
			c.attr({opacity: 0});
			this.hiddencircles.push(c);
		}
		else
		{
			if(myid==g)
				this.labels.push(this.r.text(this.xVals[g-1]-23, (this.yVals[g-1]-4), "\u00a0\u00a0\u00a0\u00a0You\n("+getName(myid)+")"));
			else
			{
				if(g<=numPlayers)
					this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5), getName(g)+""));
				else
					this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5), "User "+(g)));
			}
			var c = this.r.circle(circleX, circleY,29);
			c.attr("fill", "red");
			c.attr("cursor", "pointer");
			c.attr({opacity: 0});
			this.hiddencircles.push(c);
		}
		
	}          
	this.labels.attr({font: "12px Fontin-Sans, Arial", fill: "#fff", "text-anchor": "start", "cursor": "pointer"});
	
	for(var h=0; h<this.circles.length-1; h++)
	{
		for(var i=h+1; i<this.circles.length; i++)
		{
			var path = new Object();
			path.line = this.r.path("M "+this.xVals[h]+" "+this.yVals[h]+" l "+(this.xVals[i]-this.xVals[h])+" "+(this.yVals[i]-this.yVals[h])+" z");
			path.line.attr({stroke: '#3b4449','stroke-width': 3});
			path.line.toBack();
		}
	}
	if(numPlayers+parseInt(variables["bot_count"])==1)
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	if(numPlayers+parseInt(variables["bot_count"])==2)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==3)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==4)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==5)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==6)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==7)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==8)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[7].hover(function(){circles[7].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[7].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==9)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[7].hover(function(){circles[7].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[7].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[8].hover(function(){circles[8].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[8].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}

	circleClick();
}

//circle colors change on each game according to game id, vulnerable due to changes in gameid
function getCircleColor(index)
{
	return this.circleColors[(parseInt($.trim($(".gameid").html().substring($(".gameid").html().indexOf(":")+1, $(".gameid").html().indexOf("<"))))+index)%9];
}

function drawDynamicNetwork()
{
	var canvasWidth=300;
	var canvasHeight=303;
	this.r = Raphael("myholder", 300, 303);
	this.circles = new Array();
	this.hiddencircles = new Array();
	this.xVals = new Array();
	this.yVals = new Array();
	this.labels = this.r.set();
	for(var g=1; g<=numPlayers+parseInt(variables["bot_count"]); g++)
	{
		var circleY=-1;
		var circleX=-1;
		if(numPlayers+parseInt(variables["bot_count"])==1)
		{
			circleY=canvasHeight/2;
			circleX=canvasWidth/2;
		}
		if(numPlayers+parseInt(variables["bot_count"])==2)
		{
			circleY=canvasHeight/2;
			if(g==1)
				circleX=canvasWidth/3-5;
			if(g==2)
				circleX=2*canvasWidth/3+5;
		}
		if(numPlayers+parseInt(variables["bot_count"])==3)
		{
			if(g>1)
			{
				circleY=2*canvasHeight/3+5;
				if(g==2)
					circleX=canvasWidth/3-5;
				if(g==3)
					circleX=2*canvasWidth/3+5;
			}
			else
			{
				circleX=canvasWidth/2;
				circleY=canvasHeight/3-5;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==4)
		{
			if(g>2)
			{
				circleY=2*canvasHeight/3-5;
				if(g==3)
					circleX=canvasWidth/3-5;
				if(g==4)
					circleX=2*canvasWidth/3+5;
			}
			else
			{
				circleY=canvasHeight/3-5;
				if(g==1)
					circleX=canvasWidth/3-5;
				if(g==2)
					circleX=2*canvasWidth/3+5;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==5)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/4-5;
				circleX=canvasWidth/8;
			}
			else if(g==2)
			{
				circleY=canvasHeight/4;
				circleX=4*canvasWidth/8;
			}
			else if(g==3)
			{
				circleY=2*canvasHeight/4;
				circleX=7*canvasWidth/8;
			}
			else
			{
				circleY=3*canvasHeight/4+5;
				if(g==4)
					circleX=2*canvasWidth/8;
				if(g==5)
					circleX=6*canvasWidth/8;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==6)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/4;
				circleX=canvasWidth/8;
			}
			else if(g==2)
			{
				circleY=canvasHeight/4;
				circleX=2*canvasWidth/8+15;
			}
			else if(g==3)
			{
				circleY=canvasHeight/4;
				circleX=6*canvasWidth/8-15;
			}
			else if(g==4)
			{
				circleY=2*canvasHeight/4;
				circleX=7*canvasWidth/8;
			}
			else
			{
				circleY=3*canvasHeight/4;
				if(g==5)
					circleX=2*canvasWidth/8+15;
				if(g==6)
					circleX=6*canvasWidth/8-15;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==7)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/5-8;
				circleX=canvasWidth/5-7;
			}
			if(g==2)
			{
				circleY=canvasHeight/5-7;
				circleX=canvasWidth/2;
			}
			if(g==3)
			{
				circleY=2*canvasHeight/5-8;
				circleX=4*canvasWidth/5+7;
			}
			if(g==4)
			{
				circleY=3*canvasHeight/5+8;
				circleX=4*canvasWidth/5+7;
			}
			if(g==5)
			{
				circleY=4*canvasHeight/5+7;
				circleX=3*canvasWidth/5+7;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/5+7;
				circleX=2*canvasWidth/5-7;
			}
			if(g==7)
			{
				circleY=3*canvasHeight/5+8;
				circleX=canvasWidth/5-7;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==8)
		{
			if(g==1)
			{
				circleY=2*canvasHeight/5-8;
				circleX=canvasWidth/5-7;
			}
			if(g==2)
			{
				circleY=canvasHeight/5-7;
				circleX=2*canvasWidth/5-7;
			}
			if(g==3)
			{
				circleY=canvasHeight/5-7;
				circleX=3*canvasWidth/5+7;
			}
			
			if(g==4)
			{
				circleY=2*canvasHeight/5-8;
				circleX=4*canvasWidth/5+7;
			}
			if(g==5)
			{
				circleY=3*canvasHeight/5+8;
				circleX=4*canvasWidth/5+7;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/5+7;
				circleX=3*canvasWidth/5+7;
			}
			if(g==7)
			{
				circleY=4*canvasHeight/5+7;
				circleX=2*canvasWidth/5-7;
			}
			if(g==8)
			{
				circleY=3*canvasHeight/5+8;
				circleX=canvasWidth/5-7;
			}
		}
		if(numPlayers+parseInt(variables["bot_count"])==9)
		{
			if(g==1)
			{
				circleY=3*canvasHeight/6;
				circleX=1*canvasWidth/12+7;
			}
			if(g==2)
			{
				circleY=2*canvasHeight/6-5;
				circleX=3*canvasWidth/12;
			}
			if(g==3)
			{
				circleY=1*canvasHeight/6-10;
				circleX=canvasWidth/2;
			}
			if(g==4)
			{
				circleY=2*canvasHeight/6-5;
				circleX=9*canvasWidth/12;
			}
			if(g==5)
			{
				circleY=3*canvasHeight/6;
				circleX=11*canvasWidth/12-7;
			}
			if(g==6)
			{
				circleY=4*canvasHeight/6+5
				circleX=9*canvasWidth/12+9;
			}
			if(g==7)
			{
				circleY=5*canvasHeight/6+10;
				circleX=7*canvasWidth/12+8;
			}
			if(g==8)
			{
				circleY=5*canvasHeight/6+10;
				circleX=5*canvasWidth/12-11;
			}
			if(g==9)
			{
				circleY=4*canvasHeight/6+5;
				circleX=3*canvasWidth/12-11;
			}
		}
		var circle = new Object();
		circle=this.r.circle(circleX, circleY,29);
		if((g==myid||canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))&&parseInt(variables['chatting_with_everyone'])==1)
			circle.attr("fill", "#0A4");
		else
			circle.attr("fill", getCircleColor(g-1));
		circle.attr("stroke", "#000");
		circle.attr("cursor", "pointer");
	//	circle.hover(hoverIn, hoverOut);
		this.circles.push(circle);
		this.xVals.push(circleX);
		this.yVals.push(circleY);
		
		if(jQuery.browser.webkit)//if safari or chrome
		{
			if(myid==g)
				this.labels.push(this.r.text(this.xVals[g-1]-26, (this.yVals[g-1]-4)/2, "\u00a0\u00a0\u00a0\u00a0You\n("+getName(myid)+")"));
			else
			{
				if(g<=numPlayers)
					this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5)/2, getName(g)+""));
				else
					this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5)/2, "User "+(g)));
			}
			var c = this.r.circle(circleX, circleY,29);
			c.attr("fill", "red");
			c.attr("cursor", "pointer");
			c.attr({opacity: 0});
			this.hiddencircles.push(c);
		}
		else
		{
			if(myid==g)
				this.labels.push(this.r.text(this.xVals[g-1]-26, (this.yVals[g-1]-4), "\u00a0\u00a0\u00a0\u00a0You\n("+getName(myid)+")"));
			else
			{
				if(g<=numPlayers)
					this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5), getName(g)+""));
				else
					this.labels.push(this.r.text(this.xVals[g-1]-19, (this.yVals[g-1]+3.5), "User "+(g)));
			}
			var c = this.r.circle(circleX, circleY,29);
			c.attr("fill", "red");
			c.attr("cursor", "pointer");
			c.attr({opacity: 0});
			this.hiddencircles.push(c);
		}
		this.labels.attr({font: "12px Fontin-Sans, Verdana", fill: "#fff", "text-anchor": "start", "cursor": "pointer"});
	}   

	if(numPlayers+parseInt(variables["bot_count"])==1)
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	if(numPlayers+parseInt(variables["bot_count"])==2)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==3)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==4)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==5)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==6)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==7)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==8)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[7].hover(function(){circles[7].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[7].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	if(numPlayers+parseInt(variables["bot_count"])==9)
	{
		this.hiddencircles[0].hover(function(){circles[0].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[0].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[1].hover(function(){circles[1].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[1].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[2].hover(function(){circles[2].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[2].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[3].hover(function(){circles[3].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[3].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[4].hover(function(){circles[4].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[4].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[5].hover(function(){circles[5].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[5].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[6].hover(function(){circles[6].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[6].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[7].hover(function(){circles[7].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[7].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
		this.hiddencircles[8].hover(function(){circles[8].animate({ r: 35 }, 200);this.animate({ r: 35 }, 200);}, function(){circles[8].animate({ r: 29 }, 200);this.animate({ r: 29 }, 200);});
	}
	
	circleClick();
	
	/*for(var h=0; h<this.circles.length-1; h++)
	{
		for(var i=h+1; i<this.circles.length; i++)
		{
			if(canCommunicate(h, i))
			{
				var path = new Object();
				path.line = this.r.path("M "+xVals[h]+" "+this.yVals[h]+" l "+(this.xVals[i]-this.xVals[h])+" "+(this.yVals[i]-this.yVals[h])+" z");
				path.line.attr({stroke: '#3b4449','stroke-width': 5});
				path.line.toBack();
			}
		}
	}*/
}

function canCommunicate(i, j)
{
	return (variables["communication"]==null||variables["communication"]==undefined||variables["communication"][i]==null||variables["communication"][i]==undefined||variables["communication"][i][j]==null||variables["communication"][i][j]==undefined); // if matrix is empty, they can communicate. Subject to change!
	return (parseInt(variables["communication"][i][j]+"")==1);
}

function circleClick(){
	for(var g=1; g<=numPlayers+parseInt(variables["bot_count"]); g++)
	{
		if(canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
		{
			if(g==1)
			{
				this.circles[g-1].click(function() {
					highlightCircle(1);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(1);
					return;
				});
			}
			if(g==2)
			{
				this.circles[g-1].click(function() {
					highlightCircle(2);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(2);
					return;
				});

			}
			if(g==3)
			{
				this.circles[g-1].click(function() {
					highlightCircle(3);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(3);
					return;
				});
			}
			if(g==4)
			{
				this.circles[g-1].click(function() {
					highlightCircle(4);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(4);
					return;
				});
			}
			if(g==5)
			{
				this.circles[g-1].click(function() {
					highlightCircle(5);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(5);
					return;
				});
			}
			if(g==6)
			{
				this.circles[g-1].click(function() {
					highlightCircle(6);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(6);
					return;
				});
			}
			if(g==7)
			{
				this.circles[g-1].click(function() {
					highlightCircle(7);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(7);
					return;
				});
			}
			if(g==8)
			{
				this.circles[g-1].click(function() {
					highlightCircle(8);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(8);
					return;
				});
			}
			if(g==9)
			{
				this.circles[g-1].click(function() {
					highlightCircle(9);
					return;
				});
				this.hiddencircles[g-1].click(function() {
					highlightCircle(9);
					return;
				});
			}
		}
	}
}

function highlightCircle(gg)
{
	if(isNaN(gg)||gg==myid)
		return;
	if(gg==0)
	{
		if(getCondition()!=1)
		{
			for(var g=1; g<=numPlayers+parseInt(variables["bot_count"]); g++)
			{
				if(g==myid||canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
					this.circles[g-1].attr("fill", "#0A4");
			}
		}
		setUser(0); 
		removeActives();
		$('#0').addClass('active');
		this.tabs.tabs("option", "active", 0);
	}
	else
	{
		if($("#chattable").html().indexOf("tabs-"+gg)==-1)
		{
			if(gg<=numPlayers)
				addTab(getName(gg), gg);
			else
				addTab("User "+(gg), gg);
		}	
		else
			this.tabs.tabs("option", "active", $('#tabs-'+gg).tabIndex());
		if(getCondition()!=1)
		{
			for(var ic=0; ic<numPlayers+parseInt(variables["bot_count"]); ic++)
				this.circles[ic].attr("fill", getCircleColor(ic));
			this.circles[gg-1].attr("fill", "#0A4");
		}
		setUser(gg); 
		removeActives();
		$('#'+gg).addClass('active');
	}
}

function dehighlightCircle(g)
{
	this.circles[g-1].attr("fill", getCircleColor(g-1));
}

function setUser(nmb)
{
	selectedUser=nmb;
}

$.fn.tabIndex = function () {
	return $(this).parent().find(this).index() - 1; 
};

function removeActives()
{
	for(var g=0; g<=numPlayers+parseInt(variables["bot_count"]); g++)
	{
		if ($("#"+g)!=null&&$("#"+g)!=undefined&&$("#"+g).is('.active'))
			$("#"+g).removeClass("active");
	}
}
       
/*function curve(x, y, ax, ay, bx, by, zx, zy, color) 
{
	var path = [["M", x, y], ["C", ax, ay, bx, by, zx, zy]],
		path2 = [["M", x, y], ["L", ax, ay], ["M", bx, by], ["L", zx, zy]],
		curve = r.path(path).attr({stroke: '#3b4449','stroke-width': 3	, 'stroke-dasharray':'-'}),
		controls = r.set(
			r.circle(x, y, 0.1).attr({fill: "#9F2200", stroke: "none"}),
			r.circle(ax, ay, 0.1).attr({fill: "#9F2200", stroke: "none"}),
			r.circle(bx, by, 0.1).attr({fill: "#9F2200", stroke: "none"}),
			r.circle(zx, zy, 0.1).attr({fill: "#9F2200", stroke: "none"})
		);
		curve.toBack();
}*/
  
/*function drawLineIfMessageReceived()
{
	if(this.chatContent!=$("#chat_conversation").html())
	{
		for(var g=1; g<=numPlayers; g++)
		{
			if(g!=myid&&getName(g)==$("#chat_conversation").html().substring($("#chat_conversation").html().indexOf('>',$("#chat_conversation").html().lastIndexOf("<div color"))+1,$("#chat_conversation").html().lastIndexOf("</div><div>")-1))
			{
				var path = new Object();
				path.line = this.r.path("M "+xVals[myid-1]+" "+this.yVals[myid-1]+" l "+(this.xVals[g-1]-this.xVals[myid-1])+" "+(this.yVals[g-1]-this.yVals[myid-1])+" z");
				path.line.attr({stroke: '#3b4449','stroke-width': 3	, 'stroke-dasharray':'-'});
				path.line.toBack();
				//if(this.yVals[myid-1]<=this.yVals[g-1])
				//	curve(xVals[myid-1], this.yVals[myid-1],xVals[myid-1]+20, this.yVals[myid-1]+(this.yVals[g-1]-this.yVals[myid-1])/2, this.xVals[g-1]+40, this.yVals[g-1]-(this.yVals[g-1]-this.yVals[myid-1])/2, this.xVals[g-1], this.yVals[g-1], "hsb(0, 0, 0)");
				//else
				//	curve(xVals[myid-1], this.yVals[myid-1],xVals[myid-1]+20, this.yVals[myid-1]-(this.yVals[g-1]-this.yVals[myid-1])/2, this.xVals[g-1]+40, this.yVals[g-1]+(this.yVals[g-1]-this.yVals[myid-1])/2, this.xVals[g-1], this.yVals[g-1], "hsb(0, 0, 0)"); 				
			}
		}
	}
	this.chatContent=$("#chat_conversation").html();
	setTimeout("drawLineIfMessageReceived()", 1000);
}*/

function botBehav1()
{
	for(var n=1; n<=parseInt(variables["bot_count"]); n++)
	{
		if(variables['bot_type']==1)//random private
			$('#trash0').append("<div class='messagereceiver'>User "+n+":</div><div class='receivedmessage'>&nbsp;"+this.privateInfo[numPlayers+n-1][Math.floor(Math.random()*this.privateInfo[numPlayers+n-1].length)]+"</div>");
		if(variables['bot_type']==2)//random public
			$('#trash0').append("<div class='messagereceiver'>User "+n+":</div><div class='receivedmessage'>&nbsp;"+this.publicInfo[Math.floor(Math.random()*this.publicInfo.length)]+"</div>");
		if(variables['bot_type']==3)//totally random
		{
			if(Math.floor(Math.random()*2)+1==1) // private
				$('#trash0').append("<div class='messagereceiver'>User "+n+":</div><div class='receivedmessage'>&nbsp;"+this.privateInfo[numPlayers+n-1][Math.floor(Math.random()*this.privateInfo[numPlayers+n-1].length)]+"</div>");
			else
				$('#trash0').append("<div class='messagereceiver'>User "+n+":</div><div class='receivedmessage'>&nbsp;"+this.publicInfo[Math.floor(Math.random()*this.publicInfo.length)]+"</div>");
		}
		jQuery("div#trash0").scrollTop(jQuery("div#trash0")[0].scrollHeight);
		
		if(getCondition()!=1)
		{
			for(var i=0; i<numPlayers+parseInt(variables["bot_count"]); i++)
			{
				var path = new Object();
				path.line = this.r.path("M "+xVals[parseInt(numPlayers+n)-1]+" "+this.yVals[parseInt(numPlayers+n)-1]+" l "+(this.xVals[i]-this.xVals[parseInt(numPlayers+n)-1])+" "+(this.yVals[i]-this.yVals[parseInt(numPlayers+n)-1])+" z");
				path.line.attr({stroke: '#3b4449','stroke-width': 3});
				path.line.toBack();
			}
		}
	}
}

function botBehav2(to_ids)
{
	if(variables['bot_type']==1)//random private
		$('#trash'+to_ids[5]).append("<div class='messagereceiver'>User "+(to_ids[5])+":</div><div class='receivedmessage'>&nbsp;"+this.privateInfo[to_ids[5]-1][Math.floor(Math.random()*this.privateInfo[to_ids[5]-1].length)]+"</div>");
	if(variables['bot_type']==2)//random public
		$('#trash'+to_ids[5]).append("<div class='messagereceiver'>User "+(to_ids[5])+":</div><div class='receivedmessage'>&nbsp;"+this.publicInfo[Math.floor(Math.random()*this.publicInfo.length)]+"</div>");
	if(variables['bot_type']==3)//totally random
	{
		if(Math.floor(Math.random()*2)+1==1) // private
			$('#trash'+to_ids[5]).append("<div class='messagereceiver'>User "+(to_ids[5])+":</div><div class='receivedmessage'>&nbsp;"+this.privateInfo[to_ids[5]-1][Math.floor(Math.random()*this.privateInfo[to_ids[5]-1].length)]+"</div>");
		else
			$('#trash'+to_ids[5]).append("<div class='messagereceiver'>User "+(to_ids[5])+":</div><div class='receivedmessage'>&nbsp;"+this.publicInfo[Math.floor(Math.random()*this.publicInfo.length)]+"</div>");
	}
	jQuery("div#trash"+to_ids[5]).scrollTop(jQuery("div#trash"+to_ids[5])[0].scrollHeight);
	
	if(getCondition()!=1)
	{
		var path = new Object();
		path.line = this.r.path("M "+xVals[to_ids[2]-1]+" "+this.yVals[to_ids[2]-1]+" l "+(this.xVals[to_ids[5]-1]-this.xVals[to_ids[2]-1])+" "+(this.yVals[to_ids[5]-1]-this.yVals[to_ids[2]-1])+" z");
		path.line.attr({stroke: '#3b4449','stroke-width': 3});
		path.line.toBack();
	}
}

function botBehav3()
{
	for(var n=1; n<=parseInt(variables["bot_count"]); n++)
	{
		if(variables['bot_type']==1)//random private
			$('#trash0').append("<div class='messagereceiver'>User "+n+":</div><div class='receivedmessage'>&nbsp;"+this.privateInfo[numPlayers+n-1][Math.floor(Math.random()*this.privateInfo[numPlayers+n-1].length)]+"</div>");
		if(variables['bot_type']==2)//random public
			$('#trash0').append("<div class='messagereceiver'>User "+n+":</div><div class='receivedmessage'>&nbsp;"+this.publicInfo[Math.floor(Math.random()*this.publicInfo.length)]+"</div>");
		if(variables['bot_type']==3)//totally random
		{
			if(Math.floor(Math.random()*2)+1==1) // private
				$('#trash0').append("<div class='messagereceiver'>User "+n+":</div><div class='receivedmessage'>&nbsp;"+this.privateInfo[numPlayers+n-1][Math.floor(Math.random()*this.privateInfo[numPlayers+n-1].length)]+"</div>");
			else
				$('#trash0').append("<div class='messagereceiver'>User "+n+":</div><div class='receivedmessage'>&nbsp;"+this.publicInfo[Math.floor(Math.random()*this.publicInfo.length)]+"</div>");
		}
		jQuery("div#trash0").scrollTop(jQuery("div#trash0")[0].scrollHeight);
	}
}

function botBehav4(to_ids)
{
	if(variables['bot_type']==1)//random private
		$('#trash'+to_ids[1]).append("<div class='messagereceiver'>User "+(to_ids[1])+":</div><div class='receivedmessage'>&nbsp;"+this.privateInfo[to_ids[1]-1][Math.floor(Math.random()*this.privateInfo[to_ids[1]-1].length)]+"</div>");
	if(variables['bot_type']==2)//random public
		$('#trash'+to_ids[1]).append("<div class='messagereceiver'>User "+(to_ids[1])+":</div><div class='receivedmessage'>&nbsp;"+this.publicInfo[Math.floor(Math.random()*this.publicInfo.length)]+"</div>");
	if(variables['bot_type']==3)//totally random
	{
		if(Math.floor(Math.random()*2)+1==1) // private
			$('#trash'+to_ids[1]).append("<div class='messagereceiver'>User "+(to_ids[1])+":</div><div class='receivedmessage'>&nbsp;"+this.privateInfo[to_ids[1]-1][Math.floor(Math.random()*this.privateInfo[to_ids[1]-1].length)]+"</div>");
		else
			$('#trash'+to_ids[1]).append("<div class='messagereceiver'>User "+(to_ids[1])+":</div><div class='receivedmessage'>&nbsp;"+this.publicInfo[Math.floor(Math.random()*this.publicInfo.length)]+"</div>");
	}
	jQuery("div#trash"+to_ids[1]).scrollTop(jQuery("div#trash"+to_ids[1])[0].scrollHeight);
}

function comReceived(index, newCom) {
  if (newCom.com_type == -1) {
    chatReceived(newCom.from,newCom.val,newCom.to_parts);
  }
}

function chatReceived(from_ids,message,to_ids) {
	if(this.condition==3)
	{
		if (to_ids[2] == to_ids[5]) return;
		if(parseInt(variables['chatting_with_everyone'])==1 && eval(to_ids).length==numPlayers) // everyone
		{
			if (parseInt(from_ids) == myid) {
				if(parseInt(variables['conversation_type'])==1)
				{
					$('#chat_conversation0').append("<div class='messagesender'>You ("+getName(myid)+"):</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#chat_conversation0").scrollTop(jQuery("div#chat_conversation0")[0].scrollHeight);
				}
				if(parseInt(variables['conversation_type'])==2)
				{
					if($('#trash0').html()=="Drag and drop here the information you want to send...") $('#trash0').html("");	
					$('#trash0').append("<div class='messagesender'>You ("+getName(myid)+"):</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#trash0").scrollTop(jQuery("div#trash0")[0].scrollHeight);
					
					if(parseInt(variables["bot_count"])>0)
					{
						if(parseInt(variables["bot_behavior"])==1)
							setTimeout('botBehav1()', 2500);
						if(parseInt(variables["bot_behavior"])==2)
						{
							if(getCondition()!=1)
							{
								for(var i=0; i<numPlayers+parseInt(variables["bot_count"]); i++)
								{
									var path = new Object();
									path.line = this.r.path("M "+xVals[parseInt(from_ids)-1]+" "+this.yVals[parseInt(from_ids)-1]+" l "+(this.xVals[i]-this.xVals[parseInt(from_ids)-1])+" "+(this.yVals[i]-this.yVals[parseInt(from_ids)-1])+" z");
									path.line.attr({stroke: '#3b4449','stroke-width': 3});
									path.line.toBack();
								}
							}
						}
					}
				}
			}
			else
			{
				if(this.tabs.find( ".ui-tabs-active" ).attr( "aria-controls" )=="tabs-0")
					$("#tabli0").css("background-color", "#FFFFFF");
				else
					$("#tabli0").css("background-color", "#DBA901");
				if(parseInt(variables['conversation_type'])==1)
				{
					$('#chat_conversation0').append("<div class='messagereceiver'>"+getName(from_ids)+":</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#chat_conversation0").scrollTop(jQuery("div#chat_conversation0")[0].scrollHeight);
				}
				if(parseInt(variables['conversation_type'])==2)
				{
					if($('#trash0').html()=="Drag and drop here the information you want to send...") $('#trash0').html("");
					$('#trash0').append("<div class='messagereceiver'>"+getName(from_ids)+":</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#trash0").scrollTop(jQuery("div#trash0")[0].scrollHeight);
				}
			}
			if(getCondition()!=1)
			{
				for(var i=0; i<eval(to_ids).length; i++)
				{
					var path = new Object();
					path.line = this.r.path("M "+xVals[parseInt(from_ids)-1]+" "+this.yVals[parseInt(from_ids)-1]+" l "+(this.xVals[eval(to_ids)[i]-1]-this.xVals[parseInt(from_ids)-1])+" "+(this.yVals[eval(to_ids)[i]-1]-this.yVals[parseInt(from_ids)-1])+" z");
					path.line.attr({stroke: '#3b4449','stroke-width': 3});
					path.line.toBack();
				}
			}
		}
		else
		{
			if (to_ids[2] == myid) {
				if(parseInt(variables['conversation_type'])==1)
				{
					$('#chat_conversation'+to_ids[5]).append("<div class='messagesender'>You ("+getName(myid)+"):</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#chat_conversation"+to_ids[5]).scrollTop(jQuery("div#chat_conversation"+to_ids[5])[0].scrollHeight);
				}
				if(parseInt(variables['conversation_type'])==2)
				{
					if($('#trash'+to_ids[5]).html()=="Drag and drop here the information you want to send...") $('#trash'+to_ids[5]).html("");
					$('#trash'+to_ids[5]).append("<div class='messagesender'>You ("+getName(myid)+"):</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#trash"+to_ids[5]).scrollTop(jQuery("div#trash"+to_ids[5])[0].scrollHeight);
					
					if(parseInt(variables["bot_count"])>0)
					{
						if(parseInt(variables["bot_behavior"])==1)
							setTimeout(function() {botBehav2(to_ids);}, 2500);
					}
				}
			}
			if (to_ids[5] == myid)
			{
				addTab(getName(to_ids[2]), to_ids[2]);
				if(parseInt(this.tabs.find( ".ui-tabs-active" ).attr( "aria-controls" ).substring(5))==to_ids[2])
				{
					$("#tabli"+to_ids[2]).css("background-color", "#FFFFFF");
					highlightCircle(parseInt(to_ids[2]));
				}
				else
					$("#tabli"+to_ids[2]).css("background-color", "#DBA901");
				if(parseInt(variables['conversation_type'])==1)
				{
					$('#chat_conversation'+to_ids[2]).append("<div class='messagereceiver'>"+getName(from_ids)+":</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#chat_conversation"+to_ids[2]).scrollTop(jQuery("div#chat_conversation"+to_ids[2])[0].scrollHeight);
				}
				if(parseInt(variables['conversation_type'])==2)
				{
					if($('#trash'+to_ids[2]).html()=="Drag and drop here the information you want to send...") $('#trash'+to_ids[2]).html("");
					$('#trash'+to_ids[2]).append("<div class='messagereceiver'>"+getName(from_ids)+":</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#trash"+to_ids[2]).scrollTop(jQuery("div#trash"+to_ids[2])[0].scrollHeight);
				}
			}
			if(getCondition()!=1)
			{
				var path = new Object();
				path.line = this.r.path("M "+xVals[to_ids[2]-1]+" "+this.yVals[to_ids[2]-1]+" l "+(this.xVals[to_ids[5]-1]-this.xVals[to_ids[2]-1])+" "+(this.yVals[to_ids[5]-1]-this.yVals[to_ids[2]-1])+" z");
				path.line.attr({stroke: '#3b4449','stroke-width': 3});
				path.line.toBack();
			}
		}
	}
	else
	{
		if (to_ids[4] == to_ids[1]) return;
		if(parseInt(variables['chatting_with_everyone'])==1 && eval(to_ids).length==numPlayers) // everyone
		{
			if (parseInt(from_ids) == myid) {
				if(parseInt(variables['conversation_type'])==1)
				{
					$('#chat_conversation0').append("<div class='messagesender'>You ("+getName(myid)+"):</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#chat_conversation0").scrollTop(jQuery("div#chat_conversation0")[0].scrollHeight);
				}
				if(parseInt(variables['conversation_type'])==2)
				{
					if($('#trash0').html()=="Drag and drop here the information you want to send...") $('#trash0').html("");
					$('#trash0').append("<div class='messagesender'>You ("+getName(myid)+"):</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#trash0").scrollTop(jQuery("div#trash0")[0].scrollHeight);
					
					if(parseInt(variables["bot_count"])>0)
					{
						if(parseInt(variables["bot_behavior"])==1)
							setTimeout('botBehav3()', 2500);
					}
				}
			}
			else
			{
				if(this.tabs.find( ".ui-tabs-active" ).attr( "aria-controls" )=="tabs-0")
					$("#tabli0").css("background-color", "#FFFFFF");
				else
					$("#tabli0").css("background-color", "#DBA901");
				if(parseInt(variables['conversation_type'])==1)
				{
					$('#chat_conversation0').append("<div class='messagereceiver'>"+getName(from_ids)+":</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#chat_conversation0").scrollTop(jQuery("div#chat_conversation0")[0].scrollHeight);
				}
				if(parseInt(variables['conversation_type'])==2)
				{
					if($('#trash0').html()=="Drag and drop here the information you want to send...") $('#trash0').html("");
					$('#trash0').append("<div class='messagereceiver'>"+getName(from_ids)+":</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#trash0").scrollTop(jQuery("div#trash0")[0].scrollHeight);
				}
			}
		}
		else
		{
			if (to_ids[4] == myid) {
				if(parseInt(variables['conversation_type'])==1)
				{
					$('#chat_conversation'+to_ids[1]).append("<div class='messagesender'>You ("+getName(myid)+"):</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#chat_conversation"+to_ids[1]).scrollTop(jQuery("div#chat_conversation"+to_ids[1])[0].scrollHeight);
				}
				if(parseInt(variables['conversation_type'])==2)
				{
					if($("#trash"+to_ids[1]).html()=="Drag and drop here the information you want to send...") $("#trash"+to_ids[1]).html("");
					$('#trash'+to_ids[1]).append("<div class='messagesender'>You ("+getName(myid)+"):</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#trash"+to_ids[1]).scrollTop(jQuery("div#trash"+to_ids[1])[0].scrollHeight);
					
					if(parseInt(variables["bot_count"])>0)
					{
						if(parseInt(variables["bot_behavior"])==1)
							setTimeout(function() {botBehav4(to_ids);}, 2500);
					}
				}
			}
			if (to_ids[1] == myid)
			{
				addTab(getName(to_ids[4]), to_ids[4]);
				if(parseInt(this.tabs.find( ".ui-tabs-active" ).attr( "aria-controls" ).substring(5))==to_ids[4])
				{
					$("#tabli"+to_ids[4]).css("background-color", "#FFFFFF");
					highlightCircle(parseInt(to_ids[4]));
				}
				else
					$("#tabli"+to_ids[4]).css("background-color", "#DBA901");
				if(parseInt(variables['conversation_type'])==1)
				{
					$('#chat_conversation'+to_ids[4]).append("<div class='messagereceiver'>"+getName(from_ids)+":</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#chat_conversation"+to_ids[4]).scrollTop(jQuery("div#chat_conversation"+to_ids[4])[0].scrollHeight);
				}
				if(parseInt(variables['conversation_type'])==2)
				{
					if($("#trash"+to_ids[4]).html()=="Drag and drop here the information you want to send...") $("#trash"+to_ids[4]).html("");
					$('#trash'+to_ids[4]).append("<div class='messagereceiver'>"+getName(from_ids)+":</div><div class='receivedmessage'>&nbsp;"+message+"</div>");
					jQuery("div#trash"+to_ids[4]).scrollTop(jQuery("div#trash"+to_ids[4])[0].scrollHeight);
				}
			}
		}
	}
}

function sendMessage()
{
	if(parseInt(variables['conversation_type'])==1&&$("#chat_input").val()==null||$("#chat_input").val()=="Type something here..."||$("#chat_input").val()=="") return;

	if(this.condition==3)
	{
		if(selectedUser==undefined||selectedUser==null||selectedUser==0)
		{
			if(parseInt(variables['chatting_with_everyone'])==1)
			{
				if(parseInt(variables['conversation_type'])==1)
					sendChat($("#chat_input").val());
				if(parseInt(variables['conversation_type'])==2)
					sendChat(this.sharedMessage);
			}
		}
		else
		{
			var msgArr = new Array();
			msgArr.push(myid);
			if(canCommunicate(myid-1, selectedUser-1)||canCommunicate(selectedUser-1, myid-1))
			{
				msgArr.push(selectedUser);
				//var path = new Object();
				//path.line = this.r.path("M "+xVals[myid-1]+" "+this.yVals[myid-1]+" l "+(this.xVals[selectedUser-1]-this.xVals[myid-1])+" "+(this.yVals[selectedUser-1]-this.yVals[myid-1])+" z");
				//path.line.attr({stroke: '#3b4449','stroke-width': 3	, 'stroke-dasharray':'-'});
				//path.line.toBack();
				//if(this.yVals[myid-1]<=this.yVals[selectedUser-1])
				//	curve(xVals[myid-1], this.yVals[myid-1],xVals[myid-1]+20, this.yVals[myid-1]+(this.yVals[selectedUser-1]-this.yVals[myid-1])/3, this.xVals[selectedUser-1]+40, this.yVals[selectedUser-1]-(this.yVals[selectedUser-1]-this.yVals[myid-1])/3, this.xVals[selectedUser-1], this.yVals[selectedUser-1], "hsb(0, 0, 0)");
				//else
				//	curve(xVals[myid-1], this.yVals[myid-1],xVals[myid-1]+20, this.yVals[myid-1]-(this.yVals[selectedUser-1]-this.yVals[myid-1])/3, this.xVals[selectedUser-1]+40, this.yVals[selectedUser-1]+(this.yVals[selectedUser-1]-this.yVals[myid-1])/3, this.xVals[selectedUser-1], this.yVals[selectedUser-1], "hsb(0, 0, 0)"); 
			}
			if(parseInt(variables['conversation_type'])==1)
				sendChat($("#chat_input").val(), msgArr);
			if(parseInt(variables['conversation_type'])==2)
				sendChat(this.sharedMessage, msgArr);
		}
	}
	else
	{
		if(selectedUser==undefined||selectedUser==null||selectedUser==0)
		{
			if(parseInt(variables['chatting_with_everyone'])==1)
			{
				if(parseInt(variables['conversation_type'])==1)
					sendChat($("#chat_input").val());
				if(parseInt(variables['conversation_type'])==2)
					sendChat(this.sharedMessage);
			}
		}
		else
		{
			var msgArr = new Array();
			msgArr.push(selectedUser);
			msgArr.push(myid);
			if(parseInt(variables['conversation_type'])==1)
				sendChat($("#chat_input").val(),msgArr);
			if(parseInt(variables['conversation_type'])==2)
				sendChat(this.sharedMessage,msgArr);
		}
	}
	if(parseInt(variables['conversation_type'])==1)
		$("#chat_input").val('');
	if(parseInt(variables['conversation_type'])==2)
		this.sharedMessage="";
}	
</script> 