<style type="text/css">
.mybs-docs-example 
{
    position: relative;
    position: relative;
    margin: 15px 0;
    padding: 39px 19px 14px;
    background-color: white;
    border: 1px solid #DDD;
    -webkit-border-radius: 4px;
    -moz-border-radius: 4px;
    border-radius: 4px;
}

.mybs-docs-example::after
{
    content: "Rules";
    position: absolute;
    top: -1px;
    left: -1px;
    padding: 3px 7px;
    font-size: 12px;
    font-weight: bold;
    background-color: whiteSmoke;
    border: 1px solid #DDD;
    color: #9DA0A4;
    -webkit-border-radius: 4px 0 4px 0;
    -moz-border-radius: 4px 0 4px 0;
    border-radius: 4px 0 4px 0;
}
</style> 


<table border="0" width="800" align="center">
    <tr>
        <td width="790">
		
            <div id="helpinfo" class="mybs-docs-example tooltip-demo">
                <ul>
                    <li class="muted" style="margin-bottom: 0;">			Incorporate with other members to make your final decision for the problem by making use of the information that is shared within the group (provided in grey box) at an expense of information that is unshared (provided in three consecutive boxes following the grey box).  </li>
                    <li class="muted" id="stepgoal" style="margin-bottom: 0;">Please read the provided shared and unshared information at this step.</li>
                    <li class="muted" id="timetext" style="margin-bottom: 0;">You have ? seconds before proceeding at next step.</li>
                </ul>
            </div>
		
			<table id="pbar" border="0" width="800" align="center">
				<tr>
					<td width="580">
						<div class="progress">
						<div class="bar" style="width:100%;" id="timerbar"></div>
						</div>
					</td>
                    <td width="129">
                        <h3 align="right">Time Left:
                        </h3>
                    </td>
                    <td width="96">
                        <h3><font color="red" id="timer">&nbsp;</font></h3>
                    </td>
				</tr>
			</table>
		
			<div id="gamecontent">
			
				<table id="twocolumn" align="center" border="0" width="766">
					<tr>
						<td>
							<div id="pubinfo" class="hero-unit" style="width:750px;">
								<h2 id="ttl" align="center">&nbsp;</h2>
								<p id="desc">&nbsp;</p>
								<div id="step1" class="accordion">	
								</div>
							</div>
						</td>		
						<td>
							<table id="step2" align="center" border="0" width="500">
								<tr>
									<td width="128" height="17" style="border-width:1; border-color:rgb(204,204,204); border-left-style:solid; border-right-style:none; border-bottom-style:none; border-top-style:solid;">
										<p>Participant Network</p>
									</td>
									<td width="288" height="17" style="border-width:1; border-color:rgb(204,204,204); border-top-style:solid; border-right-style:none; border-bottom-style:none; border-left-style:none;"></td>
									<td width="84" height="17" style="border-width:1; border-color:rgb(204,204,204); border-top-style:solid; border-right-style:solid; border-bottom-style:none; border-left-style:none;">&nbsp;</td>
								</tr>
								<tr>
									<td width="500" height="95" style="border-width:1; border-color:rgb(204,204,204); border-top-style:none; border-right-style:solid; border-bottom-style:solid; border-left-style:solid;" colspan="3">
									<div id="myholder" align="center"></div>
									</td>
								</tr>
								<tr>
									<td width="500" height="13" colspan="2"></td>
								</tr>
								<tr>
									<td width="500" colspan="2">			
										<table align="center" border="0" width="500" class="hero-unit">
											<tr>
												<td width="125" height="23"></td>
												<td width="375" height="25" rowspan="2" colspan="2">
													<p align="center"><span style="font-size:14pt;">Discussion</span></p>
												</td>
											</tr>
											<tr>
												<td width="123" rowspan="2" height="64" class="hero-unit" style="border-width:1;">
													<div class="row show-grid">
														<div class="span3" style="width:90%;">
															<ul id="userlist" class="nav nav-list">
																<li id="0" class="active"><a onClick="setUser(0); removeActives(); $('#0').addClass('active'); highlightCircle(0);"><i class="icon-user"></i>Everyone</a></li>
															</ul>
														</div>
													</div>
												</td>
											</tr>
											<tr>
												<td width="417" height="62">
													<div class="control-group">  
														<div class="controls"> 
															<div id="chat_conversation" style="border: 1px solid black; background-color:white; text-align:left; width: 100%; height: 250px; overflow: auto;">
																<div>
																	Welcome to public chat of the experiment!..<br>
																</div>
															</div>
														</div>  
													</div> 
													<p>
														<i class="icon-pencil"></i>						
														<input onFocus="document.getElementById('chat_input').value='';" value="Type something here..." type="text" id="chat_input" style="width: 60%;" class="input-xlarge" id="input01">
														<button type="submit" class="btn btn-primary" id="chat_send_button" onClick="sendMessage();">
														<i class="icon-comment icon-white"></i> Send
														</button>
													</p>	
												</td>
												<td width="-3" height="62"></td>
											</tr>
										</table>
									</td>
								</tr>
							</table>
							<div id="chart_div"></div>
						</td>
					</tr>
				</table>
				
				<table id="step3" border="0" align="center" width="825" class="hero-unit">
					<tr>
						<td width="819" colspan="3" height="53"> Please make your final decision...</td>
					</tr>
					<tr>
						<td width="291">
							<p align="center"></p>
						</td>
						<td  align="left" width="221">
							<form id="rbForm">
								
							</form>
						</td>
						<td width="299">
							<p align="center"></p>
						</td>
					</tr>
					<tr>
						<td width="291" height="9">
							<p align="center"></p>
						</td>
						<td width="221" height="9">
							<p align="center"></p>
						</td>
						<td width="299" height="9">
							<p align="center
						</td>"></p>
					</tr>
					<tr>
						<td width="291" height="41">
							<p align="center"></p>
						</td>
						<td width="221" height="41">

							<p align="center"><button type="submit" class="btn btn-primary" onClick="submitDecision();">
							<i class="icon-ok icon-white"></i> Submit
						</button></p>
						</td>
						<td width="299" height="41">
							<p align="center"></p>
						</td>
					</tr>
					<tr>
						<td width="819" height="41" colspan="3">
							<table align="center" border="0">
								<tr>
									<td width="809">
										<table align="center" border="0" id="endgameresults">
											<tr>
												<td align="center" width="803">
													
												</td>
											</tr>
										</table>
									</td>
								</tr>
								<tr>
									<td width="809"><p id="submitStatus" align="center">&nbsp;</p></td>
								</tr>
							</table>
						</td>
					</tr>
				</table>
				
				<table id="endgamesurvey" border="0" width="598" align="center">
					<tr>
						<td width="106" height="554" rowspan="7">&nbsp;</td>
						<td width="364">
							<h3 align="center" id="surveytitle"></h3>
						</td>
						<td width="106" height="554" rowspan="7">&nbsp;</td>
					</tr>
					<tr>
						<td width="364" height="272">
							<p align="center" id=surveyimage></p>
						</td>
					</tr>
					<tr>
						<td width="364">&nbsp;</td>
					</tr>
					<tr>
						<td width="364" id="surveytext"></td>
					</tr>
					<tr>
						<td width="364">
							<p align="left">&nbsp;</p>
						</td>
					</tr>
					<tr>
						<td width="364">
							<p align="center" id="surveyoptions">
								<form id="rbFormSurv">
												
								</form>
								<button id="stbut" class="btn btn-large btn-block" onClick="displaySurveyQuestion(0); $('#stbut').hide();" type="button">Start Survey</button>
							</p>
						</td>
					</tr>
					<tr>
						<td width="364" height="112">&nbsp;</td>
					</tr>
					<tr>
						<td width="106" height="27">
						   <p align="center"><button id="prevsurveybut" type="submit" class="btn btn-primary" onClick="prevSurveyQuestion();">
							<i class="icon-arrow-left icon-white"></i> Previous
						</button></p>
						</td>
						<td width="364" height="27">&nbsp;</td>
						<td width="106" height="27">
							<p align="center"><button id="nextsurveybut" type="submit" class="btn btn-primary" onClick="nextSurveyQuestion();">
							<i class="icon-arrow-right icon-white"></i> Next
						</button></p>
						</td>
					</tr>
				</table>
				
			</div>
</table>

<script language="JavaScript" type="text/javascript">  

var privateOrder="";
var Step1Timer;
var Step2Timer;
var EndGameTimer;
var selectedUser=0;
var userMessage="";
var step3Options = new Array();
var endGameResultsCount=0;
var questions = new Array();
var title;
var introtext;
var intropic;
var strictness;
var currentQuestion=0;
var surveySelections=new Array();
var canvasWidth=500;
var canvasHeight=300;
var r = Raphael("myholder", canvasWidth, canvasHeight);
var circles = new Array();
var xVals = new Array();
var yVals = new Array();
var labels = r.set();

$("#step2").hide();
$("#step3").hide();
$('#endgamesurvey').hide();

function loadXMLDoc(dname)
{
	if (window.XMLHttpRequest)
	{
		xhttp=new XMLHttpRequest();
	}
	else
	{
		xhttp=new ActiveXObject("Microsoft.XMLHTTP");
	}
	xhttp.open("GET",dname,false);
	xhttp.send();
	return xhttp.responseXML;
}

function parseSurveyXML()
{
	xmlDoc=loadXMLDoc(getFile("surveytemplate.xml"));
	title = $.trim(xmlDoc.getElementsByTagName("title")[0].childNodes[0].nodeValue);
	introtext = $.trim(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("text")[0].childNodes[0].nodeValue);
	if(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=null&&xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=undefined)
		intropic = getFile($.trim(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0].childNodes[0].nodeValue));
	for(var i = 0; i < xmlDoc.getElementsByTagName("question").length; i++)
	{
		var question = new Array();
		question.push($.trim(xmlDoc.getElementsByTagName("question")[i].attributes.getNamedItem("type").nodeValue)); // question type

		var text, picture, video;
		var choices = new Array();
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("text").length>0)
			text = $.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("text")[0].childNodes[0].nodeValue);
		else
			text = "";
		question.push(text);
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("picture").length>0)
			picture = getFile($.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("picture")[0].childNodes[0].nodeValue));
		else
			picture = "";
		question.push(picture);
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("video").length>0)
			video = getFile($.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("video")[0].childNodes[0].nodeValue));
		else
			video = "";
		question.push(video);
		
		if(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("choice").length>0)
		{
			for(var j = 0; j < xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("choice").length; j++)
				choices.push($.trim(xmlDoc.getElementsByTagName("question")[i].getElementsByTagName("choice")[j].childNodes[0].nodeValue));
		}
		question.push(choices);
		questions.push(question);
	}
	strictness = $.trim(xmlDoc.getElementsByTagName("survey")[0].attributes.getNamedItem("strict").nodeValue);
	if(strictness==null)
		strictness = "false";
}

function nextSurveyQuestion()
{
	if(questions[currentQuestion][4].length>0&&questions[currentQuestion][0]=="likert-custom"||questions[currentQuestion][0]=="likert")
	{
		if(strictness=="true")
		{
			if($("input:radio[name='survrad']:checked").val()==undefined)
			{
				alert("Please select an option before proceeding!");
				return;
			}
		}
		surveySelections.push($("input:radio[name='survrad']:checked").val());
	}
	else if(questions[currentQuestion][4].length>0&&questions[currentQuestion][0]=="multiple")
	{
		if(strictness=="true")
		{
			if($("input:checkbox[name='survchck']:checked").val()==undefined)
			{
				alert("Please select an option before proceeding!");
				return;
			}
		}
		var allVals = [];
		$(':checkbox:checked').each(function() {
			allVals.push($(this).val());
		});
		var mytempstr="";
		for(var z=0; z<allVals.length; z++)
			mytempstr+=(allVals[z]+" ");
		surveySelections.push(mytempstr);
	}
	
	currentQuestion++;
	if(currentQuestion<questions.length)
		displaySurveyQuestion(currentQuestion);
	else
	{
		$("#prevsurveybut").hide();
		$("#nextsurveybut").hide();
		for(var z=0; z<surveySelections.length; z++)
		{
			if(surveySelections[z]!=null&&surveySelections[z]!=undefined)
			{
				submit(surveySelections[z]);
				setRound(4+z);
			}
		}
		$("#surveytitle").html('');
		$("#surveyimage").html('');
		$("#surveytext").html('');
		document.getElementById("rbFormSurv").innerHTML="";
		$("#surveytext").html("Thank you for completing the survey. Click <a href=\"/stop_test/\" onclick='stopPinging();'>HERE</a> to quit the experiment...");
	}
}

function prevSurveyQuestion()
{
	if(questions[currentQuestion][0]=="likert-custom"||questions[currentQuestion][0]=="likert")
		surveySelections[currentQuestion]=$("input:radio[name='survrad']:checked").val();
	if(questions[currentQuestion][0]=="multiple")
		surveySelections[currentQuestion]=$("input:checkbox[name='survchck']:checked").val();
	currentQuestion--;
	displaySurveyQuestion(currentQuestion);
}

function startSurvey()
{
	parseSurveyXML();
	$('#endgamesurvey').show();
	$("#prevsurveybut").hide();
	$("#nextsurveybut").hide();
	$("#rbFormSurv").hide();
	$("#surveytitle").html(title);
	if(xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=null&&xmlDoc.getElementsByTagName("introduction")[0].getElementsByTagName("picture")[0]!=undefined)
		$("#surveyimage").html("<img src=\""+intropic+"\" alt=\"intro picture\">");
	$("#surveytext").html(introtext);
}

function displaySurveyQuestion(qNum)
{
	$("#surveytitle").html('');
	$("#surveyimage").html('');
	$("#surveytext").html('');
	document.getElementById("rbFormSurv").innerHTML="";
	
	$("#surveytext").html(questions[qNum][1]);
	if(questions[qNum][2]!="")
		$("#surveyimage").html("<img src=\""+questions[qNum][2]+"\" alt=\"question picture\">");
	if(questions[qNum][3]!="")
		$("#surveyimage").html("<video width=\"320\" height=\"240\" controls><source src=\""+questions[qNum][3]+".mp4\" type=\"video/mp4\"><source src=\""+questions[qNum][3]+".ogg\" type=\"video/ogg\">Your browser does not support the video tag.</video>");	

	if(questions[qNum][0]=="likert")
	{
		$("#rbFormSurv").show();
		document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\"Disagree strongly\">Disagree strongly<br><input type=\"radio\" name=\"survrad\" value=\"Disagree moderately\">Disagree moderately<br><input type=\"radio\" name=\"survrad\" value=\"Disagree a little\">Disagree a little<br><input type=\"radio\" name=\"survrad\" value=\"Neither agree nor disagree\">Neither agree nor disagree<br><input type=\"radio\" name=\"survrad\" value=\"Agree a little\">Agree a little<br><input type=\"radio\" name=\"survrad\" value=\"Agree moderately\">Agree moderately<br><input type=\"radio\" name=\"survrad\" value=\"Agree strongly\">Agree strongly<br>");
	}
	if(questions[qNum][0]=="likert-custom")
	{
		$("#rbFormSurv").show();
		for(var k=0; k<questions[qNum][4].length; k++)
			document.getElementById("rbFormSurv").innerHTML+=("<input type=\"radio\" name=\"survrad\" value=\""+questions[qNum][4][k]+"\">"+questions[qNum][4][k]+"<br>");
	}
	if(questions[qNum][0]=="multiple")
	{
		$("#rbFormSurv").show();
		for(var k=0; k<questions[qNum][4].length; k++)
			document.getElementById("rbFormSurv").innerHTML+=("<input type=\"checkbox\" name=\"survchck\" value=\""+questions[qNum][4][k]+"\">"+questions[qNum][4][k]+"<br>");
	}
	
	if(qNum>0)
		$("#prevsurveybut").show();
	else
		$("#prevsurveybut").hide();
		
	if(qNum<questions.length)
		$("#nextsurveybut").show();
	else
		$("#nextsurveybut").hide();
}

function newMove(participant, index) {
  fetchMove(participant, currentRound, index, function(val) {
	if(currentRound==2)
	{
		step3Options[val][1]++;
		endGameResultsCount++;
		if(endGameResultsCount==numPlayers)
		{
			$("#endgameresults").show();

			var labels = new Array();
			var values = new Array();
			var distinctNonZero=0;
			for(var z=0; z<step3Options.length; z++)
			{
				labels.push("%%.%% - "+step3Options[z][0]);
				values.push(step3Options[z][1]);
				if(step3Options[z][1]>0)
					distinctNonZero++;
			}
			// handling graphael piechart zero valued slices bug
			if(distinctNonZero==1)
			{
				while(values.length>1)
				{
					if(values[0]==0)
					{
						values.splice(0, 1);
						labels.splice(0, 1);
					}
					if(values.length>1&&values[1]==0)
					{
						values.splice(1, 1);
						labels.splice(1, 1);
					}
				}
			}
			$("#chart_div").css({'width':'500px;'});
			$("#chart_div").css({'height':'400px;'});
			var r = Raphael("chart_div"),
            pie = r.piechart(320, 240, 100, values, { legend: labels, legendpos: "west"});

			r.text(320, 100, "End Game Results").attr({ font: "20px sans-serif" });
			pie.hover(function () {
				this.sector.stop();
				this.sector.scale(1.1, 1.1, this.cx, this.cy);

				if (this.label) {
					this.label[0].stop();
					this.label[0].attr({ r: 7.5 });
					this.label[1].attr({ "font-weight": 800 });
				}
			}, function () {
				this.sector.animate({ transform: 's1 1 ' + this.cx + ' ' + this.cy }, 500, "bounce");

				if (this.label) {
					this.label[0].animate({ r: 5 }, 500, "bounce");
					this.label[1].attr({ "font-weight": 400 });
				}
			});

			document.getElementById("submitStatus").innerHTML="<font color=\"blue\">You will now be redirected to end game survey...</font>";
			$("#pubinfo").css({ 'width': '500px'});
			$("#pbar").show();
			countDownEndGame();
			setRound(3);
		}
	}
	if(currentRound==1)
	{
		this.privateOrder=val;
		setPrivateInfo(myid);
		setRound(2);
	}
  });
}

function setPrivateInfo(myident)
{
	if(variables['randomPrivateInformation']==1)
	{
		var tarr=this.privateOrder.split("_");
		for(var p=0;p<tarr.length;p++)
		{
			if(p+1==myident)
			{
				var tarr2=tarr[p].split(",");
				for(var m=0;m<tarr2.length;m++)
				{
					document.getElementById("step1").innerHTML+="<div class=\"accordion-group\"><div id=\"collapse"+(m+1)+"\" class=\"accordion-body collapse in\" style=\"overflow:hidden;\"><div class=\"accordion-inner\" id=\"pi"+(m+1)+"\">Private information not loaded...</div></div></div>";
					var pi1="";
					var img1="";
					if($.trim(xmlDoc.getElementsByTagName("info")[parseInt(tarr2[m])].attributes.getNamedItem("type").nodeValue)=="private")
					{
						pi1=$.trim(xmlDoc.getElementsByTagName("info")[parseInt(tarr2[m])].childNodes[0].nodeValue);
						if(xmlDoc.getElementsByTagName("info")[parseInt(tarr2[m])].getElementsByTagName("picture")[0]!=undefined&&xmlDoc.getElementsByTagName("info")[parseInt(tarr2[m])].getElementsByTagName("picture")[0].childNodes[0]!=null)
							img1=$.trim(xmlDoc.getElementsByTagName("info")[parseInt(tarr2[m])].getElementsByTagName("picture")[0].childNodes[0].nodeValue);
					}
					if(document.getElementById("pi"+(m+1)) != undefined)
						$("#pi"+(m+1)).html("<pre>"+pi1+"</pre>");
						
					if(img1!="" && img1!=null && img1 != undefined)
						$("#pi"+(m+1)).html($("#pi"+(m+1)).html()+"<img src=\""+img1+"\" alt=\"private info picture\">");
				}
			}
		}
	}
	else
	{
		var infnum=1;
		for(var m=1;m<xmlDoc.getElementsByTagName("info").length;m++)
		{
			if(parseInt($.trim(xmlDoc.getElementsByTagName("info")[m].attributes.getNamedItem("participant").nodeValue))==myident)
			{
				if(xmlDoc.getElementsByTagName("info")[m].getElementsByTagName("picture")[0]!=null&&xmlDoc.getElementsByTagName("info")[m].getElementsByTagName("picture")[0]!=undefined)
					$("#step1").html($("#step1").html()+"<div class=\"accordion-group\"><div id=\"collapse"+(m)+"\" class=\"accordion-body collapse in\" style=\"overflow:hidden;\"><div class=\"accordion-inner\" id=\"pi"+(m)+"\"><pre>"+$.trim(xmlDoc.getElementsByTagName("info")[m].childNodes[0].nodeValue)+"</pre><img src=\""+getFile($.trim(xmlDoc.getElementsByTagName("info")[m].getElementsByTagName("picture")[0].childNodes[0].nodeValue))+"\" alt=\"private info picture\"></div></div></div>");
				else
					$("#step1").html($("#step1").html()+"<div class=\"accordion-group\"><div id=\"collapse"+(m)+"\" class=\"accordion-body collapse in\" style=\"overflow:hidden;\"><div class=\"accordion-inner\" id=\"pi"+(m)+"\"><pre>"+$.trim(xmlDoc.getElementsByTagName("info")[m].childNodes[0].nodeValue)+"</pre></div></div></div>");
				infnum++;
			}
		}
	}
	countDownStep1();
}

function parseScenarioXML()
{
	xmlDoc=loadXMLDoc(getFile("scenario"+variables['Scenario Number']+".xml"));
	var title = $.trim(xmlDoc.getElementsByTagName("title")[0].childNodes[0].nodeValue);
	document.getElementById("ttl").innerHTML=title;
	var publicInfo="";
	if($.trim(xmlDoc.getElementsByTagName("info")[0].attributes.getNamedItem("type").nodeValue)=="public")
		publicInfo=$.trim(xmlDoc.getElementsByTagName("info")[0].childNodes[0].nodeValue);
	if(xmlDoc.getElementsByTagName("info")[0].getElementsByTagName("picture")[0]!=null&&xmlDoc.getElementsByTagName("info")[0].getElementsByTagName("picture")[0]!=undefined)
		$("#desc").html("<pre>"+publicInfo+"</pre><img src=\""+getFile($.trim(xmlDoc.getElementsByTagName("info")[0].getElementsByTagName("picture")[0].childNodes[0].nodeValue))+"\" alt=\"private info picture\">");
	else
		$("#desc").html("<pre>"+publicInfo+"</pre>");
	for(var j=0; j<xmlDoc.getElementsByTagName("option").length; j++)
		step3Options.push([$.trim(xmlDoc.getElementsByTagName("option")[j].childNodes[0].nodeValue), 0]);
		
	setRound(1);

	if(variables['randomPrivateInformation']==1)
	{
		if(myid==1)
		{
			var numbers=new Array();
			for(var i=0; i<numPlayers; i++)
			{
				for(var j=0; j<(xmlDoc.getElementsByTagName("info").length-1)/numPlayers; j++)
				{
					var randomnumber=-1;
					do{
						randomnumber=Math.floor(Math.random()*(xmlDoc.getElementsByTagName("info").length-1))+1;
					}while(numbers[randomnumber]==true);
					numbers[randomnumber]=true;
					if(j<((xmlDoc.getElementsByTagName("info").length-1)/numPlayers)-1)
						this.privateOrder+=(randomnumber+",");
					else
						this.privateOrder+=(randomnumber+"_");
				}
			}
			submit(this.privateOrder);
		}
	}
	else
	{
		setPrivateInfo(myid);
		setRound(2);
	}
}

function loadStep2()
{
	$("#step1").hide();  
	$("#step3").hide();
	$("#step2").show();
	$("#pubinfo").css({ 'width': '500px'});
	drawNetwork();
	document.getElementById("stepgoal").innerHTML="Please discuss with other participants before making your decision at this step.";
	document.getElementById("timetext").innerHTML="You have "+variables['Step2Timer']+" seconds before proceeding at next step.";
	countDownStep2();
}

function loadStep3()
{
	$("#step1").hide();
	$("#step2").hide();  
	$("#pbar").hide();
	$("#step3").show();
	$("#pubinfo").css({ 'width': '750px'});
	$("#endgameresults").hide();
	document.getElementById("stepgoal").innerHTML="Please make your final decision at this step.";
	document.getElementById("timetext").innerHTML="";
	$("#timetext").hide(); 
}

function countDownEndGame(){  
	 if (this.EndGameTimer <=0){  
		$("#pbar").hide();
		$("#step3").hide();
		$("#pubinfo").hide();
		$("#helpinfo").hide();
		startSurvey();
	 }else{  
		this.EndGameTimer--;
		document.getElementById("timerbar").style.width=(this.EndGameTimer*100/parseInt(variables['EndGameTimer']+""))+"%";
		document.getElementById("timer").innerHTML = this.EndGameTimer;  
		setTimeout("countDownEndGame()", 1000);
	 }  
} 

function countDownStep2(){  
	 if (this.Step2Timer <=0){  
		loadStep3();
	 }else{  
		this.Step2Timer--;
		document.getElementById("timerbar").style.width=(this.Step2Timer*100/parseInt(variables['Step2Timer']+""))+"%";
		document.getElementById("timer").innerHTML = this.Step2Timer;  
		setTimeout("countDownStep2()", 1000);
	 }  
} 

function countDownStep1(){  
	 if (this.Step1Timer <=0){ 
		loadStep2();
	 }else{  
		this.Step1Timer--;
		document.getElementById("timerbar").style.width=(this.Step1Timer*100/parseInt(variables['Step1Timer']+""))+"%";
		document.getElementById("timer").innerHTML = this.Step1Timer; 
		setTimeout("countDownStep1()", 1000);
	 }  
} 

function submitDecision()
{
	if($("input:radio[name='findec']:checked").val()==undefined)
	{
		document.getElementById("submitStatus").innerHTML="<font color=\"red\">Please select one of the options!</font>";
	}
	else
	{
		submit($("input:radio[name='findec']:checked").val());
		document.getElementById("submitStatus").innerHTML="<font color=\"green\">Thank you! Your decision has been sent. Waiting for others to show end game result...</font>";
	}
}

function initialize()
{
	document.getElementById("timetext").innerHTML="You have "+variables['Step1Timer']+" seconds before proceeding at next step.";
	this.Step1Timer=parseInt(variables['Step1Timer']+"")+1; 
	this.Step2Timer=parseInt(variables['Step2Timer']+"")+1;
	this.EndGameTimer=parseInt(variables['EndGameTimer']+"")+1;
	
	parseScenarioXML();
	
	for(var g=1; g<=numPlayers; g++)
	{
		if(g==myid)
			document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a><i class=\"icon-user\"></i>You</a></li>");
		else
		{
			if(canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
				document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a onClick=\"setUser("+g+"); removeActives(); $('#"+g+"').addClass('active'); highlightCircle("+g+");\"><i class=\"icon-user\"></i>"+getName(g)+"</a></li>");
			else
				document.getElementById("userlist").innerHTML+=("<li id=\""+g+"\"><a><i class=\"icon-user\"></i>"+getName(g)+"</a></li>");
		}
	}
	
	for(var k=0; k<step3Options.length; k++)
		document.getElementById("rbForm").innerHTML+=("<input type=\"radio\" name=\"findec\" value=\""+k+"\">"+step3Options[k][0]+"<br>");
}

function drawNetwork()
{

	for(var g=1; g<=numPlayers; g++)
	{
		var circleY=-1;
		var circleX=-1;
		if(numPlayers==1)
		{
			circleY=canvasHeight/2;
			circleX=canvasWidth/2;
		}
		if(numPlayers==2)
		{
			circleY=canvasHeight/2;
			if(g==1)
				circleX=canvasWidth/3;
			if(g==2)
				circleX=2*canvasWidth/3;
		}
		if(numPlayers==3)
		{
			if(g>1)
			{
				circleY=2*canvasHeight/3;
				if(g==2)
					circleX=canvasWidth/3;
				if(g==3)
					circleX=2*canvasWidth/3;
			}
			else
			{
				circleX=canvasWidth/2;
				circleY=canvasHeight/3;
			}
		}
		if(numPlayers==4)
		{
			if(g>2)
			{
				circleY=2*canvasHeight/3;
				if(g==3)
					circleX=canvasWidth/3;
				if(g==4)
					circleX=2*canvasWidth/3;
			}
			else
			{
				circleY=canvasHeight/3;
				if(g==1)
					circleX=canvasWidth/3;
				if(g==2)
					circleX=2*canvasWidth/3;
			}
		}
		if(numPlayers==5)
		{
			if(g==3)
			{
				circleY=2*canvasHeight/4;
				if(g==3)
					circleX=canvasWidth/2;
			}
			else if(g<3)
			{
				circleY=canvasHeight/4;
				if(g==1)
					circleX=canvasWidth/3;
				if(g==2)
					circleX=2*canvasWidth/3;
			}
			else
			{
				circleY=3*canvasHeight/4;
				if(g==4)
					circleX=canvasWidth/3;
				if(g==5)
					circleX=2*canvasWidth/3;
			}
		}
		if(numPlayers==6)
		{
			if(g>3)
			{
				circleY=2*canvasHeight/3;
				if(g==4)
					circleX=canvasWidth/4;
				if(g==5)
					circleX=2*canvasWidth/4;
				if(g==6)
					circleX=3*canvasWidth/4;
			}
			else
			{
				circleY=canvasHeight/3;
				if(g==1)
					circleX=canvasWidth/4;
				if(g==2)
					circleX=2*canvasWidth/4;
				if(g==3)
					circleX=3*canvasWidth/4;
			}
		}
		if(numPlayers==7)
		{
			if(g==4)
			{
				circleY=2*canvasHeight/4;
				circleX=canvasWidth/2;
			}
			else if(g<4)
			{
				circleY=canvasHeight/4;
				if(g==1)
					circleX=canvasWidth/4;
				if(g==2)
					circleX=2*canvasWidth/4;
				if(g==3)
					circleX=3*canvasWidth/4;
			}
			else
			{
				circleY=3*canvasHeight/4;
				if(g==5)
					circleX=canvasWidth/4;
				if(g==6)
					circleX=2*canvasWidth/4;
				if(g==7)
					circleX=3*canvasWidth/4;
			}
		}
		if(numPlayers==8)
		{
			if(g==4||g==5)
			{
				circleY=2*canvasHeight/4;
				if(g==4)
					circleX=canvasWidth/4;
				if(g==5)
					circleX=3*canvasWidth/4;
			}
			else if(g<4)
			{
				circleY=canvasHeight/4;
				if(g==1)
					circleX=canvasWidth/4;
				if(g==2)
					circleX=2*canvasWidth/4;
				if(g==3)
					circleX=3*canvasWidth/4;
			}
			else
			{
				circleY=3*canvasHeight/4;
				if(g==1)
					circleX=canvasWidth/4;
				if(g==2)
					circleX=2*canvasWidth/4;
				if(g==3)
					circleX=3*canvasWidth/4;
			}
		}
		if(numPlayers==9)
		{
			if(g<4)
			{
				circleY=canvasHeight/4;
				if(g==1)
					circleX=canvasWidth/4;
				if(g==2)
					circleX=2*canvasWidth/4;
				if(g==3)
					circleX=3*canvasWidth/4;
			}
			else if(g>=4&&g<=6)
			{
				circleY=2*canvasHeight/4;
				if(g==4)
					circleX=canvasWidth/4;
				if(g==5)
					circleX=2*canvasWidth/4;
				if(g==6)
					circleX=3*canvasWidth/4;
			}
			else
			{
				circleY=3*canvasHeight/4;
				if(g==7)
					circleX=canvasWidth/4;
				if(g==8)
					circleX=2*canvasWidth/4;
				if(g==9)
					circleX=3*canvasWidth/4;
			}
		}
		var circle = new Object();
		circle=r.circle(circleX, circleY,25);
		if(g==myid||canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
			circle.attr("fill", "#0A4");
		else
			circle.attr("fill", "#00f");
		circle.attr("stroke", "#000");
		circles.push(circle);
		var emptyCircle=r.circle(circleX,circleY,32);
		xVals.push(circleX);
		yVals.push(circleY);
	}   

	circleClick();
	
	for(var h=0; h<circles.length-1; h++)
	{
		for(var i=h+1; i<circles.length; i++)
		{
			if(canCommunicate(h, i))
			{
				var path = new Object();
				path.line = r.path("M "+xVals[h]+" "+yVals[h]+" l "+(xVals[i]-xVals[h])+" "+(yVals[i]-yVals[h])+" z");
				path.line.attr({stroke: '#3b4449','stroke-width': 5});
				path.line.toBack();
			}
		}
	}
}

function canCommunicate(i, j)
{
	return (variables["communication"][i][j]!=null&&variables["communication"][i][j]!=undefined&&parseInt(variables["communication"][i][j])==1);
}

function circleClick(){
	labels = r.set();
	for(var g=1; g<=numPlayers; g++)
	{
		if(canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
		{
			if(g==1)
			circles[g-1].click(function() {
				highlightCircle(1);
				return;
			});
			if(g==2)
			circles[g-1].click(function() {
				highlightCircle(2);
				return;
			});
			if(g==3)
			circles[g-1].click(function() {
				highlightCircle(3);
				return;
			});
			if(g==4)
			circles[g-1].click(function() {
				highlightCircle(4);
				return;
			});
			if(g==5)
			circles[g-1].click(function() {
				highlightCircle(5);
				return;
			});
			if(g==6)
			circles[g-1].click(function() {
				highlightCircle(6);
				return;
			});
			if(g==7)
			circles[g-1].click(function() {
				highlightCircle(7);
				return;
			});
			if(g==8)
			circles[g-1].click(function() {
				highlightCircle(8);
				return;
			});
			if(g==9)
			circles[g-1].click(function() {
				highlightCircle(9);
				return;
			});
		}
		if(myid==g)
			labels.push(r.text(xVals[g-1]-9, yVals[g-1], "You"));
		else
			labels.push(r.text(xVals[g-1]-18.5, yVals[g-1], getName(g)+""));
		labels.attr({font: "12px Fontin-Sans, Arial", fill: "#fff", "text-anchor": "start"});
		
	}
}

function highlightCircle(gg)
{
	if(gg==0)
	{
		for(var g=1; g<=numPlayers; g++)
		{
			if(g==myid||canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
			{
				var circle = new Object();
				circle=r.circle(xVals[g-1], yVals[g-1], 25);
				circle.attr("fill", "#0A4");
				circle.attr("stroke", "#000");
				circles[g-1]=circle;
				circleClick();
			}
		}
		setUser(0); 
		removeActives();
		$('#0').addClass('active');
	}
	else
	{
		for(var ic=0; ic<numPlayers; ic++)
		{
			var circle = new Object();
			circle=r.circle(xVals[ic], yVals[ic], 25);
			circle.attr("fill", "#00f");
			circle.attr("stroke", "#000");
			circles[ic]=circle;
		}
		var circle = new Object();
		circle=r.circle(xVals[gg-1], yVals[gg-1], 25);
		circle.attr("fill", "#0A4");
		circle.attr("stroke", "#000");
		circles[gg-1]=circle;
		circleClick();
		setUser(gg); 
		removeActives();
		$('#'+gg).addClass('active');
	}
}

function setUser(nmb)
{
	selectedUser=nmb;
}

function removeActives()
{
	for(var g=0; g<=numPlayers; g++)
	{
		if ($("#"+g)!=null&&$("#"+g)!=undefined&&$("#"+g).is('.active'))
			$("#"+g).removeClass("active");
	}
}
  
 $("#chat_input").keypress(function(event) {
    if ( event.which == 13 ) {
		sendMessage();
        event.preventDefault();
    }
  });

function sendMessage()
{
	if(selectedUser==0)
	{
		for(var g=1; g<=numPlayers; g++)
		{
			if(canCommunicate(myid-1, g-1)||canCommunicate(g-1, myid-1))
			{
				var msgArr = new Array();
				msgArr.push(g);
				msgArr.push(myid);
				sendChat($("#chat_input").val(),msgArr);
				r.circle(xVals[g-1], yVals[g-1], 29);
			}
		}
		//sendChat($("#chat_input").val());
	}
	else
	{
		var msgArr = new Array();
		msgArr.push(selectedUser);
		msgArr.push(myid);
		sendChat($("#chat_input").val(),msgArr);
		r.circle(xVals[selectedUser-1], yVals[selectedUser-1], 29);
	}
	$("#chat_input").val('');
}	
</script> 

